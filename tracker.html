<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Site Tracker - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; }
        .field-input { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; font-size: 16px; }
        .field-input:focus { border-color: #3b82f6; }
        select.field-input { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.65em auto; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto min-h-screen flex flex-col">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white"><i class="fas fa-hard-hat text-yellow-400 mr-2"></i>Site Tracker</h1>
            <p class="text-xs text-slate-400">Field Activity Log</p>
        </div>
        <a href="index.html" class="bg-slate-700 px-3 py-2 rounded text-sm font-bold text-slate-300">Exit</a>
    </header>

    <div class="mb-6">
        <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Active Project</label>
        <select id="projectSelect" onchange="loadProjectItems()" class="field-input font-bold text-lg">
            <option value="">-- Select Site --</option>
        </select>
    </div>

    <div id="logForm" class="hidden flex-1 flex flex-col gap-4">
        
        <div>
            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Date</label>
            <input type="date" id="logDate" class="field-input">
        </div>

        <div>
            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Activity / Contract Item</label>
            <select id="itemSelect" class="field-input text-sm">
                <option value="">-- Select Activity --</option>
            </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Qty Completed</label>
                <input type="number" id="logQty" class="field-input text-center text-xl font-bold" placeholder="0">
            </div>
            <div>
                <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Unit</label>
                <input type="text" id="logUnit" class="field-input text-center text-slate-400" disabled value="...">
            </div>
        </div>

        <div>
            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Evidence / Reference</label>
            <textarea id="logNotes" rows="3" class="field-input text-sm" placeholder="e.g. Photo #124, QA Check passed..."></textarea>
        </div>

        <button onclick="saveLog()" class="mt-4 w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
            <i class="fas fa-check-circle"></i> Save Log
        </button>

        <div class="mt-8">
            <h3 class="text-xs font-bold text-slate-500 uppercase border-b border-slate-700 pb-2 mb-2">Recent Activity</h3>
            <div id="recentLogs" class="space-y-2 text-sm text-slate-300"></div>
        </div>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let activeProject = null;
        let projectItems = [];

        document.getElementById('logDate').valueAsDate = new Date();
        loadProjects();

        function loadProjects() {
            // Load Active projects only
            db.collection('projects').where('status', '==', 'Active').get().then(snapshot => {
                const select = document.getElementById('projectSelect');
                snapshot.forEach(doc => {
                    const p = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${p.name}</option>`;
                });
            });
        }

        function loadProjectItems() {
            const pid = document.getElementById('projectSelect').value;
            if(!pid) return;

            db.collection('projects').doc(pid).get().then(doc => {
                activeProject = doc.data();
                projectItems = activeProject.items || [];
                
                const itemSelect = document.getElementById('itemSelect');
                itemSelect.innerHTML = '<option value="">-- Select Activity --</option>';
                
                projectItems.forEach((item, idx) => {
                    itemSelect.innerHTML += `<option value="${idx}">${item.name}</option>`;
                });

                document.getElementById('logForm').classList.remove('hidden');
                loadLocalLogs(pid);
            });
        }

        document.getElementById('itemSelect').addEventListener('change', (e) => {
            const idx = e.target.value;
            if(idx !== "") {
                document.getElementById('logUnit').value = projectItems[idx].unit;
            }
        });

        function saveLog() {
            const pid = document.getElementById('projectSelect').value;
            const itemIdx = document.getElementById('itemSelect').value;
            const qty = document.getElementById('logQty').value;
            const notes = document.getElementById('logNotes').value;
            const date = document.getElementById('logDate').value;

            if(!pid || itemIdx === "" || !qty || !notes) return alert("All fields are required.");

            const logEntry = {
                projectId: pid,
                projectName: activeProject.name,
                itemIdx: parseInt(itemIdx),
                itemName: projectItems[itemIdx].name,
                unit: projectItems[itemIdx].unit,
                qty: parseFloat(qty),
                notes: notes,
                date: date,
                timestamp: Date.now()
            };

            db.collection('site_logs').add(logEntry).then(() => {
                alert("âœ… Record Saved!");
                document.getElementById('logQty').value = "";
                document.getElementById('logNotes').value = "";
                loadLocalLogs(pid);
            });
        }

        function loadLocalLogs(pid) {
            const container = document.getElementById('recentLogs');
            container.innerHTML = "<i>Loading...</i>";
            
            db.collection('site_logs')
              .where('projectId', '==', pid)
              .orderBy('timestamp', 'desc')
              .limit(5)
              .onSnapshot(snapshot => {
                  container.innerHTML = "";
                  if(snapshot.empty) container.innerHTML = "No logs yet.";
                  
                  snapshot.forEach(doc => {
                      const log = doc.data();
                      container.innerHTML += `
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="flex justify-between font-bold text-xs text-slate-400 mb-1">
                                <span>${log.date}</span>
                                <span class="text-white">${log.qty} ${log.unit}</span>
                            </div>
                            <div class="font-bold text-white mb-1">${log.itemName}</div>
                            <div class="text-xs text-blue-400 italic">${log.notes}</div>
                        </div>
                      `;
                  });
              });
        }
    </script>
</body>
</html>
