<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivilMate Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: { 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' } } }
            }
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <div id="loginModal" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl text-center">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">üèóÔ∏è CivilMate</h2>
            <p class="text-slate-500 mb-8">Select your role to enter</p>
            <button onclick="login('ENGINEER')" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold mb-4 hover:bg-blue-700 flex items-center justify-center gap-3">
                <i class="fas fa-hard-hat"></i> Site Engineer
            </button>
            <button onclick="login('MANAGER')" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold hover:bg-slate-900 flex items-center justify-center gap-3">
                <i class="fas fa-user-tie"></i> Project Manager
            </button>
        </div>
    </div>

    <div id="app" class="hidden max-w-5xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-bold text-slate-800"><i class="fas fa-hard-hat text-brand-500"></i> NZ Site Manager</h1>
                <p class="text-sm text-slate-500" id="roleDisplay">Role: ...</p>
            </div>
            <a href="index.html" class="text-slate-400 hover:text-slate-600 font-medium text-sm"><i class="fas fa-arrow-left"></i> Back to Menu</a>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-1 h-fit">
                <h2 class="font-bold text-lg mb-4 border-b pb-2">1. Add Activity (NZS)</h2>
                
                <select id="catSelect" class="w-full p-3 mb-3 border rounded bg-slate-50 text-sm" onchange="loadActivities()">
                    <option value="">-- Select Trade --</option>
                </select>
                
                <select id="actSelect" class="w-full p-3 mb-6 border rounded bg-slate-50 text-sm" disabled>
                    <option>-- Select Trade First --</option>
                </select>

                <button onclick="addItem()" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition shadow-md">
                    <i class="fas fa-plus"></i> Add to Tracker
                </button>

                <div class="mt-8 pt-6 border-t border-slate-100">
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="font-bold text-yellow-800 text-sm mb-2"><i class="fas fa-bolt"></i> Variation Order</h3>
                        <input id="customItem" type="text" placeholder="Describe variation..." class="w-full p-2 border border-yellow-200 rounded text-sm mb-2">
                        <button onclick="addVariation()" class="w-full bg-yellow-500 text-white py-2 rounded text-sm font-bold hover:bg-yellow-600">Request Approval</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-1 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">2. Live Progress</h2>
                    <span class="text-xs text-green-600 font-mono bg-green-50 px-2 py-1 rounded">‚óè Live Sync: Australia-SE1</span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-xs text-slate-400 uppercase border-b">
                                <th class="pb-3 pl-2">Activity</th>
                                <th class="pb-3">Status</th>
                                <th class="pb-3">Progress</th>
                                <th class="pb-3 text-center">Photo</th>
                                <th class="pb-3 text-right pr-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="5" class="text-center py-8 text-slate-400">Loading database...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN REAL DE TU PROYECTO 'CIVILMATE' ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk",
            authDomain: "civilmate-933db.firebaseapp.com",
            projectId: "civilmate-933db",
            storageBucket: "civilmate-933db.firebasestorage.app",
            messagingSenderId: "679829297548",
            appId: "1:679829297548:web:42f9a5217314b787ed9ea9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. DATOS NZ STANDARDS ---
        const standards = {
            "Earthworks": ["Site Clearing", "Cut to Waste", "Imported Hardfill", "Compaction"],
            "Concrete": ["Foundations", "Rebar Prep", "Boxing", "Pouring", "Curing"],
            "Drainage": ["Trenching", "Pipe Laying", "Backfilling", "Manholes"],
            "Roading": ["Sub-base", "Basecourse", "Kerb & Channel", "Asphalt"],
            "Landscaping": ["Topsoil", "Planting", "Fencing"]
        };

        let role = "";

        // --- 3. FUNCIONES ---
        function login(userRole) {
            role = userRole;
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('roleDisplay').innerText = `Role: ${userRole === 'MANAGER' ? 'Project Manager' : 'Site Engineer'}`;
            initListener();
        }

        // Cargar Dropdowns
        const catSelect = document.getElementById('catSelect');
        const actSelect = document.getElementById('actSelect');
        Object.keys(standards).forEach(k => catSelect.innerHTML += `<option value="${k}">${k}</option>`);

        window.loadActivities = () => {
            const cat = catSelect.value;
            actSelect.innerHTML = "";
            if(standards[cat]) {
                standards[cat].forEach(a => actSelect.innerHTML += `<option value="${a}">${a}</option>`);
                actSelect.disabled = false;
            } else {
                actSelect.disabled = true;
                actSelect.innerHTML = "<option>-- Select Trade First --</option>";
            }
        };

        // Escribir en Base de Datos
        window.addItem = () => {
            const cat = catSelect.value;
            const name = actSelect.value;
            if(!cat || !name) return alert("Select category and item");
            
            db.collection('activities').add({
                category: cat, name: name, status: 'Approved', progress: 0, photo: null, createdAt: Date.now()
            });
            alert("Item Added!");
        };

        window.addVariation = () => {
            const val = document.getElementById('customItem').value;
            if(!val) return;
            db.collection('activities').add({
                category: "Variation", name: val, status: 'Pending', progress: 0, photo: null, createdAt: Date.now()
            });
            document.getElementById('customItem').value = "";
            alert("Variation requested!");
        };

        // Leer Base de Datos (Tiempo Real)
        function initListener() {
            db.collection('activities').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = "";
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const id = doc.id;
                    
                    // L√≥gica Visual
                    let statusColor = d.status === 'Approved' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                    let isDisabled = (role === 'ENGINEER' && d.status === 'Pending') ? 'disabled' : '';
                    
                    // Botones Admin
                    let actions = "";
                    if(role === 'MANAGER') {
                        if(d.status === 'Pending') actions += `<button onclick="updateStatus('${id}', 'Approved')" class="text-green-600 font-bold mr-2 text-xs border p-1 rounded hover:bg-green-50">APPROVE</button>`;
                        actions += `<button onclick="deleteItem('${id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>`;
                    } else {
                        if(d.status === 'Pending') actions = `<span class="text-xs text-slate-400 italic">Waiting...</span>`;
                    }

                    // Foto
                    let photoHTML = d.photo 
                        ? `<img src="${d.photo}" class="w-10 h-10 rounded object-cover cursor-pointer border" onclick="window.open('${d.photo}')">`
                        : `<label class="cursor-pointer text-slate-300 hover:text-blue-500"><i class="fas fa-camera"></i><input type="file" class="hidden" accept="image/*" onchange="uploadPhoto('${id}', this)"></label>`;

                    tbody.innerHTML += `
                        <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                            <td class="py-3 pl-2">
                                <div class="font-bold text-slate-700 text-sm">${d.name}</div>
                                <div class="text-xs text-slate-400">${d.category}</div>
                            </td>
                            <td class="py-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${statusColor}">${d.status}</span></td>
                            <td class="py-3">
                                <div class="flex items-center gap-2">
                                    <input type="range" value="${d.progress}" class="w-20 accent-brand-600 cursor-pointer" 
                                        ${isDisabled} onchange="updateProg('${id}', this.value)">
                                    <span class="text-xs font-bold">${d.progress}%</span>
                                </div>
                            </td>
                            <td class="py-3 text-center">${photoHTML}</td>
                            <td class="py-3 text-right pr-2">${actions}</td>
                        </tr>
                    `;
                });
                
                if(snap.empty) tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-400 italic">No items yet. Add one!</td></tr>`;
            });
        }

        // Acciones DB
        window.updateStatus = (id, st) => db.collection('activities').doc(id).update({status: st});
        window.deleteItem = (id) => { if(confirm("Delete?")) db.collection('activities').doc(id).delete(); };
        window.updateProg = (id, val) => db.collection('activities').doc(id).update({progress: parseInt(val)});
        window.uploadPhoto = (id, input) => {
            if(input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => db.collection('activities').doc(id).update({photo: e.target.result});
                reader.readAsDataURL(input.files[0]);
            }
        };
    </script>
</body>
</html>
