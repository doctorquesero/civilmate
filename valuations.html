<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuations - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            #invoice, #invoice * { visibility: visible; }
            #invoice { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
            .no-print { display: none !important; }
            input { border: none; background: transparent; }
        }
    </style>
</head>
<body class="p-6 max-w-[1200px] mx-auto min-h-screen pb-20">

    <div class="flex justify-between items-center mb-6 no-print">
        <button onclick="window.location.href='project_hub.html'" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 font-bold transition">
            <i class="fas fa-arrow-left"></i> Back to Hub
        </button>
        <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black shadow-lg transition flex items-center gap-2">
            <i class="fas fa-print"></i> Print / PDF
        </button>
    </div>

    <div id="invoice" class="bg-white p-10 rounded-xl shadow-xl border border-slate-200 min-h-[1000px] relative">
        
        <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
            <div>
                <h1 class="text-4xl font-bold text-slate-800 tracking-tight uppercase">Payment Claim</h1>
                <p class="text-xs text-slate-500 font-bold mt-1">CCA 2002 COMPLIANT</p>
            </div>
            <div class="text-right">
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Claim No:</span> <span class="font-bold text-xl">1</span></div>
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Date:</span> <span class="font-bold" id="claimDate">...</span></div>
                <div><span class="font-bold text-slate-400 text-xs uppercase mr-2">Project:</span> <span class="font-bold text-blue-600" id="projName">Loading...</span></div>
            </div>
        </div>

        <div class="flex justify-end mb-8">
            <div class="w-1/3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Claim Summary</h3>
                
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-600">Gross Value (To Date)</span>
                    <span class="font-bold text-slate-800" id="sumGross">$0.00</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-red-400">Less: Retention (10%)</span>
                    <span class="font-bold text-red-400" id="sumRet">-$0.00</span>
                </div>
                
                <div class="border-t border-slate-300 my-2"></div>
                
                <div class="flex justify-between text-lg mb-1">
                    <span class="font-bold text-slate-800">Net Claim (Ex GST)</span>
                    <span class="font-bold text-slate-900" id="sumNet">$0.00</span>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mb-2">
                    <span>GST (15%)</span>
                    <span id="sumGst">$0.00</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-green-600 mt-2 pt-2 border-t border-slate-200">
                    <span>TOTAL PAYABLE</span>
                    <span id="sumTotal">$0.00</span>
                </div>
            </div>
        </div>

        <table class="w-full text-left mb-12">
            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] border-b border-slate-200">
                <tr>
                    <th class="py-3 pl-2">Description</th>
                    <th class="py-3 text-center">Unit</th>
                    <th class="py-3 text-center">Contr. Qty</th>
                    <th class="py-3 text-right">Rate</th>
                    <th class="py-3 text-center w-32 bg-yellow-50 border-x border-yellow-100 text-yellow-700">Total % Done</th>
                    <th class="py-3 text-right pr-2">Claim Value</th>
                </tr>
            </thead>
            <tbody id="linesTable" class="divide-y divide-slate-100 text-sm">
                <tr><td colspan="6" class="p-4 text-center text-slate-400 italic">Loading Schedule of Rates...</td></tr>
            </tbody>
        </table>

        <div class="mt-8 pt-8 border-t-2 border-slate-800">
            <h3 class="text-lg font-bold text-slate-700 uppercase mb-1">Appendix A: Traceability Record</h3>
            <p class="text-xs text-slate-400 mb-4">Site Daily Logs & Evidence supporting this claim</p>

            <table class="w-full text-left text-xs text-slate-600">
                <thead class="bg-slate-100 font-bold uppercase">
                    <tr>
                        <th class="p-2 w-24">Date</th>
                        <th class="p-2">Activity / Item</th>
                        <th class="p-2 text-right">Qty</th>
                        <th class="p-2">Reference / Notes</th>
                    </tr>
                </thead>
                <tbody id="logsTable" class="divide-y divide-slate-100">
                    <tr><td colspan="4" class="p-4 text-center italic text-slate-400">Fetching logs...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="mt-12 text-[10px] text-slate-400 text-center border-t border-slate-100 pt-4">
            <p>I certify that the work claimed herein has been completed in accordance with the contract.</p>
            <p class="mt-1 font-bold">Generated by CivilMate Construction Management System</p>
        </div>

    </div>

    <div class="fixed bottom-6 right-6 no-print">
        <button onclick="window.print()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-xl flex items-center gap-2 transform transition hover:scale-105">
            <i class="fas fa-check-circle"></i> Approve & Generate PDF
        </button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pid = localStorage.getItem('civilmate_current_project_id');
        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }

        let scheduleData = [];

        // INICIAR
        init();

        function init() {
            document.getElementById('claimDate').innerText = new Date().toLocaleDateString('en-NZ');
            
            // 1. CARGAR PROYECTO Y TABLA
            db.collection('projects').doc(pid).get().then(doc => {
                if(doc.exists) {
                    const p = doc.data();
                    document.getElementById('projName').innerText = p.name;
                    
                    // Renderizar tabla basada en el contrato (NO MANUAL)
                    const tbody = document.getElementById('linesTable');
                    tbody.innerHTML = "";
                    
                    if(p.schedule && p.schedule.length > 0) {
                        scheduleData = p.schedule;
                        scheduleData.forEach((item, index) => {
                            tbody.innerHTML += `
                                <tr class="hover:bg-slate-50">
                                    <td class="py-3 pl-2 font-bold text-slate-700">${item.desc}</td>
                                    <td class="py-3 text-center text-slate-500">${item.unit}</td>
                                    <td class="py-3 text-center">${item.qty}</td>
                                    <td class="py-3 text-right font-mono">$${item.rate}</td>
                                    <td class="py-3 text-center bg-yellow-50 border-x border-yellow-100">
                                        <input type="number" min="0" max="100" value="0" 
                                            onchange="calcRow(this, ${item.qty}, ${item.rate})"
                                            class="w-16 text-center font-bold text-slate-800 border-b border-slate-300 focus:border-blue-500 outline-none bg-transparent"> %
                                    </td>
                                    <td class="py-3 text-right pr-2 font-bold font-mono text-slate-800 row-total">$0.00</td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-400">No Schedule of Rates found in contract.</td></tr>`;
                    }
                }
            });

            // 2. CARGAR LOGS (SIN INDEX ERROR)
            loadLogs();
        }

        function loadLogs() {
            const tbody = document.getElementById('logsTable');
            
            // FIX: No usamos orderBy en la query
            db.collection('site_logs').where('projectId', '==', pid).limit(50).get().then(snap => {
                tbody.innerHTML = "";
                if(snap.empty) { tbody.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-slate-400'>No daily logs found.</td></tr>"; return; }

                let logs = [];
                snap.forEach(d => logs.push(d.data()));
                
                // Ordenar en JS
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                logs.forEach(log => {
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-50 last:border-0">
                            <td class="p-2 font-bold text-slate-700">${log.date}</td>
                            <td class="p-2">${log.itemName}</td>
                            <td class="p-2 text-right font-mono">${log.qty} ${log.unit}</td>
                            <td class="p-2 italic text-slate-400">${log.notes || '-'}</td>
                        </tr>
                    `;
                });
            });
        }

        // CALCULO EN TIEMPO REAL
        function calcRow(input, qty, rate) {
            const percent = parseFloat(input.value) || 0;
            const rowTotal = (qty * rate) * (percent / 100);
            
            // Actualizar celda de valor
            const row = input.closest('tr');
            row.querySelector('.row-total').innerText = fmtMoney(rowTotal);
            
            recalcTotal();
        }

        function recalcTotal() {
            let totalGross = 0;
            document.querySelectorAll('.row-total').forEach(cell => {
                const val = parseFloat(cell.innerText.replace('$','').replace(',','')) || 0;
                totalGross += val;
            });

            const retention = totalGross * 0.10; // 10% Retenci√≥n
            const net = totalGross - retention;
            const gst = net * 0.15;
            const total = net + gst;

            document.getElementById('sumGross').innerText = fmtMoney(totalGross);
            document.getElementById('sumRet').innerText = "-" + fmtMoney(retention);
            document.getElementById('sumNet').innerText = fmtMoney(net);
            document.getElementById('sumGst').innerText = fmtMoney(gst);
            document.getElementById('sumTotal').innerText = fmtMoney(total);
        }

        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    </script>
</body>
</html>
