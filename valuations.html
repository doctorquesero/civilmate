<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Smart Valuations V4.0 - CivilMate</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>

        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }

        .locked-input { background-color: transparent; color: #334155; border: none; pointer-events: none; font-weight: bold; text-align: center; width: 100%; }

        .percent-input { background-color: #fef9c3; border: 1px solid #fde047; color: #854d0e; font-weight: bold; text-align: center; border-radius: 4px; }

        .percent-input:focus { outline: 2px solid #ca8a04; background-color: #fff; }

        

        canvas { background-color: white; cursor: crosshair; width: 100%; height: 80px; touch-action: none; border: 1px dashed #cbd5e1; }

        

        @media print {

            body * { visibility: hidden; }

            #invoice, #invoice * { visibility: visible; }

            #invoice { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }

            .no-print { display: none !important; }

            .percent-input { border: none !important; background: transparent !important; }

            input { border: none !important; background: transparent !important; }

        }

    </style>

</head>

<body class="p-6 max-w-[1400px] mx-auto min-h-screen pb-20">



    <div class="flex justify-between items-center mb-6 no-print">

        <button onclick="window.location.href='project_hub.html'" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 font-bold transition">

            <i class="fas fa-arrow-left"></i> Back to Hub

        </button>

        

        <div class="flex gap-2 items-center">

            <div id="statusBadge" class="px-4 py-2 rounded-lg text-xs font-bold uppercase hidden"></div>

            <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black shadow-lg transition flex items-center gap-2">

                <i class="fas fa-print"></i> Print / PDF

            </button>

        </div>

    </div>



    <div id="invoice" class="bg-white p-10 rounded-xl shadow-xl border border-slate-200 min-h-[1000px] relative">

        

        <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">

            <div>

                <h1 class="text-4xl font-bold text-slate-800 tracking-tight uppercase">Payment Claim</h1>

                <p class="text-xs text-slate-500 font-bold mt-1">CONSTRUCTION CONTRACTS ACT 2002</p>

            </div>

            <div class="text-right">

                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Claim No:</span> <span class="font-bold text-xl" id="claimNum">...</span></div>

                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Date:</span> <span class="font-bold" id="claimDate">...</span></div>

                <div><span class="font-bold text-slate-400 text-xs uppercase mr-2">Project:</span> <span class="font-bold text-blue-600" id="projName">Loading...</span></div>

            </div>

        </div>



        <div class="flex justify-end mb-8">

            <div class="w-1/3 bg-slate-50 p-4 rounded-lg border border-slate-200">

                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Claim Summary</h3>

                

                <div class="flex justify-between text-sm mb-2">

                    <span class="text-slate-600">Total Work Done (This Claim)</span>

                    <span class="font-bold text-slate-800" id="sumGross">$0.00</span>

                </div>

                <div class="flex justify-between text-sm mb-2">

                    <span class="text-red-400">Less: Retention (10%)</span>

                    <span class="font-bold text-red-400" id="sumRet">-$0.00</span>

                </div>

                <div class="flex justify-between text-sm mb-2 items-center">

                    <span class="text-amber-600">Less: Advance / Prior Ded.</span>

                    <div class="flex items-center">

                        <span class="text-amber-600 mr-1">-$</span>

                        <input type="number" id="advanceInput" value="0" onchange="recalcTotal()" class="w-20 text-right font-bold text-amber-600 bg-transparent border-b border-amber-200 outline-none focus:border-amber-500">

                    </div>

                </div>

                

                <div class="border-t border-slate-300 my-2"></div>

                

                <div class="flex justify-between text-lg mb-1">

                    <span class="font-bold text-slate-800">Net Claim Amount</span>

                    <span class="font-bold text-slate-900" id="sumNet">$0.00</span>

                </div>

                <div class="flex justify-between text-xs text-slate-400 mb-2">

                    <span>GST (15%)</span>

                    <span id="sumGst">$0.00</span>

                </div>

                <div class="flex justify-between text-xl font-bold text-green-600 mt-2 pt-2 border-t border-slate-200">

                    <span>TOTAL PAYABLE (Incl GST)</span>

                    <span id="sumTotal">$0.00</span>

                </div>

            </div>

        </div>



        <table class="w-full text-left mb-12 border-collapse">

            <thead class="bg-slate-100 text-slate-600 font-bold uppercase text-[9px] border-b border-slate-300">

                <tr>

                    <th class="py-3 pl-2 w-1/4">Item Description</th>

                    <th class="py-3 text-center">Unit</th>

                    <th class="py-3 text-center">Contract Qty</th>

                    <th class="py-3 text-right">Rate</th>

                    <th class="py-3 text-right pr-4 border-r border-slate-200">Total Contract</th>

                    

                    <th class="py-3 text-center w-20 bg-yellow-50 text-yellow-800 border-l border-yellow-200">% Done</th>

                    <th class="py-3 text-center w-24">Qty Done</th>

                    <th class="py-3 text-right pr-2">Current Value</th>

                </tr>

            </thead>

            <tbody id="linesTable" class="divide-y divide-slate-100 text-sm">

                <tr><td colspan="8" class="p-4 text-center text-slate-400 italic">Loading Approved Schedule...</td></tr>

            </tbody>

        </table>



        <div class="mt-8 pt-8 border-t-2 border-slate-800">

            <h3 class="text-lg font-bold text-slate-700 uppercase mb-1">Appendix A: Site Record</h3>

            <p class="text-xs text-slate-400 mb-4">Supporting evidence from daily logs.</p>

            <table class="w-full text-left text-xs text-slate-600">

                <thead class="bg-slate-100 font-bold uppercase">

                    <tr>

                        <th class="p-2 w-24">Date</th>

                        <th class="p-2">Activity</th>

                        <th class="p-2 text-right">Logged Qty</th>

                        <th class="p-2">Note</th>

                    </tr>

                </thead>

                <tbody id="logsTable" class="divide-y divide-slate-100"></tbody>

            </table>

        </div>



        <div class="mt-12 pt-6 border-t-2 border-slate-800 avoid-break">

            <div class="grid grid-cols-2 gap-12 mb-8">

                <div>

                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Claimed By (Contractor):</p>

                    <div class="relative border border-slate-300 rounded mb-1 bg-white h-24 overflow-hidden">

                        <canvas id="sigContractor"></canvas>

                        <img id="imgContractor" class="absolute inset-0 w-full h-full object-contain hidden">

                        <button id="btnClearContractor" onclick="clearSig('sigContractor')" class="absolute top-1 right-1 text-[9px] bg-slate-200 px-2 rounded no-print">Clear</button>

                    </div>

                    <p class="text-xs font-bold text-slate-700">Authorized Signature</p>

                    <p class="text-[10px] text-slate-400">Date: <span id="signDate"></span></p>

                </div>



                <div>

                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Certified By (Engineer):</p>

                    <div class="relative border border-slate-300 rounded mb-1 bg-white h-24 overflow-hidden">

                        <canvas id="sigEngineer"></canvas>

                        <img id="imgEngineer" class="absolute inset-0 w-full h-full object-contain hidden">

                        <button id="btnClearEngineer" onclick="clearSig('sigEngineer')" class="absolute top-1 right-1 text-[9px] bg-slate-200 px-2 rounded no-print">Clear</button>

                    </div>

                    <p class="text-xs font-bold text-slate-700">Payment Schedule Issued</p>

                    <p class="text-[10px] text-slate-400">Certified Date: _________</p>

                </div>

            </div>

            

            <div class="bg-slate-50 p-4 rounded text-[9px] text-slate-500 text-justify leading-relaxed border border-slate-200">

                <p class="font-bold mb-1">PAYMENT CLAIM NOTICE:</p>

                <p>This is a valid payment claim under the <strong>Construction Contracts Act 2002</strong>. The principal must provide a Payment Schedule within 20 working days of service. If no schedule is provided, the full claimed amount becomes due and enforceable as a debt.</p>

            </div>

        </div>



    </div>



    <div class="fixed bottom-6 right-6 no-print flex gap-4">

        <div id="draftControls" class="flex gap-4">

            <button onclick="saveDraft()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition">

                <i class="fas fa-save"></i> Save Draft

            </button>

            <button onclick="approveAndLock()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-xl flex items-center gap-2 transform transition hover:scale-105">

                <i class="fas fa-check-circle"></i> SIGN & SUBMIT

            </button>

        </div>

        <div id="lockedControls" class="hidden">

            <div class="bg-red-100 text-red-700 px-6 py-3 rounded-full font-bold border border-red-200 flex items-center gap-2 shadow-lg">

                <i class="fas fa-lock"></i> HISTORICAL RECORD (LOCKED)

            </div>

        </div>

    </div>



    <script>

        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };

        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();



        const pid = localStorage.getItem('civilmate_current_project_id');

        const viewClaimId = localStorage.getItem('civilmate_current_claim_id'); // If viewing history



        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }



        let scheduleData = [];

        let executionMap = {};

        let nextClaimNum = 1;



        init();



        async function init() {

            document.getElementById('claimDate').innerText = new Date().toLocaleDateString('en-NZ');

            document.getElementById('signDate').innerText = new Date().toLocaleDateString('en-NZ');

            

            initCanvas('sigContractor');

            initCanvas('sigEngineer');



            if(viewClaimId) {

                // VIEW HISTORY MODE

                loadHistoricalClaim(viewClaimId);

            } else {

                // NEW CLAIM MODE

                await getNextClaimNumber();

                await analyzeLogs(); // Get site quantities hint

                loadContractSchedule(); // Load locked items

            }

        }



        async function getNextClaimNumber() {

            const snap = await db.collection('claims').where('projectId', '==', pid).orderBy('claimNumber', 'desc').limit(1).get();

            if(!snap.empty) nextClaimNum = snap.docs[0].data().claimNumber + 1;

            document.getElementById('claimNum').innerText = nextClaimNum;

        }



        // --- CANVAS LOGIC ---

        function initCanvas(id) {

            const canvas = document.getElementById(id);

            const ctx = canvas.getContext("2d");

            let isDrawing = false;

            function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; ctx.lineWidth = 2; ctx.strokeStyle = "#000"; }

            setTimeout(resize, 200);

            const start = (e) => { if(e.type==='touchstart')e.preventDefault(); isDrawing=true; ctx.beginPath(); const p=pos(e); ctx.moveTo(p.x,p.y); };

            const move = (e) => { if(e.type==='touchmove')e.preventDefault(); if(!isDrawing)return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); };

            const end = (e) => { if(e.type==='touchend')e.preventDefault(); isDrawing=false; };

            const pos = (e) => { const r=canvas.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}; };

            canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start, {passive:false});

            canvas.addEventListener('mousemove', move); canvas.addEventListener('touchmove', move, {passive:false});

            canvas.addEventListener('mouseup', end); canvas.addEventListener('touchend', end);

        }

        window.clearSig = (id) => { const c=document.getElementById(id); c.getContext('2d').clearRect(0,0,c.width,c.height); }

        function isBlank(id) { const c=document.getElementById(id); return c.toDataURL() === document.createElement('canvas').toDataURL(); }



        // --- LOAD DATA ---

        function analyzeLogs() {

            return db.collection('site_logs').where('projectId', '==', pid).get().then(snap => {

                const logBody = document.getElementById('logsTable');

                logBody.innerHTML = "";

                snap.forEach(d => {

                    const log = d.data();

                    // Just helper for display, actual claim is entered manually in %

                    logBody.innerHTML += `<tr class="border-b border-slate-50"><td class="p-2 font-bold">${log.date}</td><td class="p-2">${log.itemName}</td><td class="p-2 text-right">${log.qty} ${log.unit}</td><td class="p-2 italic">${log.notes||'-'}</td></tr>`;

                });

            });

        }



        function loadContractSchedule() {

            db.collection('projects').doc(pid).get().then(doc => {

                if(doc.exists) {

                    const p = doc.data();

                    document.getElementById('projName').innerText = p.name;

                    // Use 'schedule' which is the finalized list

                    scheduleData = p.schedule || p.items || [];

                    renderTable(false); // False = Editable Percentages

                }

            });

        }



        // --- RENDER SCHEDULE (LOCKED EXCEPT %) ---

        function renderTable(isReadOnly, savedItems) {

            const tbody = document.getElementById('linesTable');

            tbody.innerHTML = "";

            const items = savedItems || scheduleData;



            if(items.length > 0) {

                items.forEach((item, index) => {

                    let contractTotal = item.qty * item.rate;

                    let executedQty = 0;

                    let percent = 0;

                    let claimVal = 0;



                    if(isReadOnly) {

                        // History: Read stored values

                        executedQty = item.executedQty;

                        percent = item.percent;

                        claimVal = item.claimValue;

                    } else {

                        // New: Default 0%, user will input

                        // Try to auto-suggest based on site logs? (Optional, skipping for clean manual input)

                    }



                    const inputClass = isReadOnly ? "locked-input" : "percent-input";

                    const readOnlyAttr = isReadOnly ? "readonly" : "";



                    tbody.innerHTML += `

                        <tr class="hover:bg-slate-50 transition item-row" 

                            data-desc="${item.desc||item.name}" data-unit="${item.unit}" 

                            data-qty="${item.qty}" data-rate="${item.rate}">

                            

                            <td class="py-3 pl-2 font-bold text-slate-700">${item.desc || item.name}</td>

                            <td class="py-3 text-center text-slate-500">${item.unit}</td>

                            <td class="py-3 text-center font-mono locked-input">${item.qty}</td>

                            <td class="py-3 text-right font-mono locked-input">$${item.rate.toLocaleString()}</td>

                            <td class="py-3 text-right pr-4 font-mono text-slate-400 border-r border-slate-100">$${contractTotal.toLocaleString()}</td>

                            

                            <td class="py-3 text-center bg-yellow-50 border-l border-yellow-100">

                                <input type="number" min="0" max="100" step="1" value="${percent}" ${readOnlyAttr}

                                    onchange="calcRow(this, ${item.qty}, ${item.rate})"

                                    class="w-16 p-1 text-sm ${inputClass}"> %

                            </td>

                            <td class="py-3 text-center font-bold text-blue-600 qty-done">${executedQty}</td>

                            <td class="py-3 text-right pr-2 font-bold font-mono text-slate-900 row-total">$${claimVal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>

                        </tr>

                    `;

                });

                recalcTotal();

            }

        }



        // --- MATH ENGINE ---

        function calcRow(input, totalQty, rate) {

            let percent = parseFloat(input.value) || 0;

            if(percent > 100) { percent = 100; input.value = 100; alert("Cannot claim > 100%"); }

            

            const qtyDone = totalQty * (percent / 100);

            const valDone = qtyDone * rate;



            const row = input.closest('tr');

            row.querySelector('.qty-done').innerText = parseFloat(qtyDone.toFixed(2));

            row.querySelector('.row-total').innerText = fmtMoney(valDone);

            

            recalcTotal();

        }



        function recalcTotal() {

            let totalGross = 0;

            document.querySelectorAll('.row-total').forEach(cell => {

                totalGross += parseFloat(cell.innerText.replace(/[$,]/g,'')) || 0;

            });



            const retention = totalGross * 0.10; // 10% Retention

            const advance = parseFloat(document.getElementById('advanceInput').value) || 0;

            

            const net = totalGross - retention - advance;

            const gst = net * 0.15;

            const total = net + gst;



            document.getElementById('sumGross').innerText = fmtMoney(totalGross);

            document.getElementById('sumRet').innerText = "-" + fmtMoney(retention);

            document.getElementById('sumNet').innerText = fmtMoney(net);

            document.getElementById('sumGst').innerText = fmtMoney(gst);

            document.getElementById('sumTotal').innerText = fmtMoney(total);

        }



        // --- SUBMIT LOGIC ---

        function approveAndLock() {

            if(isBlank('sigContractor')) return alert("Please sign the claim.");

            if(!confirm("Submit Payment Claim #" + nextClaimNum + "?")) return;



            const itemsSnapshot = [];

            document.querySelectorAll('.item-row').forEach(row => {

                itemsSnapshot.push({

                    desc: row.dataset.desc,

                    unit: row.dataset.unit,

                    qty: parseFloat(row.dataset.qty),

                    rate: parseFloat(row.dataset.rate),

                    executedQty: parseFloat(row.querySelector('.qty-done').innerText),

                    percent: parseFloat(row.querySelector('input').value),

                    claimValue: parseFloat(row.querySelector('.row-total').innerText.replace(/[$,]/g,''))

                });

            });



            const claimData = {

                projectId: pid,

                claimNumber: nextClaimNum,

                date: Date.now(),

                grossTotal: parseFloat(document.getElementById('sumGross').innerText.replace(/[$,]/g,'')),

                netPayable: parseFloat(document.getElementById('sumTotal').innerText.replace(/[$,]/g,'')),

                advanceRepayment: parseFloat(document.getElementById('advanceInput').value),

                signatures: { contractor: document.getElementById('sigContractor').toDataURL() },

                items: itemsSnapshot

            };



            const batch = db.batch();

            const claimRef = db.collection('claims').doc();

            batch.set(claimRef, claimData);

            batch.update(db.collection('projects').doc(pid), { 

                totalClaimed: claimData.grossTotal, 

                lastClaimDate: Date.now() 

            });



            batch.commit().then(() => {

                alert("Claim Submitted Successfully! âœ…");

                lockUI(true);

                window.print();

                window.location.href = 'project_hub.html';

            });

        }



        function loadHistoricalClaim(id) {

            lockUI(true);

            db.collection('claims').doc(id).get().then(doc => {

                const c = doc.data();

                document.getElementById('claimNum').innerText = c.claimNumber;

                document.getElementById('claimDate').innerText = new Date(c.date).toLocaleDateString('en-NZ');

                document.getElementById('sumGross').innerText = fmtMoney(c.grossTotal);

                document.getElementById('sumTotal').innerText = fmtMoney(c.netPayable);

                document.getElementById('advanceInput').value = c.advanceRepayment;

                

                // Load Images

                if(c.signatures) {

                    const img = document.getElementById('imgContractor');

                    img.src = c.signatures.contractor;

                    img.classList.remove('hidden');

                    document.getElementById('sigContractor').classList.add('hidden');

                }



                // Render Snapshot

                db.collection('projects').doc(pid).get().then(p => {

                    document.getElementById('projName').innerText = p.data().name;

                    renderTable(true, c.items);

                });

            });

        }



        function lockUI(locked) {

            if(locked) {

                document.querySelectorAll('input').forEach(i => i.classList.add('locked-input'));

                document.getElementById('draftControls').classList.add('hidden');

                document.getElementById('lockedControls').classList.remove('hidden');

                document.getElementById('statusBadge').classList.remove('hidden');

                document.getElementById('statusBadge').innerText = "SUBMITTED RECORD";

                document.getElementById('statusBadge').className = "px-4 py-2 rounded-lg text-xs font-bold uppercase bg-green-100 text-green-700 border border-green-200";

            }

        }



        function saveDraft() { alert("Draft logic here (Local Storage)"); }

        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

    </script>

</body>
