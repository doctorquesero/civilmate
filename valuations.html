<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Valuations - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .locked-input { background-color: #f1f5f9; color: #64748b; border: none; pointer-events: none; }
        canvas { background-color: white; cursor: crosshair; width: 100%; height: 80px; } /* Ajuste de altura para firmas */
        
        @media print {
            body * { visibility: hidden; }
            #invoice, #invoice * { visibility: visible; }
            #invoice { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
            .no-print { display: none !important; }
            input { border: none; background: transparent; }
            input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            input[type=number] { -moz-appearance: textfield; }
            .bg-yellow-50 { background-color: transparent !important; border: none !important; }
            canvas { border: 1px solid #ccc; } /* Borde visible al imprimir */
        }
    </style>
</head>
<body class="p-6 max-w-[1400px] mx-auto min-h-screen pb-20">

    <div class="flex justify-between items-center mb-6 no-print">
        <button onclick="window.location.href='project_hub.html'" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 font-bold transition">
            <i class="fas fa-arrow-left"></i> Back to Hub
        </button>
        
        <div class="flex gap-2 items-center">
            <div id="statusBadge" class="px-4 py-2 rounded-lg text-xs font-bold uppercase hidden"></div>
            <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i> Print / PDF
            </button>
        </div>
    </div>

    <div id="invoice" class="bg-white p-10 rounded-xl shadow-xl border border-slate-200 min-h-[1000px] relative">
        
        <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
            <div>
                <h1 class="text-4xl font-bold text-slate-800 tracking-tight uppercase">Payment Claim</h1>
                <p class="text-xs text-slate-500 font-bold mt-1">CCA 2002 COMPLIANT</p>
            </div>
            <div class="text-right">
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Claim No:</span> <span class="font-bold text-xl">1</span></div>
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Date:</span> <span class="font-bold" id="claimDate">...</span></div>
                <div><span class="font-bold text-slate-400 text-xs uppercase mr-2">Project:</span> <span class="font-bold text-blue-600" id="projName">Loading...</span></div>
            </div>
        </div>

        <div class="flex justify-end mb-8">
            <div class="w-1/3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Claim Summary</h3>
                
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-600">Gross Value (To Date)</span>
                    <span class="font-bold text-slate-800" id="sumGross">$0.00</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-red-400">Less: Retention (10%)</span>
                    <span class="font-bold text-red-400" id="sumRet">-$0.00</span>
                </div>
                <div class="flex justify-between text-sm mb-2 items-center">
                    <span class="text-amber-600">Less: Advance Repayment</span>
                    <div class="flex items-center">
                        <span class="text-amber-600 mr-1">-$</span>
                        <input type="number" id="advanceInput" value="0" onchange="recalcTotal()" class="w-20 text-right font-bold text-amber-600 bg-transparent border-b border-amber-200 outline-none focus:border-amber-500">
                    </div>
                </div>
                
                <div class="border-t border-slate-300 my-2"></div>
                
                <div class="flex justify-between text-lg mb-1">
                    <span class="font-bold text-slate-800">Net Claim (Ex GST)</span>
                    <span class="font-bold text-slate-900" id="sumNet">$0.00</span>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mb-2">
                    <span>GST (15%)</span>
                    <span id="sumGst">$0.00</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-green-600 mt-2 pt-2 border-t border-slate-200">
                    <span>TOTAL PAYABLE</span>
                    <span id="sumTotal">$0.00</span>
                </div>
            </div>
        </div>

        <table class="w-full text-left mb-12 border-collapse">
            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[9px] border-b border-slate-200">
                <tr>
                    <th class="py-3 pl-2 w-1/4">Description</th>
                    <th class="py-3 text-center">Unit</th>
                    <th class="py-3 text-center">Contract Qty</th>
                    <th class="py-3 text-right">Rate</th>
                    
                    <th class="py-3 text-center bg-slate-100 text-slate-600 border-x border-white">Balance to Complete</th>
                    
                    <th class="py-3 text-center w-24">Tracker Qty</th>
                    <th class="py-3 text-center w-24 bg-yellow-50 border-x border-yellow-100 text-yellow-700">Total % Done</th>
                    <th class="py-3 text-right pr-2">Claim Value</th>
                </tr>
            </thead>
            <tbody id="linesTable" class="divide-y divide-slate-100 text-sm">
                <tr><td colspan="8" class="p-4 text-center text-slate-400 italic">Analyzing Site Logs & Contract...</td></tr>
            </tbody>
        </table>

        <div class="mt-8 pt-8 border-t-2 border-slate-800">
            <h3 class="text-lg font-bold text-slate-700 uppercase mb-1">Appendix A: Traceability Record</h3>
            <p class="text-xs text-slate-400 mb-4">Site Daily Logs & Evidence supporting this claim</p>
            <table class="w-full text-left text-xs text-slate-600">
                <thead class="bg-slate-100 font-bold uppercase">
                    <tr>
                        <th class="p-2 w-24">Date</th>
                        <th class="p-2">Activity / Item</th>
                        <th class="p-2 text-right">Qty Reported</th>
                        <th class="p-2">Reference / Notes</th>
                    </tr>
                </thead>
                <tbody id="logsTable" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div class="mt-12 pt-6 border-t-2 border-slate-800 avoid-break">
            <div class="grid grid-cols-2 gap-12 mb-8">
                
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Claimed By (Contractor):</p>
                    <div class="relative border border-slate-300 rounded mb-1 bg-white h-24">
                        <canvas id="sigContractor"></canvas>
                        <button onclick="clearSig('sigContractor')" class="absolute top-1 right-1 text-[9px] bg-slate-200 px-2 rounded no-print">Clear</button>
                    </div>
                    <p class="text-xs font-bold text-slate-700">Authorized Signature</p>
                    <p class="text-[10px] text-slate-400">Date: <span id="signDate"></span></p>
                </div>

                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Certified By (Engineer to Contract):</p>
                    <div class="relative border border-slate-300 rounded mb-1 bg-white h-24">
                        <canvas id="sigEngineer"></canvas>
                        <button onclick="clearSig('sigEngineer')" class="absolute top-1 right-1 text-[9px] bg-slate-200 px-2 rounded no-print">Clear</button>
                    </div>
                    <p class="text-xs font-bold text-slate-700">Engineer's Signature / Stamp</p>
                    <p class="text-[10px] text-slate-400">Payment Schedule Issued On: _________</p>
                </div>

            </div>
            
            <div class="bg-slate-50 p-4 rounded text-[9px] text-slate-500 text-justify leading-relaxed border border-slate-200">
                <p class="font-bold mb-1">NOTICE TO THE PRINCIPAL (PAYER):</p>
                <p>This is a payment claim under the <strong>Construction Contracts Act 2002</strong>. You must provide a Payment Schedule within 20 working days (or as per contract). Failure to do so may result in liability for the full claimed amount.</p>
                <p class="mt-2 italic">Ref: NZS 3910 Conditions of Contract - Clause 12.1</p>
            </div>
        </div>

    </div>

    <div class="fixed bottom-6 right-6 no-print flex gap-4">
        <div id="draftControls" class="flex gap-4">
            <button onclick="saveDraft()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition">
                <i class="fas fa-save"></i> Save Draft
            </button>
            <button onclick="approveClaim()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-xl flex items-center gap-2 transform transition hover:scale-105">
                <i class="fas fa-check-circle"></i> SIGN & SUBMIT
            </button>
        </div>
        <div id="lockedControls" class="hidden">
            <div class="bg-red-100 text-red-700 px-6 py-3 rounded-full font-bold border border-red-200 flex items-center gap-2 shadow-lg">
                <i class="fas fa-lock"></i> CLAIM LOCKED
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pid = localStorage.getItem('civilmate_current_project_id');
        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }

        let scheduleData = [];
        let executionMap = {};
        let isLocked = false;

        init();

        async function init() {
            document.getElementById('claimDate').innerText = new Date().toLocaleDateString('en-NZ');
            document.getElementById('signDate').innerText = new Date().toLocaleDateString('en-NZ');
            
            setupCanvas('sigContractor');
            setupCanvas('sigEngineer');

            await checkStatus();
            await analyzeLogs();
            loadContractAndBuildTable();
        }

        async function checkStatus() {
            const doc = await db.collection('projects').doc(pid).get();
            if(doc.exists) {
                const p = doc.data();
                if(p.currentClaimStatus === 'Approved') {
                    lockUI(true);
                    if(p.lastAdvanceRepayment) document.getElementById('advanceInput').value = p.lastAdvanceRepayment;
                    // Load saved signature if available (Advanced feature for V3, placeholder for now)
                }
            }
        }

        // --- CANVAS LOGIC ---
        function setupCanvas(id) {
            const c = document.getElementById(id);
            c.width = c.offsetWidth;
            c.height = c.offsetHeight;
            const ctx = c.getContext('2d');
            let d = false;
            
            // Mouse & Touch Support
            const start = (e) => { d=true; ctx.beginPath(); getPos(e, c, ctx); };
            const move = (e) => { if(d) { getPos(e, c, ctx); ctx.stroke(); if(e.type==='touchmove')e.preventDefault(); } };
            const end = () => d=false;

            c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); c.addEventListener('mouseup', end);
            c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); c.addEventListener('touchend', end);
        }

        function getPos(e, c, ctx) {
            const r = c.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
            if(e.type === 'mousedown' || e.type === 'touchstart') ctx.moveTo(x, y); else ctx.lineTo(x, y);
            ctx.lineWidth = 2; ctx.strokeStyle = '#000';
        }

        window.clearSig = (id) => { const c=document.getElementById(id); c.getContext('2d').clearRect(0,0,c.width,c.height); }
        function isBlank(id) { const c=document.getElementById(id); return c.toDataURL() === document.createElement('canvas').toDataURL(); }

        // --- DATA LOGIC ---
        function analyzeLogs() {
            return db.collection('site_logs').where('projectId', '==', pid).get().then(snap => {
                const logBody = document.getElementById('logsTable');
                logBody.innerHTML = "";
                let logs = [];
                snap.forEach(d => logs.push(d.data()));
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                logs.forEach(log => {
                    const key = (log.itemName || "").trim(); 
                    if(!executionMap[key]) executionMap[key] = 0;
                    executionMap[key] += (parseFloat(log.qty) || 0);

                    logBody.innerHTML += `
                        <tr class="border-b border-slate-50 last:border-0">
                            <td class="p-2 font-bold text-slate-700">${log.date}</td>
                            <td class="p-2">${log.itemName}</td>
                            <td class="p-2 text-right font-mono font-bold text-blue-600">${log.qty} ${log.unit}</td>
                            <td class="p-2 italic text-slate-400 text-[10px] truncate max-w-[150px]">${log.notes || '-'}</td>
                        </tr>`;
                });
            });
        }

        function loadContractAndBuildTable() {
            db.collection('projects').doc(pid).get().then(doc => {
                if(doc.exists) {
                    const p = doc.data();
                    document.getElementById('projName').innerText = p.name;
                    scheduleData = p.schedule || p.items || [];
                    
                    const tbody = document.getElementById('linesTable');
                    tbody.innerHTML = "";
                    
                    if(scheduleData.length > 0) {
                        scheduleData.forEach((item) => {
                            const key = (item.desc || item.name || "").trim();
                            const executedQty = executionMap[key] || 0;
                            const remaining = item.qty - executedQty;
                            const isOverRun = remaining < 0;
                            
                            let remHTML = `<span class="font-bold text-slate-600">${remaining.toLocaleString()}</span>`;
                            if(isOverRun) remHTML = `<span class="font-bold text-red-600 blink"><i class="fas fa-exclamation-triangle"></i> ${remaining.toLocaleString()}</span>`;

                            let suggestedPercent = 0;
                            if(item.qty > 0) suggestedPercent = (executedQty / item.qty) * 100;
                            suggestedPercent = Math.round(suggestedPercent * 100) / 100;

                            const inputClass = isLocked ? "locked-input" : "bg-transparent border-b border-yellow-300 focus:border-blue-500";
                            const readOnly = isLocked ? "readonly" : "";

                            tbody.innerHTML += `
                                <tr class="hover:bg-slate-50 transition text-xs">
                                    <td class="py-3 pl-2 font-bold text-slate-700">${item.desc || item.name}</td>
                                    <td class="py-3 text-center text-slate-500">${item.unit}</td>
                                    <td class="py-3 text-center font-mono">${item.qty}</td>
                                    <td class="py-3 text-right font-mono">$${item.rate}</td>
                                    <td class="py-3 text-center bg-slate-100 border-x border-white text-xs">${remHTML}</td>
                                    <td class="py-3 text-center font-bold text-blue-600">${executedQty}</td>
                                    <td class="py-3 text-center bg-yellow-50 border-x border-yellow-100">
                                        <input type="number" min="0" step="1" value="${suggestedPercent}" ${readOnly}
                                            onchange="calcRow(this, ${item.qty}, ${item.rate})"
                                            class="w-16 text-center font-bold text-slate-900 text-sm outline-none ${inputClass}"> %
                                    </td>
                                    <td class="py-3 text-right pr-2 font-bold font-mono text-slate-800 row-total">$0.00</td>
                                </tr>
                            `;
                            
                            setTimeout(() => {
                                const inputs = document.querySelectorAll('#linesTable input');
                                const lastInput = inputs[inputs.length - 1];
                                if(lastInput) calcRow(lastInput, item.qty, item.rate);
                            }, 200);
                        });
                    }
                }
            });
        }

        function calcRow(input, qty, rate) {
            const percent = parseFloat(input.value) || 0;
            const rowTotal = (qty * rate) * (percent / 100);
            const row = input.closest('tr');
            row.querySelector('.row-total').innerText = fmtMoney(rowTotal);
            recalcTotal();
        }

        function recalcTotal() {
            let totalGross = 0;
            document.querySelectorAll('.row-total').forEach(cell => {
                totalGross += parseFloat(cell.innerText.replace('$','').replace(',','')) || 0;
            });

            const retention = totalGross * 0.10;
            const advRepayment = parseFloat(document.getElementById('advanceInput').value) || 0;
            const net = totalGross - retention - advRepayment;
            const gst = net * 0.15;
            const total = net + gst;

            document.getElementById('sumGross').innerText = fmtMoney(totalGross);
            document.getElementById('sumRet').innerText = "-" + fmtMoney(retention);
            document.getElementById('sumNet').innerText = fmtMoney(net);
            document.getElementById('sumGst').innerText = fmtMoney(gst);
            document.getElementById('sumTotal').innerText = fmtMoney(total);
        }

        function approveClaim() {
            if(isBlank('sigContractor')) return alert("Contractor must sign the claim before submitting.");
            if(!confirm("⚠️ Submit this Claim? This will lock the values.")) return;

            const advRepayment = parseFloat(document.getElementById('advanceInput').value) || 0;

            db.collection('projects').doc(pid).update({
                currentClaimStatus: 'Approved',
                lastClaimDate: new Date().toISOString(),
                lastAdvanceRepayment: advRepayment
            }).then(() => {
                alert("✅ CLAIM SUBMITTED.\nGenerating PDF...");
                lockUI(true);
                window.print();
            });
        }

        function saveDraft() {
            alert("Draft Saved locally.");
        }

        function lockUI(locked) {
            isLocked = locked;
            const inputs = document.querySelectorAll('input');
            const draftBtns = document.getElementById('draftControls');
            const lockBadge = document.getElementById('lockedControls');
            const statusBadge = document.getElementById('statusBadge');

            if(locked) {
                inputs.forEach(i => i.classList.add('locked-input'));
                draftBtns.classList.add('hidden');
                lockBadge.classList.remove('hidden');
                statusBadge.classList.remove('hidden');
                statusBadge.innerHTML = '<i class="fas fa-lock"></i> LOCKED';
                statusBadge.classList.add('bg-red-100', 'text-red-600');
                document.getElementById('advanceInput').disabled = true;
            }
        }

        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    </script>
</body>
</html>
