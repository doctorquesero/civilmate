<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payment Claim Generator - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f1f5f9; font-family: sans-serif; color: #334155; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #64748b; }
        /* Hoja de papel para la carátula */
        .a4-page { background: white; padding: 40px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body class="p-2 md:p-6 max-w-[1200px] mx-auto min-h-screen flex flex-col">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Financial Manager</h1>
            <p class="text-xs text-slate-500">NZS 3910 / CCA 2002 Compliant</p>
        </div>
        <a href="index.html" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></a>
    </header>

    <div class="flex border-b border-slate-200 mb-6 bg-white rounded-t-xl px-4 pt-2">
        <button onclick="switchTab('works')" id="tab-works" class="tab-active flex-1 py-3 text-sm text-center">
            <i class="fas fa-list mr-2"></i>1. Contract Works
        </button>
        <button onclick="switchTab('vars')" id="tab-vars" class="tab-inactive flex-1 py-3 text-sm text-center">
            <i class="fas fa-random mr-2"></i>2. Variations Register
        </button>
        <button onclick="switchTab('claim')" id="tab-claim" class="tab-inactive flex-1 py-3 text-sm text-center bg-green-50 text-green-700">
            <i class="fas fa-file-invoice-dollar mr-2"></i>3. Claim Cover Sheet
        </button>
    </div>

    <div id="view-works" class="view-section">
        <div class="bg-white rounded-b-xl shadow p-4 border border-t-0 border-slate-200">
            <h2 class="font-bold text-slate-700 mb-4">Original Contract Schedule</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="p-3">Item Description</th>
                            <th class="p-3 text-center">Unit</th>
                            <th class="p-3 text-right">Rate</th>
                            <th class="p-3 text-center w-24">This Claim Qty</th>
                            <th class="p-3 w-1/3">Evidence (Site Log / QA Ref)</th>
                            <th class="p-3 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="worksTable">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-vars" class="view-section hidden">
        <div class="bg-white rounded-b-xl shadow p-4 border border-t-0 border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="font-bold text-slate-700">Variations Register</h2>
                    <p class="text-xs text-slate-400">Only <strong>APPROVED</strong> variations will appear on the Payment Claim.</p>
                </div>
                <button onclick="addVariation()" class="bg-purple-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-purple-700">+ New VO</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-purple-50 text-purple-800 font-bold uppercase text-xs">
                        <tr>
                            <th class="p-3">Ref</th>
                            <th class="p-3">Variation Description</th>
                            <th class="p-3 text-right">Value ($)</th>
                            <th class="p-3 text-center">Status</th>
                            <th class="p-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="varsTable">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-claim" class="view-section hidden">
        <div class="a4-page">
            <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800 uppercase tracking-widest">Payment Claim</h1>
                    <p class="text-sm font-bold text-slate-500 mt-1">Under Construction Contracts Act 2002</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-xl">Claim #<span id="claimNumber">1</span></p>
                    <p class="text-sm text-slate-500" id="claimDate">Date: ...</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-8 text-sm">
                <div>
                    <p class="font-bold text-slate-400 uppercase text-xs">Project</p>
                    <p class="font-bold text-slate-800 text-lg">Auckland Central - Stage 1</p>
                    <p>123 Queen Street, Auckland CBD</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-slate-400 uppercase text-xs">To (Principal)</p>
                    <p class="font-bold text-slate-800">Main Contractor Ltd</p>
                    <p>Attn: Project Manager</p>
                </div>
            </div>

            <table class="w-full text-sm mb-6 border-collapse">
                <thead>
                    <tr class="bg-slate-100 text-slate-600 uppercase text-xs">
                        <th class="p-2 text-left">Description</th>
                        <th class="p-2 text-right">Amount (NZD)</th>
                    </tr>
                </thead>
                <tbody class="text-slate-700">
                    <tr class="border-b">
                        <td class="p-2">Original Contract Sum</td>
                        <td class="p-2 text-right font-mono" id="doc-original">$0.00</td>
                    </tr>
                    <tr class="border-b">
                        <td class="p-2">Approved Variations (Net)</td>
                        <td class="p-2 text-right font-mono text-purple-600" id="doc-vars">$0.00</td>
                    </tr>
                    <tr class="bg-slate-50 font-bold border-b-2 border-slate-300">
                        <td class="p-2">Revised Contract Sum</td>
                        <td class="p-2 text-right font-mono" id="doc-revised">$0.00</td>
                    </tr>
                    
                    <tr><td class="p-2 h-4"></td><td></td></tr> <tr class="border-b">
                        <td class="p-2 font-bold">Value of Work Completed to Date</td>
                        <td class="p-2 text-right font-mono font-bold" id="doc-gross">$0.00</td>
                    </tr>
                    <tr class="border-b text-red-500">
                        <td class="p-2">Less: Retention (10%)</td>
                        <td class="p-2 text-right font-mono" id="doc-retention">-$0.00</td>
                    </tr>
                    <tr class="border-b text-slate-400">
                        <td class="p-2">Less: Previous Payments</td>
                        <td class="p-2 text-right font-mono" id="doc-prev">-$0.00</td>
                    </tr>
                    
                    <tr class="bg-slate-800 text-white font-bold text-lg">
                        <td class="p-4">NET CLAIM AMOUNT (Ex GST)</td>
                        <td class="p-4 text-right" id="doc-net">$0.00</td>
                    </tr>
                    <tr class="bg-slate-200 text-slate-600 font-bold">
                        <td class="p-2 text-right">Plus GST (15%)</td>
                        <td class="p-2 text-right" id="doc-gst">$0.00</td>
                    </tr>
                    <tr class="bg-green-100 text-green-800 font-bold text-xl border border-green-300">
                        <td class="p-4 text-right">TOTAL PAYABLE</td>
                        <td class="p-4 text-right" id="doc-total">$0.00</td>
                    </tr>
                </tbody>
            </table>

            <div class="border-t pt-4 text-[10px] text-slate-400 leading-tight">
                <p class="font-bold mb-1">NOTICE TO PRINCIPAL:</p>
                <p>This is a payment claim under the Construction Contracts Act 2002. You must pay the amount claimed by the due date for payment or provide a payment schedule strictly within the time required by the construction contract (or the Act).</p>
            </div>
            
            <button onclick="alert('PDF Generated & Sent to Xero/MYOB')" class="mt-8 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded font-bold shadow-lg flex justify-center items-center gap-2">
                <i class="fas fa-paper-plane"></i> Send Claim to Client
            </button>
        </div>
    </div>

    <script>
        // --- DATA MOCKUP (Simulando Firebase) ---
        const contractItems = [
            { id: "3.1", name: "Bulk Excavation", unit: "m3", rate: 45.00, claimed: 0, evidence: "" },
            { id: "4.2", name: "Concrete Footings", unit: "m3", rate: 260.00, claimed: 0, evidence: "" },
            { id: "4.5", name: "Blockfill", unit: "m3", rate: 300.00, claimed: 0, evidence: "" },
            { id: "6.1", name: "Drainlayer (Hourly)", unit: "hr", rate: 85.00, claimed: 0, evidence: "" }
        ];

        let variations = [
            { ref: "VO-001", desc: "Remove Unforeseen Rock", val: 1500.00, status: "Pending" }
        ];

        // --- RENDERIZADO INICIAL ---
        renderWorks();
        renderVars();
        document.getElementById('claimDate').innerText = "Date: " + new Date().toLocaleDateString();

        // --- LOGICA DE TABS ---
        function switchTab(tab) {
            // Ocultar todos
            document.getElementById('view-works').classList.add('hidden');
            document.getElementById('view-vars').classList.add('hidden');
            document.getElementById('view-claim').classList.add('hidden');
            
            // Reset botones
            document.getElementById('tab-works').className = "tab-inactive flex-1 py-3 text-sm text-center cursor-pointer";
            document.getElementById('tab-vars').className = "tab-inactive flex-1 py-3 text-sm text-center cursor-pointer";
            document.getElementById('tab-claim').className = "tab-inactive flex-1 py-3 text-sm text-center bg-green-50 text-green-700 cursor-pointer";

            // Mostrar Activo
            document.getElementById('view-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).className = "tab-active flex-1 py-3 text-sm text-center cursor-pointer";

            if(tab === 'claim') calculateCoverSheet();
        }

        // --- 1. CONTRACT WORKS ---
        function renderWorks() {
            const tbody = document.getElementById('worksTable');
            tbody.innerHTML = "";
            contractItems.forEach((item, i) => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-3">
                            <span class="font-bold text-slate-700">${item.name}</span>
                            <div class="text-[10px] text-slate-400">ID: ${item.id}</div>
                        </td>
                        <td class="p-3 text-center text-xs bg-slate-100 rounded">${item.unit}</td>
                        <td class="p-3 text-right font-mono text-xs">$${item.rate.toFixed(2)}</td>
                        <td class="p-3 text-center">
                            <input type="number" onchange="updateWork(${i}, 'claimed', this.value)" class="w-20 p-2 border border-yellow-400 bg-yellow-50 font-bold text-center rounded focus:ring-2 ring-blue-500 outline-none" placeholder="0">
                        </td>
                        <td class="p-3">
                            <input type="text" onchange="updateWork(${i}, 'evidence', this.value)" class="w-full text-xs p-2 border rounded" placeholder="Required for Traceability">
                        </td>
                        <td class="p-3 text-right font-bold text-slate-700" id="row-total-${i}">$0.00</td>
                    </tr>
                `;
            });
        }

        function updateWork(i, field, val) {
            contractItems[i][field] = field === 'claimed' ? (parseFloat(val) || 0) : val;
            const total = contractItems[i].claimed * contractItems[i].rate;
            document.getElementById(`row-total-${i}`).innerText = "$" + total.toFixed(2);
        }

        // --- 2. VARIATIONS ---
        function addVariation() {
            const desc = prompt("Variation Description:");
            const val = prompt("Value ($):");
            if(desc && val) {
                variations.push({ 
                    ref: "VO-" + (variations.length + 1).toString().padStart(3, '0'), 
                    desc: desc, 
                    val: parseFloat(val), 
                    status: "Pending" 
                });
                renderVars();
            }
        }

        function renderVars() {
            const tbody = document.getElementById('varsTable');
            tbody.innerHTML = "";
            variations.forEach((v, i) => {
                let statusClass = v.status === "Approved" ? "bg-green-100 text-green-700" : "bg-orange-100 text-orange-700";
                let btnAction = v.status === "Approved" 
                    ? `<button onclick="toggleVar(${i})" class="text-xs text-orange-500 underline">Set Pending</button>`
                    : `<button onclick="toggleVar(${i})" class="text-xs bg-green-600 text-white px-2 py-1 rounded">Approve</button>`;

                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3 text-xs font-bold">${v.ref}</td>
                        <td class="p-3">${v.desc}</td>
                        <td class="p-3 text-right font-mono">$${v.val.toFixed(2)}</td>
                        <td class="p-3 text-center"><span class="text-[10px] px-2 py-1 rounded font-bold uppercase ${statusClass}">${v.status}</span></td>
                        <td class="p-3 text-center">${btnAction}</td>
                    </tr>
                `;
            });
        }

        function toggleVar(i) {
            variations[i].status = variations[i].status === "Pending" ? "Approved" : "Pending";
            renderVars();
        }

        // --- 3. CALCULATE COVER SHEET ---
        function calculateCoverSheet() {
            // 1. Original Contract (Mock Total)
            let originalTotal = 65000.00; 

            // 2. Approved Variations Only
            let approvedVars = 0;
            variations.forEach(v => { if(v.status === 'Approved') approvedVars += v.val; });

            // 3. Work Completed This Period
            let workValue = 0;
            let missingEvidence = false;
            contractItems.forEach(item => {
                if(item.claimed > 0 && item.evidence.length < 3) missingEvidence = true;
                workValue += (item.claimed * item.rate);
            });

            // Alerts Logic
            if(missingEvidence) alert("⚠️ WARNING: You have items claimed without Traceability (Evidence). The Engineer may reject this claim.");

            // Totals
            const grossClaim = workValue; // En realidad sería Work + Material On Site
            const retention = grossClaim * 0.10; // 10% Retention Standard
            const netClaim = grossClaim - retention; // Menos pagos previos (asumimos 0 para demo)
            const gst = netClaim * 0.15;
            const totalPayable = netClaim + gst;

            // Render DOM
            document.getElementById('doc-original').innerText = "$" + originalTotal.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('doc-vars').innerText = "$" + approvedVars.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('doc-revised').innerText = "$" + (originalTotal + approvedVars).toLocaleString(undefined, {minimumFractionDigits:2});
            
            document.getElementById('doc-gross').innerText = "$" + grossClaim.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('doc-retention').innerText = "-$" + retention.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('doc-prev').innerText = "-$0.00"; // Hardcoded for demo
            
            document.getElementById('doc-net').innerText = "$" + netClaim.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('doc-gst').innerText = "$" + gst.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('doc-total').innerText = "$" + totalPayable.toLocaleString(undefined, {minimumFractionDigits:2});
        }
    </script>
</body>
</html>
