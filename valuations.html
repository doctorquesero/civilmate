<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Valuations - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .locked-input { background-color: #f1f5f9; color: #64748b; border: none; pointer-events: none; }
        canvas { background-color: white; cursor: crosshair; width: 100%; height: 80px; touch-action: none; }
        
        @media print {
            body * { visibility: hidden; }
            #invoice, #invoice * { visibility: visible; }
            #invoice { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
            .no-print { display: none !important; }
            input { border: none; background: transparent; }
            input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            input[type=number] { -moz-appearance: textfield; }
            .bg-yellow-50 { background-color: transparent !important; border: none !important; }
            canvas { border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="p-6 max-w-[1400px] mx-auto min-h-screen pb-20">

    <div class="flex justify-between items-center mb-6 no-print">
        <button onclick="window.location.href='project_hub.html'" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 font-bold transition">
            <i class="fas fa-arrow-left"></i> Back to Hub
        </button>
        
        <div class="flex gap-2 items-center">
            <div id="statusBadge" class="px-4 py-2 rounded-lg text-xs font-bold uppercase hidden"></div>
            <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i> Print / PDF
            </button>
        </div>
    </div>

    <div id="invoice" class="bg-white p-10 rounded-xl shadow-xl border border-slate-200 min-h-[1000px] relative">
        
        <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
            <div>
                <h1 class="text-4xl font-bold text-slate-800 tracking-tight uppercase">Payment Claim</h1>
                <p class="text-xs text-slate-500 font-bold mt-1">CCA 2002 COMPLIANT</p>
            </div>
            <div class="text-right">
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Claim No:</span> <span class="font-bold text-xl" id="claimNum">...</span></div>
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Date:</span> <span class="font-bold" id="claimDate">...</span></div>
                <div><span class="font-bold text-slate-400 text-xs uppercase mr-2">Project:</span> <span class="font-bold text-blue-600" id="projName">Loading...</span></div>
            </div>
        </div>

        <div class="flex justify-end mb-8">
            <div class="w-1/3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Claim Summary</h3>
                
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-600">Gross Value (To Date)</span>
                    <span class="font-bold text-slate-800" id="sumGross">$0.00</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-red-400">Less: Retention (10%)</span>
                    <span class="font-bold text-red-400" id="sumRet">-$0.00</span>
                </div>
                <div class="flex justify-between text-sm mb-2 items-center">
                    <span class="text-amber-600">Less: Advance Repayment</span>
                    <div class="flex items-center">
                        <span class="text-amber-600 mr-1">-$</span>
                        <input type="number" id="advanceInput" value="0" onchange="recalcTotal()" class="w-20 text-right font-bold text-amber-600 bg-transparent border-b border-amber-200 outline-none focus:border-amber-500">
                    </div>
                </div>
                
                <div class="border-t border-slate-300 my-2"></div>
                
                <div class="flex justify-between text-lg mb-1">
                    <span class="font-bold text-slate-800">Net Claim (Ex GST)</span>
                    <span class="font-bold text-slate-900" id="sumNet">$0.00</span>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mb-2">
                    <span>GST (15%)</span>
                    <span id="sumGst">$0.00</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-green-600 mt-2 pt-2 border-t border-slate-200">
                    <span>TOTAL PAYABLE</span>
                    <span id="sumTotal">$0.00</span>
                </div>
            </div>
        </div>

        <table class="w-full text-left mb-12 border-collapse">
            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[9px] border-b border-slate-200">
                <tr>
                    <th class="py-3 pl-2 w-1/4">Description</th>
                    <th class="py-3 text-center">Unit</th>
                    <th class="py-3 text-center">Contract Qty</th>
                    <th class="py-3 text-right">Rate</th>
                    <th class="py-3 text-center bg-slate-100 text-slate-600 border-x border-white">Balance</th>
                    <th class="py-3 text-center w-24">Executed</th>
                    <th class="py-3 text-center w-24 bg-yellow-50 border-x border-yellow-100 text-yellow-700">Total % Done</th>
                    <th class="py-3 text-right pr-2">Claim Value</th>
                </tr>
            </thead>
            <tbody id="linesTable" class="divide-y divide-slate-100 text-sm">
                <tr><td colspan="8" class="p-4 text-center text-slate-400 italic">Analyzing Site Logs & Contract...</td></tr>
            </tbody>
        </table>

        <div class="mt-8 pt-8 border-t-2 border-slate-800">
            <h3 class="text-lg font-bold text-slate-700 uppercase mb-1">Appendix A: Traceability Record</h3>
            <p class="text-xs text-slate-400 mb-4">Site Daily Logs & Evidence supporting this claim</p>
            <table class="w-full text-left text-xs text-slate-600">
                <thead class="bg-slate-100 font-bold uppercase">
                    <tr>
                        <th class="p-2 w-24">Date</th>
                        <th class="p-2">Activity / Item</th>
                        <th class="p-2 text-right">Qty Reported</th>
                        <th class="p-2">Reference / Notes</th>
                    </tr>
                </thead>
                <tbody id="logsTable" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div class="mt-12 pt-6 border-t-2 border-slate-800 avoid-break">
            <div class="grid grid-cols-2 gap-12 mb-8">
                
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Claimed By (Contractor):</p>
                    <div class="relative border border-slate-300 rounded mb-1 bg-white h-24 overflow-hidden">
                        <canvas id="sigContractor"></canvas>
                        <img id="imgContractor" class="absolute inset-0 w-full h-full object-contain hidden">
                        <button id="btnClearContractor" onclick="clearSig('sigContractor')" class="absolute top-1 right-1 text-[9px] bg-slate-200 px-2 rounded no-print">Clear</button>
                    </div>
                    <p class="text-xs font-bold text-slate-700">Authorized Signature</p>
                    <p class="text-[10px] text-slate-400">Date: <span id="signDate"></span></p>
                </div>

                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Certified By (Engineer to Contract):</p>
                    <div class="relative border border-slate-300 rounded mb-1 bg-white h-24 overflow-hidden">
                        <canvas id="sigEngineer"></canvas>
                        <img id="imgEngineer" class="absolute inset-0 w-full h-full object-contain hidden">
                        <button id="btnClearEngineer" onclick="clearSig('sigEngineer')" class="absolute top-1 right-1 text-[9px] bg-slate-200 px-2 rounded no-print">Clear</button>
                    </div>
                    <p class="text-xs font-bold text-slate-700">Engineer's Signature / Stamp</p>
                    <p class="text-[10px] text-slate-400">Payment Schedule Issued On: _________</p>
                </div>

            </div>
            
            <div class="bg-slate-50 p-4 rounded text-[9px] text-slate-500 text-justify leading-relaxed border border-slate-200">
                <p class="font-bold mb-1">NOTICE TO THE PRINCIPAL (PAYER):</p>
                <p>This is a payment claim under the <strong>Construction Contracts Act 2002</strong>. You must provide a Payment Schedule within 20 working days. Failure to do so may result in liability for the full claimed amount.</p>
            </div>
        </div>

    </div>

    <div class="fixed bottom-6 right-6 no-print flex gap-4">
        <div id="draftControls" class="flex gap-4">
            <button onclick="saveDraft()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition">
                <i class="fas fa-save"></i> Save Draft
            </button>
            <button onclick="approveAndLock()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-xl flex items-center gap-2 transform transition hover:scale-105">
                <i class="fas fa-check-circle"></i> SIGN & SUBMIT
            </button>
        </div>
        <div id="lockedControls" class="hidden">
            <div class="bg-red-100 text-red-700 px-6 py-3 rounded-full font-bold border border-red-200 flex items-center gap-2 shadow-lg">
                <i class="fas fa-lock"></i> VIEWING HISTORICAL RECORD
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pid = localStorage.getItem('civilmate_current_project_id');
        // CHECK IF VIEWING HISTORY
        const viewClaimId = localStorage.getItem('civilmate_current_claim_id');

        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }

        let scheduleData = [];
        let executionMap = {};
        let nextClaimNum = 1;

        init();

        async function init() {
            document.getElementById('claimDate').innerText = new Date().toLocaleDateString('en-NZ');
            document.getElementById('signDate').innerText = new Date().toLocaleDateString('en-NZ');
            
            // Init Canvases
            initCanvas('sigContractor');
            initCanvas('sigEngineer');

            // --- MODE SWITCH ---
            if(viewClaimId) {
                // VIEW MODE: Load specific historical claim
                loadHistoricalClaim(viewClaimId);
            } else {
                // NEW MODE: Load live data
                await getNextClaimNumber();
                await analyzeLogs();
                loadContractAndBuildTable();
            }
        }

        async function getNextClaimNumber() {
            const snap = await db.collection('claims')
                .where('projectId', '==', pid)
                .orderBy('claimNumber', 'desc')
                .limit(1).get();
            
            if(!snap.empty) {
                nextClaimNum = snap.docs[0].data().claimNumber + 1;
            }
            document.getElementById('claimNum').innerText = nextClaimNum;
        }

        // --- NEW CANVAS LOGIC (Robust V2.3) ---
        function initCanvas(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext("2d");
            let isDrawing = false;

            function resize() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.lineWidth = 2; ctx.strokeStyle = "#000";
            }
            setTimeout(resize, 200);

            function getTouchPos(e) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            }

            // Events
            const start = (e) => { 
                if(e.type === 'touchstart') e.preventDefault();
                isDrawing = true; 
                ctx.beginPath(); 
                const p = getTouchPos(e); ctx.moveTo(p.x, p.y); 
            };
            const move = (e) => { 
                if(e.type === 'touchmove') e.preventDefault();
                if(!isDrawing) return; 
                const p = getTouchPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); 
            };
            const end = (e) => { if(e.type === 'touchend') e.preventDefault(); isDrawing = false; };

            canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('mousemove', move); canvas.addEventListener('touchmove', move, {passive: false});
            canvas.addEventListener('mouseup', end); canvas.addEventListener('touchend', end);
        }

        window.clearSig = (id) => { const c=document.getElementById(id); c.getContext('2d').clearRect(0,0,c.width,c.height); }
        function isBlank(id) { const c=document.getElementById(id); return c.toDataURL() === document.createElement('canvas').toDataURL(); }

        // --- DATA LOADING (LIVE) ---
        function analyzeLogs() {
            return db.collection('site_logs').where('projectId', '==', pid).get().then(snap => {
                const logBody = document.getElementById('logsTable');
                logBody.innerHTML = "";
                snap.forEach(d => {
                    const log = d.data();
                    const key = (log.itemName || "").trim();
                    // Solo sumar items de trabajo (no safety) para los totales
                    if(!log.itemName.includes("INDUCTION") && !log.itemName.includes("INCIDENT")) {
                        if(!executionMap[key]) executionMap[key] = 0;
                        executionMap[key] += (parseFloat(log.qty) || 0);
                    }
                    // Mostrar log en tabla
                    logBody.innerHTML += `
                        <tr class="border-b border-slate-50 last:border-0">
                            <td class="p-2 font-bold text-slate-700">${log.date}</td>
                            <td class="p-2">${log.itemName}</td>
                            <td class="p-2 text-right font-mono font-bold text-blue-600">${log.qty} ${log.unit}</td>
                            <td class="p-2 italic text-slate-400 text-[10px]">${log.notes || '-'}</td>
                        </tr>`;
                });
            });
        }

        function loadContractAndBuildTable() {
            db.collection('projects').doc(pid).get().then(doc => {
                if(doc.exists) {
                    const p = doc.data();
                    document.getElementById('projName').innerText = p.name;
                    scheduleData = p.schedule || p.items || [];
                    renderTable(false); // False = Editable (calculated)
                }
            });
        }

        function renderTable(isReadOnly, savedItems) {
            const tbody = document.getElementById('linesTable');
            tbody.innerHTML = "";
            
            // Use saved items if viewing history, else live schedule
            const items = savedItems || scheduleData;

            if(items.length > 0) {
                items.forEach((item) => {
                    // Logic depends on mode
                    let executedQty = 0;
                    let suggestedPercent = 0;
                    let claimValue = 0;

                    if(isReadOnly) {
                        // VIEW MODE: Use stored snapshot values
                        executedQty = item.executedQty;
                        suggestedPercent = item.percent;
                        claimValue = item.claimValue;
                    } else {
                        // LIVE MODE: Calculate
                        const key = (item.desc || item.name || "").trim();
                        executedQty = executionMap[key] || 0;
                        if(item.qty > 0) suggestedPercent = (executedQty / item.qty) * 100;
                        suggestedPercent = Math.round(suggestedPercent * 100) / 100;
                        claimValue = (item.qty * item.rate) * (suggestedPercent / 100);
                    }

                    const remaining = item.qty - executedQty;
                    let remHTML = `<span class="font-bold text-slate-600">${remaining.toLocaleString()}</span>`;
                    if(remaining < 0) remHTML = `<span class="font-bold text-red-600 blink">${remaining.toLocaleString()}</span>`;

                    const inputClass = isReadOnly ? "locked-input" : "bg-transparent border-b border-yellow-300 focus:border-blue-500";
                    const readOnlyAttr = isReadOnly ? "readonly" : "";

                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition text-xs item-row" 
                            data-desc="${item.desc||item.name}" data-unit="${item.unit}" 
                            data-qty="${item.qty}" data-rate="${item.rate}">
                            
                            <td class="py-3 pl-2 font-bold text-slate-700">${item.desc || item.name}</td>
                            <td class="py-3 text-center text-slate-500">${item.unit}</td>
                            <td class="py-3 text-center font-mono">${item.qty}</td>
                            <td class="py-3 text-right font-mono">$${item.rate}</td>
                            <td class="py-3 text-center bg-slate-100 border-x border-white text-xs">${remHTML}</td>
                            <td class="py-3 text-center font-bold text-blue-600">${executedQty}</td>
                            <td class="py-3 text-center bg-yellow-50 border-x border-yellow-100">
                                <input type="number" min="0" step="1" value="${suggestedPercent}" ${readOnlyAttr}
                                    onchange="calcRow(this, ${item.qty}, ${item.rate})"
                                    class="w-16 text-center font-bold text-slate-900 text-sm outline-none ${inputClass} percent-input"> %
                            </td>
                            <td class="py-3 text-right pr-2 font-bold font-mono text-slate-800 row-total">${fmtMoney(claimValue)}</td>
                        </tr>
                    `;
                });
                if(!isReadOnly) recalcTotal(); // Calculate initial totals
            }
        }

        // --- CALCULATION LOGIC ---
        function calcRow(input, qty, rate) {
            const percent = parseFloat(input.value) || 0;
            const rowTotal = (qty * rate) * (percent / 100);
            const row = input.closest('tr');
            row.querySelector('.row-total').innerText = fmtMoney(rowTotal);
            recalcTotal();
        }

        function recalcTotal() {
            let totalGross = 0;
            document.querySelectorAll('.row-total').forEach(cell => {
                totalGross += parseFloat(cell.innerText.replace('$','').replace(',','')) || 0;
            });

            const retention = totalGross * 0.10;
            const advRepayment = parseFloat(document.getElementById('advanceInput').value) || 0;
            const net = totalGross - retention - advRepayment;
            const gst = net * 0.15;
            const total = net + gst;

            document.getElementById('sumGross').innerText = fmtMoney(totalGross);
            document.getElementById('sumRet').innerText = "-" + fmtMoney(retention);
            document.getElementById('sumNet').innerText = fmtMoney(net);
            document.getElementById('sumGst').innerText = fmtMoney(gst);
            document.getElementById('sumTotal').innerText = fmtMoney(total);
        }

        // --- APPROVE & WRITE HISTORY (V3.0 LOGIC) ---
        function approveAndLock() {
            if(isBlank('sigContractor')) return alert("Contractor must sign before submitting.");
            if(!confirm("⚠️ Submit Claim #" + nextClaimNum + "?\n\nThis will create a permanent financial record.")) return;

            // 1. Gather Data Snapshot
            const grossVal = parseFloat(document.getElementById('sumGross').innerText.replace(/[^0-9.-]+/g,""));
            const netVal = parseFloat(document.getElementById('sumTotal').innerText.replace(/[^0-9.-]+/g,""));
            
            // Snapshot of line items so history doesn't change
            const itemsSnapshot = [];
            document.querySelectorAll('.item-row').forEach(row => {
                itemsSnapshot.push({
                    desc: row.dataset.desc,
                    unit: row.dataset.unit,
                    qty: parseFloat(row.dataset.qty),
                    rate: parseFloat(row.dataset.rate),
                    executedQty: parseFloat(row.children[5].innerText), // Col 6
                    percent: parseFloat(row.querySelector('.percent-input').value),
                    claimValue: parseFloat(row.querySelector('.row-total').innerText.replace(/[^0-9.-]+/g,""))
                });
            });

            const claimRecord = {
                projectId: pid,
                claimNumber: nextClaimNum,
                date: Date.now(),
                status: 'Submitted', // Initially submitted
                grossTotal: grossVal,
                netPayable: netVal,
                advanceRepayment: parseFloat(document.getElementById('advanceInput').value) || 0,
                signatures: {
                    contractor: document.getElementById('sigContractor').toDataURL(),
                    engineer: document.getElementById('sigEngineer').toDataURL()
                },
                items: itemsSnapshot
            };

            // 2. Batch Update (Write History + Update Project)
            const batch = db.batch();
            const claimRef = db.collection('claims').doc();
            const projectRef = db.collection('projects').doc(pid);

            batch.set(claimRef, claimRecord);
            batch.update(projectRef, {
                totalClaimedGross: grossVal, // Update Dashboard progress bar
                lastClaimDate: Date.now()
            });

            batch.commit().then(() => {
                alert("✅ Claim #" + nextClaimNum + " Saved & Submitted!");
                lockUI(true);
                window.print();
                window.location.href = 'project_hub.html'; // Return to hub to see update
            }).catch(e => alert("Error: " + e.message));
        }

        // --- LOAD HISTORICAL CLAIM (VIEW MODE) ---
        function loadHistoricalClaim(claimId) {
            lockUI(true); // Lock everything immediately
            
            db.collection('claims').doc(claimId).get().then(doc => {
                if(!doc.exists) return alert("Claim not found.");
                const c = doc.data();

                // Fill Header
                document.getElementById('claimNum').innerText = c.claimNumber;
                document.getElementById('claimDate').innerText = new Date(c.date).toLocaleDateString('en-NZ');
                
                // Fill Sums
                document.getElementById('sumGross').innerText = fmtMoney(c.grossTotal);
                document.getElementById('sumNet').innerText = fmtMoney(c.netPayable / 1.15); // Approx reverse
                document.getElementById('sumTotal').innerText = fmtMoney(c.netPayable);
                document.getElementById('advanceInput').value = c.advanceRepayment || 0;

                // Fill Signatures (Hide Canvas, Show Image)
                if(c.signatures) {
                    showSigImage('sigContractor', 'imgContractor', 'btnClearContractor', c.signatures.contractor);
                    showSigImage('sigEngineer', 'imgEngineer', 'btnClearEngineer', c.signatures.engineer);
                }

                // Render Table with Snapshot Data
                // Need project name first
                db.collection('projects').doc(pid).get().then(pDoc => {
                    document.getElementById('projName').innerText = pDoc.data().name;
                    renderTable(true, c.items); // True = Read Only
                });
            });
        }

        function showSigImage(canvasId, imgId, btnId, dataUrl) {
            document.getElementById(canvasId).classList.add('hidden');
            document.getElementById(btnId).classList.add('hidden');
            const img = document.getElementById(imgId);
            img.src = dataUrl;
            img.classList.remove('hidden');
        }

        function lockUI(locked) {
            const inputs = document.querySelectorAll('input');
            const draftBtns = document.getElementById('draftControls');
            const lockBadge = document.getElementById('lockedControls');
            const statusBadge = document.getElementById('statusBadge');

            if(locked) {
                inputs.forEach(i => i.classList.add('locked-input'));
                draftBtns.classList.add('hidden');
                lockBadge.classList.remove('hidden');
                statusBadge.classList.remove('hidden');
                statusBadge.innerHTML = '<i class="fas fa-lock"></i> RECORD LOCKED';
                statusBadge.classList.add('bg-gray-100', 'text-gray-600');
                document.getElementById('advanceInput').disabled = true;
            }
        }

        function saveDraft() { alert("Draft Saved locally."); }
        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    </script>
</body>
</html>
