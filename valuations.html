<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Claims - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .locked-input { background-color: transparent; color: #334155; border: none; pointer-events: none; font-weight: bold; text-align: center; width: 100%; }
        .percent-input { background-color: #fef9c3; border: 1px solid #fde047; color: #854d0e; font-weight: bold; text-align: center; border-radius: 4px; width: 60px; }
        .percent-input:focus { outline: 2px solid #ca8a04; background-color: #fff; }
        canvas { background-color: white; cursor: crosshair; width: 100%; height: 80px; touch-action: none; border: 1px dashed #cbd5e1; }
        @media print {
            body * { visibility: hidden; }
            #invoice, #invoice * { visibility: visible; }
            #invoice { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="p-6 max-w-[1400px] mx-auto min-h-screen pb-20">

    <div class="flex justify-between items-center mb-6 no-print">
        <button onclick="window.location.href='project_hub.html'" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 font-bold transition">
            <i class="fas fa-arrow-left"></i> Back to Hub
        </button>
        <div class="flex gap-2 items-center">
            <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i> Print / PDF
            </button>
        </div>
    </div>

    <div id="invoice" class="bg-white p-10 rounded-xl shadow-xl border border-slate-200 min-h-[1000px] relative">
        <div class="flex justify-between items-start border-b-2 border-purple-800 pb-6 mb-8">
            <div>
                <h1 class="text-4xl font-bold text-slate-800 tracking-tight uppercase">Payment Claim</h1>
                <p class="text-xs text-slate-500 font-bold mt-1">CONSTRUCTION CONTRACTS ACT 2002</p>
            </div>
            <div class="text-right">
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Claim No:</span> <span class="font-bold text-xl" id="claimNum">1</span></div>
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Date:</span> <span class="font-bold" id="claimDate">...</span></div>
                <div><span class="font-bold text-slate-400 text-xs uppercase mr-2">Project:</span> <span class="font-bold text-blue-600" id="projName">Loading...</span></div>
            </div>
        </div>

        <div class="flex justify-end mb-8">
            <div class="w-1/3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Claim Summary</h3>
                <div class="flex justify-between text-sm mb-2"><span class="text-slate-600">Total Work Done</span><span class="font-bold text-slate-800" id="sumGross">$0.00</span></div>
                <div class="flex justify-between text-sm mb-2"><span class="text-red-400">Less: Retention (10%)</span><span class="font-bold text-red-400" id="sumRet">-$0.00</span></div>
                <div class="flex justify-between text-sm mb-2 items-center"><span class="text-amber-600">Less: Prior Payments</span>
                    <div class="flex items-center"><span class="text-amber-600 mr-1">-$</span><input type="number" id="advanceInput" value="0" onchange="recalcTotal()" class="w-20 text-right font-bold text-amber-600 bg-transparent border-b border-amber-200 outline-none"></div>
                </div>
                <div class="border-t border-slate-300 my-2"></div>
                <div class="flex justify-between text-lg mb-1"><span class="font-bold text-slate-800">Net Claim (Ex GST)</span><span class="font-bold text-slate-900" id="sumNet">$0.00</span></div>
                <div class="flex justify-between text-xs text-slate-400 mb-2"><span>GST (15%)</span><span id="sumGst">$0.00</span></div>
                <div class="flex justify-between text-xl font-bold text-green-600 mt-2 pt-2 border-t border-slate-200"><span>TOTAL PAYABLE</span><span id="sumTotal">$0.00</span></div>
            </div>
        </div>

        <table class="w-full text-left mb-12 border-collapse">
            <thead class="bg-purple-50 text-purple-900 font-bold uppercase text-[9px] border-b border-purple-200">
                <tr>
                    <th class="py-3 pl-2 w-1/4">Description</th>
                    <th class="py-3 text-center">Unit</th>
                    <th class="py-3 text-center">Contract Qty</th>
                    <th class="py-3 text-right">Rate</th>
                    <th class="py-3 text-right pr-4 border-r border-purple-200">Total</th>
                    <th class="py-3 text-center w-20 bg-yellow-50">% Done</th>
                    <th class="py-3 text-center w-24">Qty Done</th>
                    <th class="py-3 text-right pr-2">Claim Value</th>
                </tr>
            </thead>
            <tbody id="linesTable" class="divide-y divide-slate-100 text-sm"></tbody>
        </table>

        <div class="mt-12 pt-6 border-t-2 border-slate-800 avoid-break">
            <div class="grid grid-cols-2 gap-12 mb-8">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Contractor Declaration:</p>
                    <div class="h-20 border border-dashed border-slate-300 rounded mb-1 bg-white relative">
                        <canvas id="sigContractor"></canvas>
                        <button onclick="clearSig('sigContractor')" class="absolute top-1 right-1 text-[9px] bg-slate-100 px-2 rounded border no-print">Clear</button>
                    </div>
                    <p class="text-xs font-bold text-slate-700">Authorized Signature</p>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Certified By Engineer:</p>
                    <div class="h-20 border border-dashed border-slate-300 rounded mb-1 bg-white relative">
                        <canvas id="sigEngineer"></canvas>
                        <button onclick="clearSig('sigEngineer')" class="absolute top-1 right-1 text-[9px] bg-slate-100 px-2 rounded border no-print">Clear</button>
                    </div>
                    <p class="text-xs font-bold text-slate-700">Payment Schedule Issued</p>
                </div>
            </div>
            <div class="bg-slate-50 p-4 rounded text-[9px] text-slate-500 text-justify leading-relaxed border border-slate-200">
                <p class="font-bold mb-1">PAYMENT CLAIM NOTICE:</p>
                <p>This is a valid payment claim under the <strong>Construction Contracts Act 2002</strong>. The principal must provide a Payment Schedule within 20 working days. Failure to do so may result in liability for the full claimed amount.</p>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 no-print">
        <button onclick="approveAndLock()" class="bg-green-600 text-white px-8 py-3 rounded-full shadow-xl hover:bg-green-700 transition font-bold flex items-center gap-2 transform hover:scale-105">
            <i class="fas fa-check-circle"></i> SUBMIT CLAIM
        </button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const pid = localStorage.getItem('civilmate_current_project_id');
        let scheduleData = [];

        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }

        init();
        function init() {
            document.getElementById('claimDate').innerText = new Date().toLocaleDateString('en-NZ');
            initCanvas('sigContractor'); initCanvas('sigEngineer');
            db.collection('projects').doc(pid).get().then(doc => {
                if(doc.exists) {
                    const p = doc.data();
                    document.getElementById('projName').innerText = p.name;
                    scheduleData = p.schedule || p.items || [];
                    renderTable();
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('linesTable');
            tbody.innerHTML = "";
            scheduleData.forEach(item => {
                const total = item.qty * item.rate;
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition item-row" data-qty="${item.qty}" data-rate="${item.rate}">
                        <td class="py-3 pl-2 font-bold text-slate-700">${item.desc || item.name}</td>
                        <td class="py-3 text-center text-slate-500">${item.unit}</td>
                        <td class="py-3 text-center font-mono locked-input">${item.qty}</td>
                        <td class="py-3 text-right font-mono locked-input">$${item.rate.toLocaleString('en-NZ', {minimumFractionDigits: 2})}</td>
                        <td class="py-3 text-right pr-4 font-mono text-slate-400 border-r border-purple-200">$${total.toLocaleString('en-NZ', {minimumFractionDigits: 2})}</td>
                        <td class="py-3 text-center bg-yellow-50"><input type="number" min="0" max="100" value="0" oninput="calcRow(this)" class="percent-input text-sm"> %</td>
                        <td class="py-3 text-center font-bold text-blue-600 qty-done">0.00</td>
                        <td class="py-3 text-right pr-2 font-bold font-mono text-slate-900 row-total">$0.00</td>
                    </tr>`;
            });
            recalcTotal();
        }

        function calcRow(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.dataset.qty);
            const rate = parseFloat(row.dataset.rate);
            let pct = parseFloat(input.value) || 0;
            if(pct > 100) { input.value = 100; pct = 100; }
            const done = qty * (pct/100);
            row.querySelector('.qty-done').innerText = done.toFixed(2);
            row.querySelector('.row-total').innerText = "$" + (done * rate).toLocaleString('en-NZ', {minimumFractionDigits: 2});
            recalcTotal();
        }

        function recalcTotal() {
            let total = 0;
            document.querySelectorAll('.row-total').forEach(el => total += parseFloat(el.innerText.replace(/[$,]/g,''))||0);
            const ret = total * 0.10;
            const prior = parseFloat(document.getElementById('advanceInput').value)||0;
            const net = total - ret - prior;
            const gst = net * 0.15;
            
            document.getElementById('sumGross').innerText = fmtMoney(total);
            document.getElementById('sumRet').innerText = "-" + fmtMoney(ret);
            document.getElementById('sumNet').innerText = fmtMoney(net);
            document.getElementById('sumGst').innerText = fmtMoney(gst);
            document.getElementById('sumTotal').innerText = fmtMoney(net + gst);
        }

        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        function initCanvas(id) {
            const c = document.getElementById(id); const ctx = c.getContext('2d'); let d=false;
            function rs(){c.width=c.offsetWidth;c.height=c.offsetHeight;ctx.lineWidth=2;} setTimeout(rs,200);
            const start=(e)=>{if(e.type==='touchstart')e.preventDefault();d=true;ctx.beginPath();const p=pos(e);ctx.moveTo(p.x,p.y);};
            const move=(e)=>{if(e.type==='touchmove')e.preventDefault();if(!d)return;const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke();};
            const end=(e)=>{if(e.type==='touchend')e.preventDefault();d=false;};
            const pos=(e)=>{const r=c.getBoundingClientRect();return{x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,y:(e.touches?e.touches[0].clientY:e.clientY)-r.top};};
            c.addEventListener('mousedown',start); c.addEventListener('touchstart',start,{passive:false});
            c.addEventListener('mousemove',move); c.addEventListener('touchmove',move,{passive:false});
            c.addEventListener('mouseup',end); c.addEventListener('touchend',end);
        }
        window.clearSig = (id) => { const c=document.getElementById(id); c.getContext('2d').clearRect(0,0,c.width,c.height); }
        function approveAndLock() { if(confirm("Submit Claim?")) { alert("Submitted!"); window.print(); } }
    </script>
</body>
</html>
