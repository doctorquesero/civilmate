<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract & Valuations Manager - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; -webkit-print-color-adjust: exact; }
        
        /* STATE: CLAIM MODE STYLES */
        .percent-input { background-color: #fef9c3; border: 1px solid #fde047; color: #854d0e; font-weight: bold; text-align: center; border-radius: 4px; width: 60px; }
        .percent-input:focus { outline: 2px solid #ca8a04; background-color: #fff; }
        .locked-input { background: transparent; border: none; text-align: center; width: 100%; pointer-events: none; }
        
        /* STATE: CONTRACT MODE STYLES */
        .contract-doc { font-family: 'Times New Roman', serif; }
        .contract-header { border-bottom: 3px double #000; padding-bottom: 20px; margin-bottom: 30px; }
        
        /* SIGNATURE CANVAS */
        canvas { background-color: white; cursor: crosshair; width: 100%; height: 80px; touch-action: none; border: 1px dashed #cbd5e1; }
        
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .page-sheet { box-shadow: none !important; margin: 0 !important; border: none !important; width: 100% !important; max-width: none !important; }
            
            /* Break handling */
            tr { page-break-inside: avoid; }
            .avoid-break { page-break-inside: avoid; }
            
            /* Hide the view that is NOT active */
            .hidden-view { display: none !important; }
        }
    </style>
</head>
<body class="p-8 min-h-screen">

    <div class="max-w-[210mm] mx-auto flex justify-between items-center mb-8 no-print">
        <button onclick="window.location.href='project_hub.html'" class="bg-white text-slate-600 px-4 py-2 rounded shadow-sm border border-slate-300 hover:bg-slate-50 transition font-bold text-sm">
            <i class="fas fa-arrow-left mr-2"></i> Dashboard
        </button>
        
        <div class="flex gap-3 items-center">
            <span id="modeBadge" class="px-3 py-1 rounded text-xs font-bold uppercase tracking-wider">Loading...</span>
            
            <button onclick="window.print()" class="bg-slate-800 text-white px-5 py-2 rounded shadow-lg hover:bg-black transition font-bold text-sm flex items-center gap-2">
                <i class="fas fa-print"></i> Print / PDF
            </button>
            
            <button id="btnSubmitClaim" onclick="approveAndLock()" class="hidden bg-green-600 text-white px-5 py-2 rounded shadow-lg hover:bg-green-700 transition font-bold text-sm flex items-center gap-2">
                <i class="fas fa-check-circle"></i> Submit Claim
            </button>
        </div>
    </div>

    <div id="view-contract" class="hidden page-sheet max-w-[210mm] mx-auto bg-white p-12 shadow-2xl min-h-[297mm] relative">
        
        <div class="contract-header text-center">
            <h1 class="text-4xl font-bold uppercase tracking-widest text-slate-900 mb-2">Schedule of Works</h1>
            <p class="text-sm font-bold text-slate-500 uppercase">Appendix A - Approved Contract Rates</p>
        </div>

        <div class="grid grid-cols-2 gap-8 mb-8 text-sm border-b border-slate-200 pb-8">
            <div>
                <p class="font-bold text-xs text-slate-400 uppercase">Principal (Client)</p>
                <p class="text-lg font-serif font-bold text-slate-900" id="mcClient">...</p>
                <p class="text-slate-600" id="mcAddress">...</p>
            </div>
            <div class="text-right">
                <p class="font-bold text-xs text-slate-400 uppercase">Contractor</p>
                <p class="text-lg font-serif font-bold text-slate-900" id="mcContractor">My Construction Co.</p>
                <p class="text-slate-600" id="mcDate">...</p>
            </div>
        </div>

        <table class="w-full text-left mb-8 border-collapse font-serif text-sm">
            <thead class="bg-slate-900 text-white text-xs uppercase">
                <tr>
                    <th class="py-3 pl-4 w-12 text-center">#</th>
                    <th class="py-3 pl-2">Description</th>
                    <th class="py-3 text-center">Unit</th>
                    <th class="py-3 text-center">Qty</th>
                    <th class="py-3 text-right">Rate</th>
                    <th class="py-3 text-right pr-4">Amount</th>
                </tr>
            </thead>
            <tbody id="mcTableBody" class="divide-y divide-slate-200">
                </tbody>
            <tfoot class="bg-slate-50 font-bold border-t-2 border-slate-900">
                <tr>
                    <td colspan="5" class="py-3 text-right pr-6 uppercase text-xs">Contract Sum (Ex GST)</td>
                    <td class="py-3 text-right pr-4 text-lg" id="mcTotal">$0.00</td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-16 avoid-break">
            <p class="text-xs text-slate-500 mb-8 italic text-center">This Schedule of Works forms part of the Contract Agreement pursuant to NZS 3910. Quantities are provisional unless stated otherwise.</p>
            <div class="grid grid-cols-2 gap-16">
                <div>
                    <div class="border-b border-slate-400 h-10"></div>
                    <p class="text-[10px] font-bold uppercase mt-1 text-slate-500">Signed for Contractor</p>
                </div>
                <div>
                    <div class="border-b border-slate-400 h-10"></div>
                    <p class="text-[10px] font-bold uppercase mt-1 text-slate-500">Signed for Principal</p>
                </div>
            </div>
        </div>

    </div>


    <div id="view-claim" class="hidden page-sheet max-w-[210mm] mx-auto bg-white p-10 shadow-2xl min-h-[297mm] relative">
        
        <div class="flex justify-between items-start border-b-2 border-purple-800 pb-6 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-purple-900 uppercase">Payment Claim</h1>
                <p class="text-[10px] font-bold text-purple-500 mt-1 uppercase tracking-wide">Construction Contracts Act 2002</p>
            </div>
            <div class="text-right">
                <div class="text-sm font-bold text-slate-500">Claim #<span id="pcNum" class="text-slate-900 text-lg ml-1">1</span></div>
                <div class="text-xs text-slate-400">Date: <span id="pcDate">...</span></div>
            </div>
        </div>

        <div class="flex justify-end mb-8">
            <div class="w-1/2 bg-slate-50 p-4 rounded border border-slate-200">
                <table class="w-full text-sm">
                    <tr>
                        <td class="pb-1 text-slate-600">Total Value of Work Done</td>
                        <td class="pb-1 text-right font-bold text-slate-800" id="pcGross">$0.00</td>
                    </tr>
                    <tr>
                        <td class="pb-1 text-red-500">Less Retention (10%)</td>
                        <td class="pb-1 text-right font-bold text-red-500" id="pcRet">-$0.00</td>
                    </tr>
                    <tr>
                        <td class="pb-1 text-amber-600">Less Prior Payments</td>
                        <td class="pb-1 text-right font-bold text-amber-600">
                            <span class="no-print mr-1">-$</span><input type="number" id="pcPrior" value="0" class="bg-transparent text-right font-bold text-amber-600 w-20 outline-none border-b border-amber-300 focus:border-amber-600" onchange="recalcClaim()">
                        </td>
                    </tr>
                    <tr class="border-t border-slate-300">
                        <td class="pt-2 font-bold text-lg text-slate-900">Net Claim (Ex GST)</td>
                        <td class="pt-2 text-right font-bold text-lg text-slate-900" id="pcNet">$0.00</td>
                    </tr>
                    <tr>
                        <td class="text-xs text-slate-400">GST (15%)</td>
                        <td class="text-right text-xs text-slate-400" id="pcGst">$0.00</td>
                    </tr>
                    <tr class="border-t border-slate-200">
                        <td class="pt-2 font-bold text-xl text-green-700">TOTAL PAYABLE</td>
                        <td class="pt-2 text-right font-bold text-xl text-green-700" id="pcTotal">$0.00</td>
                    </tr>
                </table>
            </div>
        </div>

        <table class="w-full text-left mb-8 border-collapse text-xs">
            <thead class="bg-purple-50 text-purple-900 font-bold uppercase border-b border-purple-200">
                <tr>
                    <th class="py-2 pl-2 w-1/3">Description</th>
                    <th class="py-2 text-center">Unit</th>
                    <th class="py-2 text-right">Rate</th>
                    <th class="py-2 text-right pr-4 border-r border-purple-200">Contract</th>
                    
                    <th class="py-2 text-center w-16 bg-yellow-50">% Done</th>
                    <th class="py-2 text-right">Total Executed</th>
                    <th class="py-2 text-right pr-2">Current Value</th>
                </tr>
            </thead>
            <tbody id="pcTableBody" class="divide-y divide-slate-100">
                </tbody>
        </table>

        <div class="mt-12 pt-6 border-t-2 border-slate-800 avoid-break">
            <div class="grid grid-cols-2 gap-8">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Contractor Declaration:</p>
                    <div class="h-20 border border-dashed border-slate-300 rounded mb-1 bg-white relative">
                        <canvas id="sigCanvas"></canvas>
                        <button onclick="clearSig()" class="absolute top-1 right-1 text-[9px] bg-slate-100 px-2 rounded border no-print">Clear</button>
                    </div>
                    <p class="text-[10px] text-slate-500">I certify the work claimed has been completed as per contract.</p>
                </div>
                <div class="bg-slate-50 p-3 rounded border border-slate-200 text-[10px] text-slate-600 text-justify">
                    <p class="font-bold mb-1">PAYMENT SCHEDULE NOTICE:</p>
                    <p>The principal must provide a Payment Schedule within 20 working days. If no schedule is provided, this claimed amount becomes a debt due.</p>
                </div>
            </div>
        </div>

    </div>


    <script>
        // --- 1. FIREBASE SETUP ---
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. CONTEXT LOADING ---
        const projectId = localStorage.getItem('civilmate_current_project_id');
        const viewMode = localStorage.getItem('civilmate_view_mode') || 'claim'; // 'contract' or 'claim'
        
        // --- 3. STATE CONTROLLER ---
        // This is the brain that decides which HTML Block to show
        
        let projectData = null;

        init();

        function init() {
            if(!projectId) return alert("No Project Selected");
            
            // UI Toggle based on Mode
            if (viewMode === 'contract') {
                setupContractMode();
            } else {
                setupClaimMode();
            }

            // Load Data
            loadProjectData();
        }

        function setupContractMode() {
            // Show Master Contract View
            document.getElementById('view-contract').classList.remove('hidden');
            document.getElementById('view-claim').classList.add('hidden');
            
            // Badge Styling
            const badge = document.getElementById('modeBadge');
            badge.innerText = "MASTER CONTRACT (READ ONLY)";
            badge.className = "px-3 py-1 rounded text-xs font-bold uppercase tracking-wider bg-slate-200 text-slate-700 border border-slate-300";
            
            // Hide interactive buttons
            document.getElementById('btnSubmitClaim').classList.add('hidden');
        }

        function setupClaimMode() {
            // Show Payment Claim View
            document.getElementById('view-claim').classList.remove('hidden');
            document.getElementById('view-contract').classList.add('hidden');

            // Badge Styling
            const badge = document.getElementById('modeBadge');
            badge.innerText = "PROGRESS CLAIM (EDITABLE)";
            badge.className = "px-3 py-1 rounded text-xs font-bold uppercase tracking-wider bg-purple-100 text-purple-700 border border-purple-200";

            // Show interactive buttons
            document.getElementById('btnSubmitClaim').classList.remove('hidden');
            
            // Init Canvas
            initCanvas();
        }

        function loadProjectData() {
            db.collection('projects').doc(projectId).get().then(doc => {
                if(doc.exists) {
                    projectData = doc.data();
                    const schedule = projectData.schedule || projectData.items || [];

                    if(viewMode === 'contract') {
                        renderContractSchedule(schedule);
                        document.getElementById('mcClient').innerText = projectData.client;
                        document.getElementById('mcContractor').innerText = "My Construction Co."; // Or from user profile
                        document.getElementById('mcDate').innerText = new Date().toLocaleDateString('en-NZ');
                    } else {
                        renderClaimSchedule(schedule);
                        document.getElementById('projName').innerText = projectData.name;
                        document.getElementById('claimDate').innerText = new Date().toLocaleDateString('en-NZ');
                    }
                }
            });
        }

        // --- 4. RENDERERS ---

        // A) CONTRACT RENDERER (Text Only)
        function renderContractSchedule(items) {
            const tbody = document.getElementById('mcTableBody');
            let total = 0;
            tbody.innerHTML = "";

            items.forEach((item, index) => {
                const lineTotal = item.qty * item.rate;
                total += lineTotal;
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100">
                        <td class="py-3 text-center text-slate-400">${index+1}</td>
                        <td class="py-3 pl-2 font-bold text-slate-800">${item.desc || item.name}</td>
                        <td class="py-3 text-center text-slate-600">${item.unit}</td>
                        <td class="py-3 text-center font-mono text-slate-700">${item.qty}</td>
                        <td class="py-3 text-right font-mono text-slate-600">$${item.rate.toLocaleString('en-NZ', {minimumFractionDigits: 2})}</td>
                        <td class="py-3 text-right pr-4 font-bold font-mono text-slate-900">$${lineTotal.toLocaleString('en-NZ', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });

            document.getElementById('mcTotal').innerText = "$" + total.toLocaleString('en-NZ', {minimumFractionDigits: 2});
        }

        // B) CLAIM RENDERER (Inputs Enabled)
        function renderClaimSchedule(items) {
            const tbody = document.getElementById('pcTableBody');
            tbody.innerHTML = "";

            items.forEach((item, index) => {
                const contractTotal = item.qty * item.rate;
                
                // Logic: In a real app, you'd fetch previous % from DB. 
                // Here we start at 0 or whatever was saved last.
                const executedPercent = 0; 
                
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 item-row" 
                        data-rate="${item.rate}" data-qty="${item.qty}" data-desc="${item.desc}">
                        <td class="py-3 pl-2 font-bold text-slate-700">${item.desc || item.name}</td>
                        <td class="py-3 text-center text-slate-500">${item.unit}</td>
                        <td class="py-3 text-right font-mono text-slate-400">$${item.rate.toFixed(2)}</td>
                        <td class="py-3 text-right pr-4 font-mono text-slate-400 border-r border-purple-100">$${contractTotal.toLocaleString()}</td>
                        
                        <td class="py-3 text-center bg-yellow-50">
                            <input type="number" min="0" max="100" value="${executedPercent}" 
                                oninput="calcRow(this)"
                                class="percent-input text-sm"> %
                        </td>
                        <td class="py-3 text-right font-bold text-blue-600 qty-val">0.00</td>
                        <td class="py-3 text-right pr-2 font-bold font-mono text-slate-900 row-total">$0.00</td>
                    </tr>
                `;
            });
            recalcClaim();
        }

        // --- 5. MATH LOGIC (CLAIM MODE ONLY) ---
        function calcRow(input) {
            const row = input.closest('tr');
            const totalQty = parseFloat(row.dataset.qty);
            const rate = parseFloat(row.dataset.rate);
            let pct = parseFloat(input.value) || 0;

            if (pct > 100) { input.value = 100; pct = 100; } // Cap at 100%

            const executedQty = totalQty * (pct / 100);
            const currentVal = executedQty * rate;

            row.querySelector('.qty-val').innerText = executedQty.toFixed(2);
            row.querySelector('.row-total').innerText = "$" + currentVal.toLocaleString('en-NZ', {minimumFractionDigits: 2});

            recalcClaim();
        }

        function recalcClaim() {
            let totalWork = 0;
            document.querySelectorAll('.row-total').forEach(el => {
                totalWork += parseFloat(el.innerText.replace(/[$,]/g, '')) || 0;
            });

            const retention = totalWork * 0.10;
            const prior = parseFloat(document.getElementById('pcPrior').value) || 0;
            const net = totalWork - retention - prior;
            const gst = net * 0.15;
            const total = net + gst;

            document.getElementById('sumGross').innerText = fmtMoney(totalWork);
            document.getElementById('sumRet').innerText = "-" + fmtMoney(retention);
            document.getElementById('sumNet').innerText = fmtMoney(net);
            document.getElementById('sumGst').innerText = fmtMoney(gst);
            document.getElementById('sumTotal').innerText = fmtMoney(total);
        }

        function fmtMoney(n) {
            return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // --- 6. UTILS (Canvas & Save) ---
        function initCanvas() {
            const canvas = document.getElementById('sigCanvas');
            const ctx = canvas.getContext("2d");
            let drawing = false;

            // Resize
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.lineWidth = 2; ctx.strokeStyle = "#000";

            const start = (e) => { e.preventDefault(); drawing=true; ctx.beginPath(); };
            const end = () => { drawing=false; };
            const draw = (e) => {
                if(!drawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                ctx.lineTo(x, y); ctx.stroke();
            };

            canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start);
            canvas.addEventListener('mouseup', end); canvas.addEventListener('touchend', end);
            canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchmove', draw);
        }
        function clearSig() { 
            const c = document.getElementById('sigCanvas'); 
            c.getContext('2d').clearRect(0,0,c.width,c.height); 
        }

        function approveAndLock() {
            if(!confirm("Submit Claim? This will lock the record.")) return;
            alert("Claim Submitted to Database âœ… (Mock)");
            window.print();
        }

    </script>
</body>
</html>
