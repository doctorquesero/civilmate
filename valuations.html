<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Valuations - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            #invoice, #invoice * { visibility: visible; }
            #invoice { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
            .no-print { display: none !important; }
            input { border: none; background: transparent; }
            /* Ocultar flechas de inputs numéricos al imprimir */
            input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            input[type=number] { -moz-appearance: textfield; }
        }
    </style>
</head>
<body class="p-6 max-w-[1200px] mx-auto min-h-screen pb-20">

    <div class="flex justify-between items-center mb-6 no-print">
        <button onclick="window.location.href='project_hub.html'" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 font-bold transition">
            <i class="fas fa-arrow-left"></i> Back to Hub
        </button>
        
        <div class="flex gap-2">
            <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-xs font-bold border border-blue-100 flex items-center">
                <i class="fas fa-robot mr-2 text-lg"></i>
                <div>
                    <span class="block uppercase text-[9px] text-blue-400">Auto-Calc Mode</span>
                    <span>Syncing with Site Tracker...</span>
                </div>
            </div>
            <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i> Print / PDF
            </button>
        </div>
    </div>

    <div id="invoice" class="bg-white p-10 rounded-xl shadow-xl border border-slate-200 min-h-[1000px] relative">
        
        <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
            <div>
                <h1 class="text-4xl font-bold text-slate-800 tracking-tight uppercase">Payment Claim</h1>
                <p class="text-xs text-slate-500 font-bold mt-1">CCA 2002 COMPLIANT</p>
            </div>
            <div class="text-right">
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Claim No:</span> <span class="font-bold text-xl">1</span></div>
                <div class="mb-1"><span class="font-bold text-slate-400 text-xs uppercase mr-2">Date:</span> <span class="font-bold" id="claimDate">...</span></div>
                <div><span class="font-bold text-slate-400 text-xs uppercase mr-2">Project:</span> <span class="font-bold text-blue-600" id="projName">Loading...</span></div>
            </div>
        </div>

        <div class="flex justify-end mb-8">
            <div class="w-1/3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 border-b pb-1">Claim Summary</h3>
                
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-600">Gross Value (To Date)</span>
                    <span class="font-bold text-slate-800" id="sumGross">$0.00</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-red-400">Less: Retention (10%)</span>
                    <span class="font-bold text-red-400" id="sumRet">-$0.00</span>
                </div>
                
                <div class="border-t border-slate-300 my-2"></div>
                
                <div class="flex justify-between text-lg mb-1">
                    <span class="font-bold text-slate-800">Net Claim (Ex GST)</span>
                    <span class="font-bold text-slate-900" id="sumNet">$0.00</span>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mb-2">
                    <span>GST (15%)</span>
                    <span id="sumGst">$0.00</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-green-600 mt-2 pt-2 border-t border-slate-200">
                    <span>TOTAL PAYABLE</span>
                    <span id="sumTotal">$0.00</span>
                </div>
            </div>
        </div>

        <table class="w-full text-left mb-12">
            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] border-b border-slate-200">
                <tr>
                    <th class="py-3 pl-2">Description</th>
                    <th class="py-3 text-center">Unit</th>
                    <th class="py-3 text-center">Contr. Qty</th>
                    <th class="py-3 text-right">Rate</th>
                    <th class="py-3 text-center w-32">Actual Qty (Logs)</th>
                    <th class="py-3 text-center w-24 bg-yellow-50 border-x border-yellow-100 text-yellow-700">Total %</th>
                    <th class="py-3 text-right pr-2">Claim Value</th>
                </tr>
            </thead>
            <tbody id="linesTable" class="divide-y divide-slate-100 text-sm">
                <tr><td colspan="7" class="p-4 text-center text-slate-400 italic">Analyzing Site Logs & Contract...</td></tr>
            </tbody>
        </table>

        <div class="mt-8 pt-8 border-t-2 border-slate-800">
            <h3 class="text-lg font-bold text-slate-700 uppercase mb-1">Appendix A: Traceability Record</h3>
            <p class="text-xs text-slate-400 mb-4">Site Daily Logs & Evidence supporting this claim</p>

            <table class="w-full text-left text-xs text-slate-600">
                <thead class="bg-slate-100 font-bold uppercase">
                    <tr>
                        <th class="p-2 w-24">Date</th>
                        <th class="p-2">Activity / Item</th>
                        <th class="p-2 text-right">Qty Reported</th>
                        <th class="p-2">Reference / Notes</th>
                    </tr>
                </thead>
                <tbody id="logsTable" class="divide-y divide-slate-100">
                    <tr><td colspan="4" class="p-4 text-center italic text-slate-400">Fetching logs...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="mt-12 text-[10px] text-slate-400 text-center border-t border-slate-100 pt-4">
            <p>I certify that the work claimed herein has been completed in accordance with the contract.</p>
            <p class="mt-1 font-bold">Generated by CivilMate Construction Management System</p>
        </div>

    </div>

    <div class="fixed bottom-6 right-6 no-print">
        <button onclick="window.print()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-xl flex items-center gap-2 transform transition hover:scale-105">
            <i class="fas fa-check-circle"></i> Approve & Generate PDF
        </button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pid = localStorage.getItem('civilmate_current_project_id');
        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }

        // VARIABLES GLOBALES
        let scheduleData = [];
        let executionMap = {}; // Aquí guardaremos la suma de lo ejecutado por item

        // INICIAR
        init();

        async function init() {
            document.getElementById('claimDate').innerText = new Date().toLocaleDateString('en-NZ');
            
            // 1. PRIMERO: Analizar los Logs para sumar cantidades (EL CEREBRO NUEVO)
            await analyzeLogs();

            // 2. SEGUNDO: Cargar el Contrato y llenar la tabla con los datos analizados
            loadContractAndBuildTable();
        }

        function analyzeLogs() {
            return db.collection('site_logs').where('projectId', '==', pid).get().then(snap => {
                const logBody = document.getElementById('logsTable');
                logBody.innerHTML = "";
                
                if(snap.empty) { 
                    logBody.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-slate-400'>No site logs found. Starting at 0% progress.</td></tr>";
                    return;
                }

                let logs = [];
                snap.forEach(d => logs.push(d.data()));
                
                // Ordenar por fecha reciente
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                logs.forEach(log => {
                    // A. SUMAR AL MAPA DE EJECUCIÓN
                    // Normalizamos nombres (trim y uppercase) para evitar errores "Excavation" vs "excavation "
                    const key = (log.itemName || "").trim(); 
                    if(!executionMap[key]) executionMap[key] = 0;
                    
                    // Sumamos la cantidad reportada
                    executionMap[key] += (parseFloat(log.qty) || 0);

                    // B. AGREGAR A LA TABLA DE EVIDENCIA (Apéndice A)
                    logBody.innerHTML += `
                        <tr class="border-b border-slate-50 last:border-0">
                            <td class="p-2 font-bold text-slate-700">${log.date}</td>
                            <td class="p-2">${log.itemName}</td>
                            <td class="p-2 text-right font-mono font-bold text-blue-600">${log.qty} ${log.unit}</td>
                            <td class="p-2 italic text-slate-400">${log.notes || '-'}</td>
                        </tr>
                    `;
                });
            });
        }

        function loadContractAndBuildTable() {
            db.collection('projects').doc(pid).get().then(doc => {
                if(doc.exists) {
                    const p = doc.data();
                    document.getElementById('projName').innerText = p.name;
                    
                    const tbody = document.getElementById('linesTable');
                    tbody.innerHTML = "";
                    
                    // Buscar schedule o items
                    scheduleData = p.schedule || p.items || [];
                    
                    if(scheduleData.length > 0) {
                        scheduleData.forEach((item, index) => {
                            // Normalizar nombre para buscar en el mapa
                            const key = (item.desc || item.name || "").trim();
                            
                            // RECUPERAR LO EJECUTADO DESDE EL TRACKER
                            const executedQty = executionMap[key] || 0;
                            
                            // CALCULAR PORCENTAJE SUGERIDO
                            // (Ejecutado / Contratado) * 100
                            let suggestedPercent = 0;
                            if(item.qty > 0) {
                                suggestedPercent = (executedQty / item.qty) * 100;
                            }
                            
                            // Limitar visualmente a 2 decimales, pero permitir > 100% si hay sobre-ejecución
                            suggestedPercent = Math.round(suggestedPercent * 100) / 100;

                            tbody.innerHTML += `
                                <tr class="hover:bg-slate-50 transition">
                                    <td class="py-3 pl-2 font-bold text-slate-700">
                                        ${item.desc || item.name}
                                    </td>
                                    <td class="py-3 text-center text-slate-500">${item.unit}</td>
                                    <td class="py-3 text-center">${item.qty}</td>
                                    <td class="py-3 text-right font-mono">$${item.rate}</td>
                                    
                                    <td class="py-3 text-center font-bold text-blue-600 text-xs">
                                        ${executedQty} <span class="text-slate-400 font-normal">${item.unit}</span>
                                    </td>

                                    <td class="py-3 text-center bg-yellow-50 border-x border-yellow-100">
                                        <input type="number" min="0" step="1" value="${suggestedPercent}" 
                                            onchange="calcRow(this, ${item.qty}, ${item.rate})"
                                            class="w-16 text-center font-bold text-slate-900 text-lg border-b border-slate-300 focus:border-blue-500 outline-none bg-transparent"> %
                                    </td>
                                    
                                    <td class="py-3 text-right pr-2 font-bold font-mono text-slate-800 row-total">$0.00</td>
                                </tr>
                            `;
                            
                            // Calcular el valor inicial automáticamente al cargar
                            // Truco: Simulamos un evento para llenar los montos
                            setTimeout(() => {
                                const inputs = document.querySelectorAll('input[type="number"]');
                                const thisInput = inputs[inputs.length - 1]; // El último agregado
                                if(thisInput) calcRow(thisInput, item.qty, item.rate);
                            }, 100);
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-400">No Schedule of Rates found in contract.</td></tr>`;
                    }
                }
            });
        }

        // CALCULO EN TIEMPO REAL
        function calcRow(input, qty, rate) {
            const percent = parseFloat(input.value) || 0;
            const rowTotal = (qty * rate) * (percent / 100);
            
            // Actualizar celda de valor
            const row = input.closest('tr');
            row.querySelector('.row-total').innerText = fmtMoney(rowTotal);
            
            recalcTotal();
        }

        function recalcTotal() {
            let totalGross = 0;
            document.querySelectorAll('.row-total').forEach(cell => {
                const val = parseFloat(cell.innerText.replace('$','').replace(',','')) || 0;
                totalGross += val;
            });

            const retention = totalGross * 0.10; // 10% Retención
            const net = totalGross - retention;
            const gst = net * 0.15;
            const total = net + gst;

            document.getElementById('sumGross').innerText = fmtMoney(totalGross);
            document.getElementById('sumRet').innerText = "-" + fmtMoney(retention);
            document.getElementById('sumNet').innerText = fmtMoney(net);
            document.getElementById('sumGst').innerText = fmtMoney(gst);
            document.getElementById('sumTotal').innerText = fmtMoney(total);
        }

        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    </script>
</body>
</html>
