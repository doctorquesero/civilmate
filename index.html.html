<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civilmate - NZ Site Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .glass { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">üèóÔ∏è Civilmate</h1>
            <p class="text-gray-500 mb-6">NZ Site Management System</p>
            
            <div class="space-y-4">
                <button onclick="login('ENGINEER')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-3 transition transform hover:scale-105">
                    <i class="fas fa-hard-hat text-2xl"></i>
                    <div class="text-left">
                        <div class="text-sm opacity-80">Login as</div>
                        <div class="text-lg">Site Engineer</div>
                    </div>
                </button>
                
                <button onclick="login('MANAGER')" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-3 transition transform hover:scale-105">
                    <i class="fas fa-user-tie text-2xl"></i>
                    <div class="text-left">
                        <div class="text-sm opacity-80">Login as</div>
                        <div class="text-lg">Project Manager</div>
                    </div>
                </button>
            </div>
            <p class="mt-6 text-xs text-gray-400">Connected to: australia-southeast1</p>
        </div>
    </div>

    <div id="app" class="hidden min-h-screen p-4 lg:p-8">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 text-white p-3 rounded-lg"><i class="fas fa-building fa-lg"></i></div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Civilmate Dashboard</h1>
                    <p class="text-sm text-gray-500">Project: Auckland Central / <span id="userRoleDisplay" class="font-bold text-blue-600"></span></p>
                </div>
            </div>
            <button onclick="logout()" class="mt-4 md:mt-0 text-gray-500 hover:text-red-500 text-sm font-semibold">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="glass p-6 col-span-1 h-fit sticky top-4">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">1</span>
                    Add Activity
                </h2>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Trade Category (NZS)</label>
                    <select id="categorySelect" class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadActivities()">
                        <option value="">-- Select Category --</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Standard Item</label>
                    <select id="activitySelect" class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        <option>-- Select Category First --</option>
                    </select>
                </div>

                <button id="btnAddStandard" onclick="addStandardItem()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition mb-6 shadow-lg shadow-blue-200">
                    <i class="fas fa-plus"></i> Add to Tracker
                </button>

                <hr class="border-gray-100 my-6">

                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                    <h3 class="text-yellow-800 font-bold text-sm mb-2"><i class="fas fa-exclamation-triangle"></i> Variation Order</h3>
                    <p class="text-xs text-yellow-700 mb-3">Item not in NZ Standards? Request a custom variation. Requires approval.</p>
                    <input type="text" id="customInput" placeholder="Describe the work..." class="w-full p-2 border border-yellow-200 rounded mb-2 text-sm">
                    <button onclick="addVariation()" class="w-full bg-yellow-500 text-white py-2 rounded text-sm font-bold hover:bg-yellow-600">Request Approval</button>
                </div>
            </div>

            <div class="glass p-6 col-span-1 lg:col-span-2">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 w-8 h-8 flex items-center justify-center rounded-full text-sm">2</span>
                        Real-Time Progress
                    </h2>
                    <div id="syncStatus" class="text-xs text-green-500 font-mono"><i class="fas fa-wifi"></i> Live Sync Active</div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-xs text-gray-400 uppercase border-b border-gray-100">
                                <th class="pb-3 pl-2 w-1/3">Activity / NZS</th>
                                <th class="pb-3">Status</th>
                                <th class="pb-3 w-1/4">Progress</th>
                                <th class="pb-3 text-center">Photo</th>
                                <th class="pb-3 text-right pr-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trackerTable" class="text-sm">
                            <tr><td colspan="5" class="text-center py-10 text-gray-400">Loading data from Australia...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTAR FIREBASE (Desde CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. CONFIGURACI√ìN (Tus llaves de Civilmate)
        const firebaseConfig = {
            apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk",
            authDomain: "civilmate-933db.firebaseapp.com",
            projectId: "civilmate-933db",
            storageBucket: "civilmate-933db.firebasestorage.app",
            messagingSenderId: "679829297548",
            appId: "1:679829297548:web:42f9a5217314b787ed9ea9"
        };

        // 3. INICIALIZAR APP
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const activityCollection = collection(db, "activities");

        // 4. DATOS NZ STANDARDS
        const nzStandards = {
            "Earthworks (NZS 4402)": ["Site Clearing", "Cut to Waste", "Imported Hardfill", "Compaction Testing"],
            "Concrete (NZS 3109)": ["Foundations Prep", "Rebar (NZS 3101)", "Boxing / Formwork", "Pouring (25MPa)", "Curing"],
            "Drainage (NZS 4452)": ["Trenching", "Pipe Laying (PVC)", "Bedding", "Backfilling", "CCTV Inspection"],
            "Roading (NZS 4404)": ["Sub-grade Prep", "Basecourse", "Kerb & Channel", "Asphalt Laying"],
            "Health & Safety": ["Site Fencing", "Signage Check", "Toolbox Meeting", "Hazard ID"]
        };

        // VARIABLES GLOBALES
        let currentUserRole = ""; 
        window.userRole = ""; // Para acceso global simple

        // ------------------------------------------
        // FUNCIONES DE INTERFAZ (UI)
        // ------------------------------------------

        // Llenar Dropdowns
        const catSelect = document.getElementById('categorySelect');
        Object.keys(nzStandards).forEach(cat => {
            let opt = document.createElement('option');
            opt.value = cat; opt.innerText = cat;
            catSelect.appendChild(opt);
        });

        window.loadActivities = () => {
            const cat = catSelect.value;
            const actSelect = document.getElementById('activitySelect');
            actSelect.innerHTML = "";
            
            if(cat && nzStandards[cat]){
                nzStandards[cat].forEach(a => {
                    let opt = document.createElement('option');
                    opt.value = a; opt.innerText = a;
                    actSelect.appendChild(opt);
                });
                actSelect.disabled = false;
            } else {
                actSelect.disabled = true;
                actSelect.innerHTML = "<option>-- Select Category First --</option>";
            }
        };

        // Login / Logout
        window.login = (role) => {
            currentUserRole = role;
            window.userRole = role; // Hack para acceder desde funciones on-click HTML
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('userRoleDisplay').innerText = role === 'MANAGER' ? 'Project Manager' : 'Site Engineer';
            
            // Renderizar de nuevo para actualizar permisos de botones
            renderTableFromCache(); 
        };

        window.logout = () => {
            location.reload();
        };

        // ------------------------------------------
        // FUNCIONES DE BASE DE DATOS (FIREBASE)
        // ------------------------------------------

        // A. ESCUCHAR CAMBIOS EN TIEMPO REAL (El coraz√≥n del sistema)
        let localData = [];
        const q = query(activityCollection, orderBy("createdAt", "desc"));
        
        onSnapshot(q, (snapshot) => {
            localData = [];
            snapshot.docs.forEach(doc => {
                localData.push({ ...doc.data(), id: doc.id });
            });
            renderTableFromCache();
        }, (error) => {
            console.error("Error connecting to Firebase:", error);
            alert("Error connecting to database. Check console.");
        });

        // B. AGREGAR ITEM ESTANDAR
        window.addStandardItem = async () => {
            const cat = document.getElementById('categorySelect').value;
            const name = document.getElementById('activitySelect').value;
            
            if(!cat || !name) return alert("Please select a category and item.");

            const btn = document.getElementById('btnAddStandard');
            btn.innerHTML = '<div class="loader mx-auto"></div>'; // Loading spinner

            try {
                await addDoc(activityCollection, {
                    category: cat,
                    name: name,
                    status: "Approved", // Est√°ndares son aprobados por defecto
                    progress: 0,
                    photo: null,
                    createdAt: Date.now()
                });
                // Reset UI
                document.getElementById('categorySelect').value = "";
                loadActivities();
            } catch (e) {
                alert("Error saving: " + e.message);
            }
            btn.innerHTML = '<i class="fas fa-plus"></i> Add to Tracker';
        };

        // C. AGREGAR VARIACION
        window.addVariation = async () => {
            const input = document.getElementById('customInput');
            const val = input.value.trim();
            if(!val) return alert("Please describe the variation.");

            try {
                await addDoc(activityCollection, {
                    category: "Variation / Custom",
                    name: val,
                    status: "Pending", // Variaciones requieren aprobaci√≥n
                    progress: 0,
                    photo: null,
                    createdAt: Date.now()
                });
                input.value = "";
                alert("Variation requested successfully.");
            } catch(e) {
                console.error(e);
            }
        };

        // D. ACTUALIZAR PROGRESO
        window.updateProgress = async (id, val) => {
            const docRef = doc(db, "activities", id);
            await updateDoc(docRef, { progress: parseInt(val) });
        };

        // E. APROBAR (Solo Manager)
        window.approveItem = async (id) => {
            const docRef = doc(db, "activities", id);
            await updateDoc(docRef, { status: "Approved" });
        };

        // F. BORRAR (Solo Manager)
        window.deleteItem = async (id) => {
            if(confirm("Are you sure?")) {
                await deleteDoc(doc(db, "activities", id));
            }
        };

        // G. SUBIR FOTO (Base64)
        window.uploadPhoto = (id, fileInput) => {
            const file = fileInput.files[0];
            if(!file) return;

            // L√≠mite de tama√±o (500KB para no saturar Firestore en versi√≥n gratis)
            if(file.size > 500000) return alert("Photo too large! Please use a smaller image (<500KB) for this prototype.");

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64String = e.target.result;
                const docRef = doc(db, "activities", id);
                await updateDoc(docRef, { photo: base64String });
            };
            reader.readAsDataURL(file);
        };

        // ------------------------------------------
        // RENDERIZADO DE TABLA
        // ------------------------------------------
        function renderTableFromCache() {
            const tbody = document.getElementById('trackerTable');
            tbody.innerHTML = "";

            if(localData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-400">No activities yet. Start by adding one!</td></tr>`;
                return;
            }

            localData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-gray-50 transition";
                
                // Badge Logic
                let badgeClass = item.status === "Approved" ? "bg-green-100 text-green-700 border-green-200" : "bg-yellow-100 text-yellow-700 border-yellow-200";
                let statusIcon = item.status === "Approved" ? "check-circle" : "clock";
                
                // Disable controls if Pending
                let isPending = item.status === "Pending";
                let isDisabled = isPending ? "disabled class='opacity-50 cursor-not-allowed'" : "";

                // Photo Logic
                let photoHtml = item.photo 
                    ? `<div class="relative group w-12 h-12 mx-auto">
                        <img src="${item.photo}" class="w-12 h-12 rounded object-cover border cursor-pointer shadow-sm" onclick="window.open('${item.photo}')">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition"></div>
                       </div>`
                    : `<label class="cursor-pointer text-gray-400 hover:text-blue-500 flex flex-col items-center text-xs">
                        <i class="fas fa-camera fa-lg mb-1"></i>
                        <input type="file" accept="image/*" class="hidden" onchange="window.uploadPhoto('${item.id}', this)">
                       </label>`;

                // Manager Actions
                let actionsHtml = "";
                if(currentUserRole === 'MANAGER') {
                    if(isPending) actionsHtml += `<button onclick="approveItem('${item.id}')" class="text-green-600 hover:text-green-800 mr-3 text-xs font-bold border border-green-200 bg-green-50 px-2 py-1 rounded">APPROVE</button>`;
                    actionsHtml += `<button onclick="deleteItem('${item.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>`;
                } else {
                    if(isPending) actionsHtml = `<span class="text-xs text-yellow-500 italic">Waiting approval</span>`;
                }

                tr.innerHTML = `
                    <td class="py-4 pl-2">
                        <div class="font-bold text-slate-700">${item.name}</div>
                        <div class="text-xs text-gray-400">${item.category}</div>
                    </td>
                    <td class="py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold border ${badgeClass} flex w-fit items-center gap-1">
                            <i class="fas fa-${statusIcon}"></i> ${item.status}
                        </span>
                    </td>
                    <td class="py-4">
                        <div class="flex items-center gap-2">
                            <input type="range" min="0" max="100" value="${item.progress}" 
                                class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" 
                                ${isDisabled}
                                onchange="window.updateProgress('${item.id}', this.value)"
                                oninput="this.nextElementSibling.value = this.value + '%'">
                            <output class="text-xs font-bold w-8 text-right">${item.progress}%</output>
                        </div>
                    </td>
                    <td class="py-4 text-center">${photoHtml}</td>
                    <td class="py-4 text-right pr-2">${actionsHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>