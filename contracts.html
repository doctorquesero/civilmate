<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contracts & Pricing - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; color: #334155; }
        /* Títulos de secciones */
        .section-title { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #e2e8f0; }
        .col-lab { color: #d97706; border-color: #d97706; } /* Amber */
        .col-plant { color: #16a34a; border-color: #16a34a; } /* Green */
        .col-mat { color: #2563eb; border-color: #2563eb; } /* Blue */
    </style>
</head>
<body class="p-2 md:p-6 max-w-[1400px] mx-auto">

    <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">CivilMate Estimator Pro</h1>
            <p class="text-xs text-slate-500">Structured APU Builder (Labor / Plant / Materials)</p>
        </div>
        <div class="flex gap-3">
             <a href="index.html" class="text-slate-400 hover:text-slate-600 px-2"><i class="fas fa-times text-xl"></i></a>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
        
        <div class="lg:col-span-7 space-y-4">
            
            <div class="bg-white p-4 rounded-xl shadow border border-slate-200 flex gap-4 items-center">
                <div class="flex-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Load Standard Item</label>
                    <select id="disciplineSelect" onchange="loadKits()" class="w-full p-2 bg-slate-50 border rounded text-sm font-bold text-slate-700 outline-none focus:border-blue-500 cursor-pointer">
                        <option value="">-- Select Category --</option>
                    </select>
                </div>
                <div class="flex-1">
                     <label class="text-[10px] font-bold text-slate-400 uppercase">Activity</label>
                    <select id="kitSelect" onchange="loadKitDetails()" class="w-full p-2 bg-slate-50 border rounded text-sm font-bold text-slate-700 outline-none focus:border-blue-500 cursor-pointer" disabled>
                        <option>-- Select Category First --</option>
                    </select>
                </div>
                <div>
                     <label class="text-[10px] font-bold text-transparent uppercase">.</label>
                    <button onclick="createNewItem()" class="text-xs bg-slate-800 text-white px-3 py-2.5 rounded font-bold hover:bg-black transition">New Empty</button>
                </div>
            </div>

            <div id="builderArea" class="hidden bg-white p-5 rounded-xl shadow border-t-4 border-blue-600 flex flex-col gap-4">
                
                <div class="flex gap-3 bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Item Description</label>
                        <input type="text" id="itemName" class="w-full bg-transparent font-bold text-lg text-slate-800 border-b border-slate-300 focus:border-blue-500 outline-none" value="...">
                    </div>
                    <div class="w-20">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Unit</label>
                        <input type="text" id="itemUnit" class="w-full bg-transparent text-center font-bold text-slate-600 border-b border-slate-300 focus:border-blue-500 outline-none" value="m">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <div class="bg-orange-50/50 p-3 rounded-lg border border-orange-100">
                        <div class="flex justify-between items-center section-title col-lab">
                            <span class="text-orange-700">Labor (Mano de Obra)</span>
                            <button onclick="addRes('Lab')" class="text-orange-600 hover:text-orange-800 text-xs"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="listLab" class="space-y-2 min-h-[50px]"></div>
                    </div>

                    <div class="bg-green-50/50 p-3 rounded-lg border border-green-100">
                        <div class="flex justify-between items-center section-title col-plant">
                            <span class="text-green-700">Plant (Equipos)</span>
                            <button onclick="addRes('Plant')" class="text-green-600 hover:text-green-800 text-xs"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="listPlant" class="space-y-2 min-h-[50px]"></div>
                    </div>

                    <div class="bg-blue-50/50 p-3 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-center section-title col-mat">
                            <span class="text-blue-700">Materials</span>
                            <button onclick="addRes('Mat')" class="text-blue-600 hover:text-blue-800 text-xs"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="listMat" class="space-y-2 min-h-[50px]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 items-center pt-4 border-t border-slate-100">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Overheads & Profit (Margin)</label>
                        <div class="flex items-center w-32">
                            <input type="number" id="marginInput" value="15" onchange="updateCalculations()" class="w-full p-2 border border-r-0 rounded-l font-bold text-center bg-white text-sm focus:outline-none focus:ring-1 ring-blue-500">
                            <div class="bg-slate-100 text-slate-500 p-2 border rounded-r text-xs font-bold">%</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400">Direct Cost: <span id="rawCostDisplay" class="font-mono">$0.00</span></p>
                        <p class="text-sm text-slate-500 font-bold">Unit Price: <span id="finalRateDisplay" class="text-2xl text-blue-700">$0.00</span></p>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <div class="w-1/3">
                        <input type="number" id="qtyInput" class="w-full p-3 border-2 border-slate-200 rounded-lg font-bold text-center focus:border-blue-500 outline-none" placeholder="Total Qty">
                    </div>
                    <button onclick="addToQuote()" class="w-2/3 bg-slate-800 text-white font-bold rounded-lg shadow hover:bg-slate-900 transition flex items-center justify-center gap-2">
                        Add to Budget <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

            </div>
        </div>

        <div class="lg:col-span-5 flex flex-col h-full sticky top-4">
            <div class="bg-white p-5 rounded-xl shadow border border-slate-200 flex-1 flex flex-col h-[600px]">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h2 class="font-bold text-lg text-slate-800">Project Estimate</h2>
                    <span class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded font-bold uppercase">Draft Mode</span>
                </div>

                <div class="flex-1 overflow-y-auto mb-4 bg-slate-50 rounded border border-slate-200">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 text-slate-500 font-bold uppercase text-[10px] sticky top-0 z-10">
                            <tr>
                                <th class="p-2">Description</th>
                                <th class="p-2 text-center">Qty</th>
                                <th class="p-2 text-right">Amount</th>
                                <th class="p-2"></th>
                            </tr>
                        </thead>
                        <tbody id="quoteTable">
                            <tr><td colspan="4" class="p-8 text-center text-slate-400 italic text-xs">No items yet.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="space-y-1 pt-2 border-t">
                    <div class="flex justify-between text-sm text-slate-500"><span>Direct Cost (Subtotal)</span><span id="subtotalDisplay">$0.00</span></div>
                    <div class="flex justify-between text-sm text-slate-500"><span>GST (15%)</span><span id="gstDisplay">$0.00</span></div>
                    <div class="flex justify-between text-xl font-bold text-slate-800 pt-2 border-t mt-2"><span>TOTAL (Inc GST)</span><span id="totalDisplay">$0.00</span></div>
                </div>

                <button onclick="saveProject()" class="mt-4 w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition shadow">
                    <i class="fas fa-save mr-2"></i> Save Contract
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk",
            authDomain: "civilmate-933db.firebaseapp.com",
            projectId: "civilmate-933db",
            storageBucket: "civilmate-933db.firebasestorage.app",
            messagingSenderId: "679829297548",
            appId: "1:679829297548:web:42f9a5217314b787ed9ea9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DB ACTUALIZADA (Separada por Tipo) ---
        // t: 'Lab' | 'Plant' | 'Mat'
        // q: Quantity per unit (Rendimiento inverso: 0.5 = 2 unidades por dia si es jornal)
        const standardDB = {
            "Earthworks": [
                { 
                    name: "Bulk Excavation", unit: "m3", 
                    resources: [
                        {n: "Excavator 20T", t:"Plant", c:45, q:0.1}, // 0.1 hr/m3
                        {n: "Operator", t:"Lab", c:35, q:0.1}, 
                        {n: "Tip Fees", t:"Mat", c:25, q:1}
                    ] 
                },
                { 
                    name: "Trenching < 1.5m", unit: "m", 
                    resources: [
                        {n: "Excavator 5T", t:"Plant", c:35, q:0.2}, 
                        {n: "Drainlayer", t:"Lab", c:45, q:0.2},
                        {n: "Laborer", t:"Lab", c:28, q:0.2}
                    ] 
                }
            ],
            "Concrete": [
                { 
                    name: "Footing 20MPa", unit: "m3", 
                    resources: [
                        {n: "Concrete 20MPa", t:"Mat", c:260, q:1.05}, // 5% waste
                        {n: "Line Pump", t:"Plant", c:40, q:1},
                        {n: "Leading Hand", t:"Lab", c:45, q:2}, // 2 hrs labor per m3
                        {n: "Laborer", t:"Lab", c:30, q:2}
                    ] 
                }
            ],
             "Drainage": [
                { 
                    name: "100mm PVC Pipe", unit: "m", 
                    resources: [
                        {n: "PVC Pipe 100mm", t:"Mat", c:15, q:1}, 
                        {n: "Bedding GAP7", t:"Mat", c:12, q:0.1},
                        {n: "Drainlayer", t:"Lab", c:55, q:0.5},
                        {n: "Laborer", t:"Lab", c:28, q:0.5}
                    ] 
                }
            ]
        };

        let currentResources = [];
        let quoteItems = [];

        // INIT
        const discSelect = document.getElementById('disciplineSelect');
        Object.keys(standardDB).forEach(d => discSelect.innerHTML += `<option value="${d}">${d}</option>`);

        function loadKits() {
            const d = discSelect.value;
            const k = document.getElementById('kitSelect');
            k.innerHTML = '<option>-- Select Item --</option>';
            k.disabled = !d;
            if(d) standardDB[d].forEach((item, i) => k.innerHTML += `<option value="${d}|${i}">${item.name}</option>`);
        }

        function loadKitDetails() {
            const val = document.getElementById('kitSelect').value;
            if(!val.includes("|")) return;
            const [d, i] = val.split("|");
            const item = standardDB[d][i];

            document.getElementById('builderArea').classList.remove('hidden');
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemUnit').value = item.unit;
            
            currentResources = JSON.parse(JSON.stringify(item.resources));
            renderAllLists();
            updateCalculations();
        }

        function createNewItem() {
            document.getElementById('builderArea').classList.remove('hidden');
            document.getElementById('itemName').value = "New Item";
            document.getElementById('itemUnit').value = "ea";
            currentResources = [];
            document.getElementById('kitSelect').value = "";
            renderAllLists();
            updateCalculations();
        }

        // --- SISTEMA ORGANIZADO DE RECURSOS ---
        function renderAllLists() {
            renderList('Lab', 'listLab');
            renderList('Plant', 'listPlant');
            renderList('Mat', 'listMat');
        }

        function renderList(type, elementId) {
            const list = document.getElementById(elementId);
            list.innerHTML = "";
            
            // Filtrar recursos por tipo
            currentResources.forEach((res, idx) => {
                if(res.t !== type) return;

                // Input de "Rate ($)" y "Qty (Und/hr)"
                // Lulowin: Rendimiento = 1/Qty
                
                list.innerHTML += `
                    <div class="flex items-center gap-1 mb-1 text-xs">
                        <input type="text" value="${res.n}" onchange="updateRes(${idx}, 'n', this.value)" class="flex-1 bg-transparent border-b border-dotted border-slate-300 focus:border-blue-500 outline-none pb-1 font-medium" placeholder="Name">
                        
                        <div class="flex flex-col w-12 text-right">
                            <span class="text-[8px] text-slate-400">Rate</span>
                            <input type="number" value="${res.c}" onchange="updateRes(${idx}, 'c', this.value)" class="w-full bg-white/50 text-right border rounded px-1">
                        </div>
                        <div class="flex flex-col w-10 text-right">
                            <span class="text-[8px] text-slate-400">Qty</span>
                            <input type="number" value="${res.q}" onchange="updateRes(${idx}, 'q', this.value)" class="w-full bg-white/50 text-right border rounded px-1">
                        </div>
                        <button onclick="removeRes(${idx})" class="text-red-300 hover:text-red-500 ml-1"><i class="fas fa-times"></i></button>
                    </div>
                `;
            });
        }

        function addRes(type) {
            currentResources.push({n: "New " + type, t: type, c: 0, q: 1});
            renderAllLists();
        }

        window.removeRes = (i) => { currentResources.splice(i, 1); renderAllLists(); updateCalculations(); };
        window.updateRes = (i, field, val) => { 
            currentResources[i][field] = field === 'n' ? val : (parseFloat(val) || 0); 
            updateCalculations(); 
        };

        function updateCalculations() {
            let rawCost = 0;
            // Costo = Rate * Qty (Ej: $35/hr * 0.5hr = $17.5)
            currentResources.forEach(r => rawCost += (r.c * r.q));
            
            const margin = parseFloat(document.getElementById('marginInput').value) || 0;
            const finalRate = rawCost * (1 + (margin/100));

            document.getElementById('rawCostDisplay').innerText = "$" + rawCost.toFixed(2);
            document.getElementById('finalRateDisplay').innerText = "$" + finalRate.toFixed(2);
            return finalRate;
        }

        // --- COTIZACIÓN ---
        function addToQuote() {
            const qty = parseFloat(document.getElementById('qtyInput').value);
            if(!qty) return alert("Enter Quantity");
            const rate = updateCalculations();
            
            quoteItems.push({
                name: document.getElementById('itemName').value,
                unit: document.getElementById('itemUnit').value,
                qty: qty,
                rate: rate,
                total: qty * rate,
                resources: JSON.parse(JSON.stringify(currentResources))
            });
            renderQuote();
            document.getElementById('qtyInput').value = "";
        }

        function renderQuote() {
            const tbody = document.getElementById('quoteTable');
            tbody.innerHTML = "";
            let sub = 0;
            quoteItems.forEach((item, i) => {
                sub += item.total;
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-100">
                        <td class="p-2">
                            <div class="font-bold text-xs text-slate-700">${item.name}</div>
                            <div class="text-[10px] text-slate-400">$${item.rate.toFixed(2)} / ${item.unit}</div>
                        </td>
                        <td class="p-2 text-center text-xs font-bold">${item.qty}</td>
                        <td class="p-2 text-right text-xs font-mono">$${item.total.toFixed(2)}</td>
                        <td class="p-2 text-right"><button onclick="removeQuoteItem(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
            document.getElementById('subtotalDisplay').innerText = "$" + sub.toFixed(2);
            document.getElementById('gstDisplay').innerText = "$" + (sub*0.15).toFixed(2);
            document.getElementById('totalDisplay').innerText = "$" + (sub*1.15).toFixed(2);
        }

        window.removeQuoteItem = (i) => { quoteItems.splice(i, 1); renderQuote(); };

        function saveProject() {
            if(quoteItems.length === 0) return alert("Empty Quote");
            const btn = document.querySelector('button[onclick="saveProject()"]');
            btn.innerHTML = "Saving...";
            db.collection('projects').add({
                name: "Project " + new Date().toLocaleTimeString(),
                total: parseFloat(document.getElementById('totalDisplay').innerText.replace('$','')),
                items: quoteItems,
                status: "Pending",
                createdAt: Date.now()
            }).then(() => { alert("Saved!"); window.location.href="index.html"; });
        }
    </script>
</body>
</html>
