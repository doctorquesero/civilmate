<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estimator Pro - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; color: #334155; }
        
        /* ALINEACIÓN DE TABLAS */
        .col-desc { width: 45%; }
        .col-unit { width: 15%; text-align: center; }
        .col-qty  { width: 15%; text-align: right; }
        .col-rate { width: 15%; text-align: right; }
        .col-total { width: 10%; text-align: right; }
        
        .res-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .res-table th { 
            font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; 
            padding: 6px 4px; text-align: right; border-bottom: 2px solid #e2e8f0; 
        }
        .res-table th.text-left { text-align: left; }
        .res-table th.text-center { text-align: center; }
        .res-table td { padding: 4px; border-bottom: 1px dashed #f1f5f9; vertical-align: middle; }
        
        .res-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 4px; font-size: 11px; padding: 2px 4px; transition: all 0.2s; }
        .res-input:hover { background-color: #f8fafc; border-color: #e2e8f0; }
        .res-input:focus { background-color: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        /* CORRECCIÓN: Input de Cantidad Ajustado */
        .quote-qty-input { 
            background: #f0f9ff; 
            border: 1px solid #bae6fd; 
            color: #0369a1; 
            font-weight: bold; 
            text-align: center; 
            border-radius: 4px; 
            width: 100%; 
            font-size: 11px; 
            padding: 2px 0; /* Reducido para evitar corte */
            height: 24px;   /* Altura fija para estabilidad */
        }
        
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .company-input { text-align: right; background: transparent; border: 1px dashed transparent; width: 100%; outline: none; transition: 0.2s; cursor: pointer; }
        .company-input:hover, .company-input:focus { border-color: #cbd5e1; background: #fffbeb; }

        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
            .no-print { display: none !important; }
            input { border: none !important; background: transparent !important; padding: 0 !important; }
            .quote-qty-input { background: transparent !important; border: none !important; text-align: center; }
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative">

    <header class="bg-white border-b border-slate-200 p-3 flex justify-between items-center shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center font-bold text-lg"><i class="fas fa-layer-group"></i></div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-none">CivilMate</h1>
                <p class="text-[10px] text-slate-500">Estimator V4.2 (Pro Data + UI Fix)</p>
            </div>
        </div>
        
        <div class="flex gap-2 items-center">
            <input type="file" id="importFile" class="hidden" accept=".csv" onchange="handleCSVImport(this)">
            
            <div class="bg-slate-50 p-1 rounded-lg border border-slate-200 flex gap-1 mr-4">
                <button onclick="downloadCSVTemplate()" class="px-3 py-1 text-[10px] font-bold text-slate-500 hover:text-blue-600 hover:bg-white rounded transition flex items-center gap-1" title="Download Excel Template">
                    <i class="fas fa-file-csv text-green-600"></i> Template
                </button>
                <div class="w-px bg-slate-300 my-1"></div>
                <button onclick="document.getElementById('importFile').click()" class="px-3 py-1 text-[10px] font-bold text-slate-700 hover:bg-white rounded transition flex items-center gap-1" title="Append to current DB">
                    <i class="fas fa-upload text-blue-600"></i> Import
                </button>
                <div class="w-px bg-slate-300 my-1"></div>
                <button onclick="openDBManager()" class="px-3 py-1 text-[10px] font-bold text-slate-700 hover:bg-white rounded transition flex items-center gap-1" title="Manage & Clear DB">
                    <i class="fas fa-database text-slate-500"></i> Manage DB
                </button>
            </div>

            <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-100 rounded border">
                <i class="fas fa-arrow-left mr-1"></i> Dashboard
            </button>
            <button onclick="saveProject()" class="px-4 py-2 text-xs font-bold bg-green-600 hover:bg-green-700 text-white rounded shadow flex items-center gap-2">
                <i class="fas fa-save"></i> Save Contract
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-7/12 flex flex-col border-r border-slate-200 bg-white overflow-y-auto relative z-10 shadow-[4px_0_24px_rgba(0,0,0,0.05)]">
            
            <div class="p-4 border-b border-slate-100 bg-slate-50/80 sticky top-0 z-20 backdrop-blur-md">
                <div class="flex gap-2">
                    <div class="w-1/3">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">1. Discipline</label>
                        <select id="disciplineSelect" onchange="loadKits()" class="w-full p-2 text-xs font-bold border rounded bg-white text-slate-700 focus:ring-2 ring-blue-500 outline-none cursor-pointer shadow-sm">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="w-1/3">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">2. Standard Item</label>
                        <select id="kitSelect" onchange="loadKitDetails()" class="w-full p-2 text-xs font-bold border rounded bg-white text-slate-700 focus:ring-2 ring-blue-500 outline-none cursor-pointer shadow-sm" disabled>
                            <option>-- Select Discipline --</option>
                        </select>
                    </div>
                    <div class="w-1/3 flex items-end">
                        <button onclick="createNewItem()" class="w-full py-2 bg-slate-800 text-white text-xs font-bold rounded hover:bg-slate-900 transition shadow-md flex justify-center items-center gap-2">
                            <i class="fas fa-plus"></i> Create Custom
                        </button>
                    </div>
                </div>
            </div>

            <div id="builderArea" class="hidden flex-1 flex flex-col p-6 pb-24">
                
                <div class="flex justify-center mb-6">
                    <div class="bg-slate-100 p-1 rounded-lg flex w-full max-w-sm shadow-inner border border-slate-200">
                        <button id="btnModeUnit" onclick="switchPricingMode('UNIT')" class="flex-1 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-blue-700 transition border border-transparent">
                            <i class="fas fa-ruler-combined mr-1"></i> Unit Rate
                        </button>
                        <button id="btnModeTime" onclick="switchPricingMode('TIME')" class="flex-1 py-1.5 text-xs font-bold rounded text-slate-400 hover:text-slate-600 transition border border-transparent">
                            <i class="fas fa-clock mr-1"></i> Hourly Rate
                        </button>
                    </div>
                </div>

                <div class="flex gap-4 mb-6 items-end">
                    <div class="flex-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Description</label>
                        <input type="text" id="itemName" class="w-full text-xl font-bold text-slate-800 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1 transition" placeholder="Item Name">
                    </div>
                    <div class="w-24 text-center">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Unit</label>
                        <input type="text" id="itemUnit" class="w-full text-center text-xl font-bold text-slate-600 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1 transition" placeholder="m3">
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="border border-orange-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-orange-50 px-3 py-2 flex justify-between items-center border-b border-orange-100">
                            <span class="text-[10px] font-bold text-orange-800 uppercase tracking-wider"><i class="fas fa-user-hard-hat mr-1"></i> Labor Cost</span>
                            <button onclick="addRes('Lab')" class="text-orange-600 hover:text-orange-900 text-xs font-bold bg-white px-2 py-0.5 rounded border border-orange-200 shadow-sm transition hover:shadow">+ Add</button>
                        </div>
                        <div class="bg-white">
                            <table class="res-table">
                                <thead>
                                    <tr>
                                        <th class="col-desc pl-3 text-left">Description</th>
                                        <th class="col-unit text-center">Unit</th>
                                        <th class="col-qty text-right">Yield</th>
                                        <th class="col-rate text-right">Cost/Unit</th>
                                        <th class="col-total text-right">Total</th>
                                        <th class="w-[5%]"></th>
                                    </tr>
                                </thead>
                                <tbody id="listLab"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="border border-green-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-green-50 px-3 py-2 flex justify-between items-center border-b border-green-100">
                            <span class="text-[10px] font-bold text-green-800 uppercase tracking-wider"><i class="fas fa-truck-monster mr-1"></i> Plant Cost</span>
                            <button onclick="addRes('Plant')" class="text-green-600 hover:text-green-900 text-xs font-bold bg-white px-2 py-0.5 rounded border border-green-200 shadow-sm transition hover:shadow">+ Add</button>
                        </div>
                        <div class="bg-white">
                            <table class="res-table">
                                <thead>
                                    <tr>
                                        <th class="col-desc pl-3 text-left">Description</th>
                                        <th class="col-unit text-center">Unit</th>
                                        <th class="col-qty text-right">Yield</th>
                                        <th class="col-rate text-right">Cost/Unit</th>
                                        <th class="col-total text-right">Total</th>
                                        <th class="w-[5%]"></th>
                                    </tr>
                                </thead>
                                <tbody id="listPlant"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="border border-blue-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-blue-50 px-3 py-2 flex justify-between items-center border-b border-blue-100">
                            <span class="text-[10px] font-bold text-blue-800 uppercase tracking-wider"><i class="fas fa-cubes mr-1"></i> Material Cost</span>
                            <button onclick="addRes('Mat')" class="text-blue-600 hover:text-blue-900 text-xs font-bold bg-white px-2 py-0.5 rounded border border-blue-200 shadow-sm transition hover:shadow">+ Add</button>
                        </div>
                        <div class="bg-white">
                            <table class="res-table">
                                <thead>
                                    <tr>
                                        <th class="col-desc pl-3 text-left">Description</th>
                                        <th class="col-unit text-center">Unit</th>
                                        <th class="col-qty text-right">Qty</th>
                                        <th class="col-rate text-right">Cost/Unit</th>
                                        <th class="col-total text-right">Total</th>
                                        <th class="w-[5%]"></th>
                                    </tr>
                                </thead>
                                <tbody id="listMat"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="absolute bottom-0 left-0 w-full bg-slate-900 text-white p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.2)] z-30">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex gap-8 text-xs">
                            <div>
                                <span class="block text-slate-400 font-bold uppercase text-[9px] mb-1">Base Cost</span>
                                <span class="font-mono text-slate-200 text-xl font-bold" id="rawCostDisplay">$0.00</span>
                            </div>
                            <div>
                                <span class="block text-yellow-500 font-bold uppercase text-[9px] mb-1">Margin %</span>
                                <div class="flex items-center gap-1">
                                    <input type="number" id="marginInput" value="18" onchange="updateCalculations()" class="w-12 bg-slate-800 border border-slate-600 rounded px-1 py-0.5 font-bold text-center outline-none text-yellow-400 focus:border-yellow-400 transition">
                                </div>
                            </div>
                            <div>
                                <span class="block text-green-400 font-bold uppercase text-[9px] mb-1">Unit Rate</span>
                                <span class="font-mono text-green-400 text-3xl font-bold leading-none" id="finalRateDisplay">$0.00</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-3">
                            <button onclick="saveToLibrary()" class="text-slate-400 hover:text-white px-3 py-2 rounded font-bold border border-slate-700 hover:border-slate-500 transition text-xs" title="Save this analysis to local DB">
                                <i class="fas fa-save mr-1"></i> Save to DB
                            </button>

                            <div class="bg-slate-800 p-1 rounded border border-slate-700 flex items-center px-3">
                                <label class="text-[9px] font-bold text-slate-400 uppercase mr-2">Qty:</label>
                                <input type="number" id="qtyInput" class="w-20 bg-transparent font-bold text-center outline-none text-white text-lg" placeholder="1">
                            </div>
                            <button onclick="addToQuote()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded font-bold shadow-lg shadow-blue-900/50 transition flex items-center gap-2">
                                <i class="fas fa-arrow-right"></i> Add to Quote
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="w-5/12 bg-slate-100 flex flex-col overflow-y-auto" id="printSection">
            
            <div class="bg-white min-h-[29.7cm] w-full max-w-[21cm] mx-auto my-8 shadow-2xl p-12 flex flex-col relative" id="a4Page">
                
                <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
                    <div>
                        <h2 class="text-4xl font-bold text-slate-800 uppercase tracking-widest">Quotation</h2>
                        <p class="text-sm text-slate-500 font-medium mt-1">Ref: <span id="quoteRefDisplay">#2024-001</span></p>
                    </div>
                    <div class="w-1/2 text-right">
                        <input type="text" value="My Construction Co." class="company-input font-bold text-xl text-slate-800">
                        <input type="text" value="123 Builder Lane, Auckland" class="company-input text-xs text-slate-500">
                        <input type="text" value="Ph: 0800 123 456" class="company-input text-xs text-slate-500">
                        <input type="text" value="www.civilmate.nz" class="company-input text-xs text-blue-500">
                    </div>
                </div>

                <div class="bg-yellow-50/50 border border-yellow-100 rounded-lg p-5 mb-8 grid grid-cols-2 gap-8 no-print-bg">
                    <div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Prepared For (Client)</p>
                        <input type="text" id="clientName" class="w-full font-bold text-lg text-slate-800 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none placeholder-slate-400 mb-1" placeholder="Enter Client Name">
                        <input type="text" id="clientAddress" class="w-full text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none mb-1 placeholder-slate-400" placeholder="Enter Address">
                        <div class="flex gap-2">
                             <input type="text" id="clientEmail" class="w-1/2 text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none placeholder-slate-400" placeholder="Email">
                             <input type="text" id="clientPhone" class="w-1/2 text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none placeholder-slate-400" placeholder="Phone">
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Date</p>
                        <p class="font-bold text-slate-700 text-sm" id="currentDate">...</p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-3 mb-1">Valid Until</p>
                        <p class="text-sm text-slate-700">30 Days</p>
                    </div>
                </div>

                <table class="w-full text-left mb-6 text-sm border-collapse">
                    <thead class="bg-slate-100 text-slate-600 font-bold uppercase text-[9px]">
                        <tr>
                            <th class="p-3 w-5/12 text-left">Description</th>
                            <th class="p-3 text-center w-1/12">Unit</th>
                            <th class="p-3 text-center w-1/12">Qty</th>
                            <th class="p-3 text-right w-2/12">Rate</th>
                            <th class="p-3 text-right w-2/12">Amount</th>
                            <th class="p-3 w-1/12 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="quoteTable" class="text-slate-700">
                        <tr><td colspan="6" class="p-10 text-center text-slate-300 italic text-xs border-b border-slate-100">No items added.</td></tr>
                    </tbody>
                </table>

                <div class="flex justify-end mt-auto mb-10">
                    <div class="w-1/2 space-y-2">
                        <div class="flex justify-between text-xs text-slate-500">
                            <span>Subtotal (Ex GST)</span>
                            <span id="subtotalDisplay" class="font-mono">$0.00</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500 border-b border-slate-200 pb-2">
                            <span>GST (15%)</span>
                            <span id="gstDisplay" class="font-mono">$0.00</span>
                        </div>
                        <div class="flex justify-between text-2xl font-bold text-slate-800 pt-2">
                            <span>TOTAL (NZD)</span>
                            <span id="totalDisplay" class="font-mono">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="border-t-2 border-slate-100 pt-6 text-[10px] text-slate-400">
                    <p class="font-bold uppercase mb-2 text-slate-500">Terms & Conditions</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li>This quotation is based on the NZS 3910 conditions of contract.</li>
                        <li>Acceptance of this quote indicates acceptance of our standard terms of trade.</li>
                        <li>Prices are valid for 30 days from the date of this quotation.</li>
                    </ul>
                </div>
            </div>
            
            <div class="fixed bottom-8 right-8 no-print z-50">
                <button onclick="printQuote()" class="bg-slate-800 hover:bg-black text-white px-6 py-4 rounded-full shadow-2xl font-bold flex items-center gap-3 transition transform hover:-translate-y-1">
                    <i class="fas fa-print text-xl"></i> <span>Download PDF</span>
                </button>
            </div>

        </div>
    </div>

    <div id="dbModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg">Database Manager</h3>
                    <p class="text-xs text-slate-500">Total Items: <span id="dbCount" class="font-bold">0</span></p>
                </div>
                <button onclick="document.getElementById('dbModal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-500 transition"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-3 bg-white border-b border-slate-100 flex justify-between items-center">
                <p class="text-xs text-slate-400 italic">Manage your items below. Changes are saved to memory.</p>
                <button onclick="clearAllData()" class="px-4 py-2 bg-red-50 text-red-600 hover:bg-red-600 hover:text-white border border-red-200 rounded text-xs font-bold transition flex items-center gap-2">
                    <i class="fas fa-trash-alt"></i> Delete All Data
                </button>
            </div>

            <div class="overflow-y-auto p-0 flex-1 bg-slate-50">
                <table class="w-full text-sm">
                    <thead class="text-[10px] uppercase bg-slate-100 text-slate-500 font-bold sticky top-0 shadow-sm">
                        <tr>
                            <th class="p-3 text-left w-1/4">Discipline</th>
                            <th class="p-3 text-left w-1/3">Item Name</th>
                            <th class="p-3 text-center w-1/6">Unit</th>
                            <th class="p-3 text-right w-1/6">Resources</th>
                            <th class="p-3 text-center w-1/12">Action</th>
                        </tr>
                    </thead>
                    <tbody id="dbTableBody" class="bg-white divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk",
            authDomain: "civilmate-933db.firebaseapp.com",
            projectId: "civilmate-933db",
            storageBucket: "civilmate-933db.firebasestorage.app",
            messagingSenderId: "679829297548",
            appId: "1:679829297548:web:42f9a5217314b787ed9ea9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-NZ');

        // DATABASE (With CDS Standard)
        let standardDB = {
            "Earthworks": [
                { name: "Bulk Excavation", unit: "m3", resources: [
                    {n:"Excavator 20T", u:"hr", q:0.05, c:140, t:"Plant"}, 
                    {n:"Operator", u:"hr", q:0.05, c:45, t:"Lab"},
                    {n:"Tip Fees", u:"m3", q:1, c:35, t:"Mat"}
                ]}
            ],
            "Concrete": [
                { name: "Footing 20MPa", unit: "m3", resources: [
                    {n:"Concrete 20MPa", u:"m3", q:1.05, c:250, t:"Mat"},
                    {n:"Line Pump", u:"hr", q:0.2, c:180, t:"Plant"},
                    {n:"Placers", u:"hr", q:1, c:70, t:"Lab"}
                ]}
            ],
            "Drainage": [
                { name: "PVC 100mm Pipe", unit: "m", resources: [
                    {n:"Pipe 100mm", u:"m", q:1, c:14, t:"Mat"},
                    {n:"Bedding GAP7", u:"m3", q:0.1, c:60, t:"Mat"},
                    {n:"Drainlayer", u:"hr", q:0.4, c:65, t:"Lab"}
                ]}
            ],
            "User Custom": [] 
        };

        // VARS
        let currentResources = [];
        let quoteItems = [];
        let currentProjectId = localStorage.getItem('civilmate_current_project_id');
        let unitModeSnapshot = null;

        // INIT
        init();

        function init() {
            renderDisciplineSelect();
            if(currentProjectId) loadProjectFromDB(currentProjectId);
        }

        function renderDisciplineSelect() {
            const discSelect = document.getElementById('disciplineSelect');
            discSelect.innerHTML = '<option value="">-- Select --</option>';
            Object.keys(standardDB).forEach(d => {
                if(standardDB[d].length > 0) {
                    discSelect.innerHTML += `<option value="${d}">${d}</option>`;
                }
            });
        }

        function loadKits() {
            const d = document.getElementById('disciplineSelect').value;
            const k = document.getElementById('kitSelect');
            k.innerHTML = '<option>-- Select Item --</option>';
            k.disabled = !d;
            if(d && standardDB[d]) standardDB[d].forEach((item, i) => k.innerHTML += `<option value="${d}|${i}">${item.name}</option>`);
        }

        function loadKitDetails() {
            const val = document.getElementById('kitSelect').value;
            if(!val.includes("|")) return;
            const [d, i] = val.split("|");
            const item = standardDB[d][i];
            
            document.getElementById('builderArea').classList.remove('hidden');
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemUnit').value = item.unit;
            
            currentResources = JSON.parse(JSON.stringify(item.resources));
            unitModeSnapshot = null;
            
            switchPricingMode('UNIT', false);
            renderAllLists();
            updateCalculations();
        }

        function createNewItem() {
            document.getElementById('builderArea').classList.remove('hidden');
            document.getElementById('itemName').value = "New Item";
            document.getElementById('itemUnit').value = "ea";
            
            currentResources = [{n:"New Resource", u:"ea", q:1, c:0, t:"Mat"}];
            unitModeSnapshot = null;
            
            switchPricingMode('UNIT');
            renderAllLists();
            updateCalculations();
        }

        // --- RENDER TABLES ---
        function renderAllLists() {
            renderList('Lab', 'listLab');
            renderList('Plant', 'listPlant');
            renderList('Mat', 'listMat');
        }

        function renderList(type, elementId) {
            const list = document.getElementById(elementId);
            list.innerHTML = "";
            
            currentResources.forEach((res, idx) => {
                if(res.t !== type) return;
                
                const total = (res.c * res.q).toFixed(2);
                list.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition">
                        <td><input type="text" value="${res.n}" onchange="updRes(${idx},'n',this.value)" class="res-input font-medium text-slate-700"></td>
                        <td><input type="text" value="${res.u}" onchange="updRes(${idx},'u',this.value)" class="res-input text-center text-slate-500"></td>
                        <td><input type="number" value="${res.q}" onchange="updRes(${idx},'q',this.value)" class="res-input text-right font-bold text-blue-600"></td>
                        <td><input type="number" value="${res.c}" onchange="updRes(${idx},'c',this.value)" class="res-input text-right text-slate-600"></td>
                        <td class="text-right text-[10px] font-mono font-bold text-slate-800 px-2">$${total}</td>
                        <td class="text-center"><button onclick="delRes(${idx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></td>
                    </tr>
                `;
            });
        }

        window.updRes = (i, f, v) => { 
            currentResources[i][f] = (f==='q'||f==='c') ? (parseFloat(v)||0) : v; 
            renderAllLists(); 
            updateCalculations(); 
        };
        window.delRes = (i) => { currentResources.splice(i,1); renderAllLists(); updateCalculations(); };
        window.addRes = (t) => { currentResources.push({n:"New", u:"hr", q:1, c:0, t:t}); renderAllLists(); updateCalculations(); };

        // --- LOGICA REVERSIBLE ---
        function switchPricingMode(targetMode) {
            const btnU = document.getElementById('btnModeUnit');
            const btnT = document.getElementById('btnModeTime');
            const unitInput = document.getElementById('itemUnit');

            if(targetMode === 'TIME') {
                btnT.classList.replace('text-slate-400', 'bg-blue-600'); 
                btnT.classList.add('text-white', 'shadow-md');
                btnU.classList.replace('bg-white', 'text-slate-400');
                btnU.classList.remove('text-blue-700', 'shadow-sm');
                
                unitModeSnapshot = {
                    resources: JSON.parse(JSON.stringify(currentResources)),
                    unit: unitInput.value
                };

                unitInput.value = 'hr';
                currentResources.forEach(r => {
                    if(r.t !== 'Mat') r.q = 1; 
                });

            } else {
                btnU.classList.replace('text-slate-400', 'bg-white'); 
                btnU.classList.add('text-blue-700', 'shadow-sm');
                btnT.classList.replace('bg-blue-600', 'text-slate-400');
                btnT.classList.remove('text-white', 'shadow-md');

                if(unitModeSnapshot) {
                    currentResources = JSON.parse(JSON.stringify(unitModeSnapshot.resources));
                    unitInput.value = unitModeSnapshot.unit;
                }
            }
            renderAllLists();
            updateCalculations();
        }

        function updateCalculations() {
            let cost = 0;
            currentResources.forEach(r => cost += (r.c * r.q));
            
            const margin = parseFloat(document.getElementById('marginInput').value) || 0;
            const price = cost * (1 + (margin/100));
            
            document.getElementById('rawCostDisplay').innerText = "$" + cost.toFixed(2);
            document.getElementById('finalRateDisplay').innerText = "$" + price.toFixed(2);
            return price;
        }

        // --- QUOTE LOGIC ---
        function addToQuote() {
            let qtyVal = parseFloat(document.getElementById('qtyInput').value);
            
            if(!qtyVal || isNaN(qtyVal) || qtyVal <= 0) {
                qtyVal = 1;
                document.getElementById('qtyInput').value = 1;
            }

            const rate = updateCalculations();
            
            quoteItems.push({
                name: document.getElementById('itemName').value,
                unit: document.getElementById('itemUnit').value,
                qty: qtyVal,
                rate: rate,
                total: qtyVal * rate,
                resources: JSON.parse(JSON.stringify(currentResources))
            });
            renderQuote();
            if(window.innerWidth < 1024) document.getElementById('printSection').scrollIntoView({ behavior: 'smooth' });
        }

        function renderQuote() {
            const tbody = document.getElementById('quoteTable');
            tbody.innerHTML = "";
            let sub = 0;
            
            if(quoteItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-slate-300 italic text-xs border-b border-slate-100">No items added.</td></tr>`;
            }

            quoteItems.forEach((item, i) => {
                item.total = item.qty * item.rate;
                sub += item.total;
                
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 group hover:bg-slate-50 transition">
                        <td class="p-3 font-bold text-slate-700">${item.name}</td>
                        <td class="p-3 text-center text-xs text-slate-500 font-bold bg-slate-50 rounded">${item.unit}</td>
                        <td class="p-3 text-center">
                            <input type="number" value="${item.qty}" onchange="updateQuoteQty(${i}, this.value)" class="quote-qty-input no-print">
                            <span class="hidden print-only">${item.qty}</span>
                        </td>
                        <td class="p-3 text-right text-xs font-mono text-slate-500">$${item.rate.toFixed(2)}</td>
                        <td class="p-3 text-right text-xs font-mono font-bold text-slate-800">$${item.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                        <td class="p-3 text-right no-print">
                            <button onclick="delQuoteItem(${i})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('subtotalDisplay').innerText = "$" + sub.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('gstDisplay').innerText = "$" + (sub*0.15).toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalDisplay').innerText = "$" + (sub*1.15).toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function updateQuoteQty(index, newVal) {
            const val = parseFloat(newVal);
            if (val > 0) {
                quoteItems[index].qty = val;
                renderQuote(); 
            }
        }

        window.delQuoteItem = (i) => { quoteItems.splice(i,1); renderQuote(); };

        // --- DATA MANAGEMENT (CSV + DB Manager) ---
        function saveToLibrary() {
            const name = document.getElementById('itemName').value;
            const unit = document.getElementById('itemUnit').value;
            const discipline = document.getElementById('disciplineSelect').value || "User Custom";
            
            if(!standardDB[discipline]) standardDB[discipline] = [];
            
            const idx = standardDB[discipline].findIndex(i => i.name === name);
            const newItem = {
                name: name,
                unit: unit,
                resources: JSON.parse(JSON.stringify(currentResources))
            };

            if(idx >= 0) {
                standardDB[discipline][idx] = newItem;
                alert(`Updated existing item "${name}" in ${discipline}.`);
            } else {
                standardDB[discipline].push(newItem);
                alert(`Saved new item "${name}" to ${discipline}.`);
            }
            renderDisciplineSelect();
        }

        function downloadCSVTemplate() {
            let csvContent = "Discipline,Item Name,Item Unit,Res Name,Res Unit,Res Yield,Res Rate,Res Type\n";
            csvContent += "Earthworks,Example Excavation,m3,Digger 20T,hr,0.05,140,Plant\n";
            csvContent += "Earthworks,Example Excavation,m3,Operator,hr,0.05,45,Lab\n";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "CivilMate_Template.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function handleCSVImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n');
                
                for(let i = 1; i < rows.length; i++) {
                    const row = rows[i].split(',');
                    if(row.length < 8) continue;
                    
                    const disc = row[0].trim();
                    const itemName = row[1].trim();
                    const itemUnit = row[2].trim();
                    const res = {
                        n: row[3].trim(),
                        u: row[4].trim(),
                        q: parseFloat(row[5]),
                        c: parseFloat(row[6]),
                        t: row[7].trim()
                    };

                    if(!standardDB[disc]) standardDB[disc] = [];
                    let item = standardDB[disc].find(it => it.name === itemName);
                    if(!item) {
                        item = { name: itemName, unit: itemUnit, resources: [] };
                        standardDB[disc].push(item);
                    }
                    item.resources.push(res);
                }
                renderDisciplineSelect();
                alert("✅ Database Imported from CSV!");
            };
            reader.readAsText(file);
        }

        // DB MANAGER (NEW)
        function openDBManager() {
            const tbody = document.getElementById('dbTableBody');
            tbody.innerHTML = "";
            let count = 0;
            
            Object.keys(standardDB).forEach(disc => {
                standardDB[disc].forEach((item, index) => {
                    count++;
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="p-3 text-slate-700 font-bold text-xs">${disc}</td>
                            <td class="p-3 text-slate-600 text-xs">${item.name}</td>
                            <td class="p-3 text-center text-slate-500 text-xs bg-slate-50 rounded">${item.unit}</td>
                            <td class="p-3 text-right text-xs text-slate-400 font-mono">${item.resources.length} items</td>
                            <td class="p-3 text-center">
                                <button onclick="deleteItem('${disc}', ${index})" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });
            document.getElementById('dbCount').innerText = count;
            document.getElementById('dbModal').classList.remove('hidden');
        }

        function deleteItem(disc, index) {
            if(confirm("Delete this item?")) {
                standardDB[disc].splice(index, 1);
                if(standardDB[disc].length === 0) delete standardDB[disc];
                openDBManager();
                renderDisciplineSelect();
            }
        }

        function clearAllData() {
            if(confirm("⚠️ DANGER: This will delete ALL database items.\n\nAre you sure?")) {
                if(confirm("Really sure? This cannot be undone.")) {
                    standardDB = { "User Custom": [] };
                    openDBManager();
                    renderDisciplineSelect();
                    // Optional: Reset current builder
                    document.getElementById('kitSelect').innerHTML = "<option>-- Empty --</option>";
                    document.getElementById('kitSelect').disabled = true;
                }
            }
        }

        // --- SAVE PROJECT ---
        function printQuote() {
            if(!document.getElementById('clientName').value) return alert("Please enter Client Name.");
            window.print();
        }

        function saveProject() {
            const client = document.getElementById('clientName').value;
            if(!quoteItems.length) return alert("Quote is empty.");
            if(!client) return alert("Enter Client Name.");

            let totalRev = 0;
            quoteItems.forEach(i => totalRev += i.total);

            const pData = {
                name: client + " - Project",
                client: client,
                address: document.getElementById('clientAddress').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                total: totalRev,
                profit: totalRev * 0.18, 
                items: quoteItems,
                status: "Pending",
                updatedAt: Date.now()
            };

            if(currentProjectId) {
                db.collection('projects').doc(currentProjectId).update(pData).then(() => alert("✅ Updated!"));
            } else {
                pData.createdAt = Date.now();
                db.collection('projects').add(pData).then((doc) => {
                    localStorage.setItem('civilmate_current_project_id', doc.id);
                    currentProjectId = doc.id;
                    alert("✅ Saved!");
                });
            }
        }

        function loadProjectFromDB(id) {
            db.collection('projects').doc(id).get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('clientName').value = data.client || "";
                    document.getElementById('clientAddress').value = data.address || "";
                    document.getElementById('clientPhone').value = data.phone || "";
                    document.getElementById('clientEmail').value = data.email || "";
                    quoteItems = data.items || [];
                    renderQuote();
                }
            });
        }
    </script>
</body>
</html>
