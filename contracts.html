<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contract Master V13.0 (Clean Math Core)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; color: #334155; }
        
        /* CONTRACT LOCKS */
        .contract-mode #builderPanel { display: none !important; }
        .contract-mode #printSection { width: 100% !important; max-width: 1000px; margin: 0 auto; background: transparent; }
        .contract-mode .company-input { pointer-events: none; border: none; }
        .contract-mode .header-action { display: none; }
        .contract-mode .quote-qty-input { pointer-events: none; background: transparent; border: none; font-weight: bold; text-align: center; }
        .contract-mode #btnSave { display: none; }
        .contract-mode #docTitle { color: #1e293b; letter-spacing: 2px; text-decoration: underline; text-decoration-color: #2563eb; }
        
        /* TABLES */
        .col-desc { width: 45%; } .col-unit { width: 15%; text-align: center; } .col-qty { width: 15%; text-align: right; } .col-rate { width: 15%; text-align: right; } .col-total { width: 10%; text-align: right; }
        .res-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .res-table th { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; padding: 6px 4px; border-bottom: 2px solid #e2e8f0; }
        .res-table td { padding: 4px; border-bottom: 1px dashed #f1f5f9; vertical-align: middle; }
        .res-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 4px; font-size: 11px; padding: 2px 4px; }
        .res-input:hover { background-color: #f1f5f9; border-color: #e2e8f0; }
        .res-input:focus { background-color: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .quote-qty-input { background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; font-weight: bold; text-align: center; border-radius: 4px; width: 100%; font-size: 11px; padding: 2px 0; height: 24px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .company-input { text-align: right; background: transparent; border: 1px dashed transparent; width: 100%; outline: none; transition: 0.2s; cursor: pointer; }
        .company-input:hover, .company-input:focus { border-color: #cbd5e1; background: #fffbeb; }

        /* MODE BUTTONS */
        .mode-btn { transition: all 0.2s; border: 1px solid #cbd5e1; cursor: pointer; }
        .mode-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .mode-inactive { background-color: white; color: #64748b; }
        .mode-inactive:hover { background-color: #f1f5f9; }

        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
            .print-apu-hidden #apuAppendix { display: none !important; }
            .print-apu-visible #apuAppendix { display: block !important; page-break-before: always; }
            #legalContractModal.show-print * { visibility: visible; }
            #legalContractModal.show-print { position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; display: block !important; }
            .no-print { display: none !important; }
            input { border: none !important; background: transparent !important; padding: 0 !important; }
            .quote-qty-input { background: transparent !important; border: none !important; text-align: center; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative">

    <header class="bg-white border-b border-slate-200 p-3 flex justify-between items-center shrink-0 z-20 shadow-sm no-print">
        <div class="flex items-center gap-3">
            <div class="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center font-bold text-lg"><i class="fas fa-file-invoice"></i></div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-none">CivilMate</h1>
                <p class="text-[10px] text-slate-500">Estimator V13.0 (Clean Math Core)</p>
            </div>
            <div id="projectStatusBadge"></div> 
        </div>
        <div class="flex gap-2 items-center">
            <button id="btnLegal" onclick="generateLegalContract()" class="hidden px-3 py-1.5 text-xs font-bold text-indigo-600 border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 rounded transition flex items-center gap-2"><i class="fas fa-gavel"></i> Legal Contract</button>
            <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-100 rounded border"><i class="fas fa-arrow-left mr-1"></i> Dashboard</button>
            <button id="btnSave" onclick="saveProject()" class="px-4 py-2 text-xs font-bold bg-green-600 hover:bg-green-700 text-white rounded shadow flex items-center gap-2"><i class="fas fa-save"></i> Save Changes</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div id="builderPanel" class="w-7/12 flex flex-col border-r border-slate-200 bg-white overflow-y-auto relative z-10 shadow-[4px_0_24px_rgba(0,0,0,0.05)]">
            <div class="p-4 border-b border-slate-100 bg-slate-50/80 sticky top-0 z-20 backdrop-blur-md">
                <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">1. Select from Database (10 Test Items)</label>
                <div class="flex gap-2">
                    <select id="masterDbSelect" onchange="loadFromMaster()" class="w-full p-2 text-xs font-bold border rounded bg-white text-slate-700 focus:ring-2 ring-blue-500 outline-none cursor-pointer shadow-sm">
                        <option value="">-- Load Standard Analysis --</option>
                    </select>
                    <button onclick="createNewItem()" class="w-24 py-2 bg-slate-800 text-white text-xs font-bold rounded hover:bg-slate-900 transition shadow-md"><i class="fas fa-eraser"></i> Reset</button>
                </div>
            </div>

            <div id="builderArea" class="flex-1 flex flex-col p-6 pb-24">
                
                <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">2. Pricing Mode</label>
                <div class="flex gap-0 rounded-lg overflow-hidden shadow-sm border border-slate-300 mb-6">
                    <button onclick="setPricingMode('unit')" id="btn-unit" class="flex-1 py-2 text-xs font-bold mode-active bg-blue-600 text-white">üìä Unit Rate</button>
                    <button onclick="setPricingMode('hour')" id="btn-hour" class="flex-1 py-2 text-xs font-bold mode-inactive bg-white text-slate-500 hover:bg-slate-50">‚è±Ô∏è Hourly</button>
                    <button onclick="setPricingMode('lump')" id="btn-lump" class="flex-1 py-2 text-xs font-bold mode-inactive bg-white text-slate-500 hover:bg-slate-50">üåé Lump Sum</button>
                </div>

                <div class="flex gap-4 mb-6 items-end">
                    <div class="flex-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Description</label>
                        <input type="text" id="itemName" class="w-full text-xl font-bold text-slate-800 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1 transition" placeholder="Item Name">
                    </div>
                    <div class="w-24 text-center">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Unit</label>
                        <input type="text" id="itemUnit" class="w-full text-center text-xl font-bold text-slate-600 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1 transition" placeholder="m3">
                    </div>
                </div>
                
                <div id="resourcesContainer" class="space-y-6"></div> 
                
                <div class="absolute bottom-0 left-0 w-full bg-slate-900 text-white p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.2)] z-30">
                    <div class="flex items-center justify-between gap-4 mb-3 border-b border-slate-700 pb-3">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="updateDbCheck" class="w-4 h-4 text-green-500 rounded cursor-pointer">
                            <div><label for="updateDbCheck" class="text-[10px] font-bold text-green-400 uppercase cursor-pointer block">Update Master DB</label><p class="text-[9px] text-slate-400">Save changes to library.</p></div>
                        </div>
                        <div class="text-right"><span class="block text-slate-400 font-bold uppercase text-[9px]">Margin %</span><input type="number" id="marginInput" value="18" oninput="updateCalculations()" class="w-12 bg-slate-800 border border-slate-600 rounded px-1 py-0.5 font-bold text-center outline-none text-yellow-400 focus:border-yellow-400 text-xs"></div>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex gap-4 text-xs">
                            <div><span class="block text-slate-400 font-bold uppercase text-[9px]">Unit Price</span><span class="font-mono text-green-400 text-xl font-bold leading-none" id="finalRateDisplay">$0.00</span></div>
                            <div class="border-l border-slate-700 pl-4"><span class="block text-slate-400 font-bold uppercase text-[9px]">Total Line Value</span><span class="font-mono text-yellow-400 text-xl font-bold leading-none" id="totalLineValueDisplay">$0.00</span></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="bg-slate-800 p-1 rounded border border-slate-700 flex items-center px-3"><label class="text-[9px] font-bold text-slate-400 uppercase mr-2">Qty:</label><input type="number" id="qtyInput" oninput="updateCalculations()" class="w-16 bg-transparent font-bold text-center outline-none text-white text-lg" placeholder="1" value="1"></div>
                            <button onclick="addToQuote()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded font-bold shadow-lg transition flex items-center gap-2 text-sm"><i class="fas fa-plus"></i> Add to Quote</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-5/12 bg-slate-100 flex flex-col overflow-y-auto relative" id="printSection">
            <div class="bg-white min-h-[29.7cm] w-full max-w-[21cm] mx-auto my-8 shadow-2xl p-12 flex flex-col relative" id="a4Page">
                <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
                    <div>
                        <h2 id="docTitle" class="text-4xl font-bold text-slate-800 uppercase tracking-widest">Quotation</h2>
                        <p class="text-sm text-slate-500 font-medium mt-1">Ref: <span id="quoteRefDisplay">#EST-001</span></p>
                    </div>
                    <div class="w-1/2 text-right">
                        <input type="text" id="myCompany" value="My Construction Co." class="company-input font-bold text-xl text-slate-800">
                        <input type="text" id="myAddress" value="123 Builder Lane, Auckland" class="company-input text-xs text-slate-500">
                        <input type="text" id="myPhone" value="Ph: 0800 123 456" class="company-input text-xs text-slate-500">
                    </div>
                </div>
                <div class="bg-yellow-50/50 border border-yellow-100 rounded-lg p-5 mb-8 grid grid-cols-2 gap-8 no-print-bg">
                    <div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Prepared For</p>
                        <input type="text" id="clientName" class="w-full font-bold text-lg text-slate-800 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none placeholder-slate-400 mb-1" placeholder="Enter Client Name">
                        <input type="text" id="clientAddress" class="w-full text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none mb-1 placeholder-slate-400" placeholder="Enter Address">
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Date</p><p class="font-bold text-slate-700 text-sm" id="currentDate">...</p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-3 mb-1">Valid Until</p><p class="text-sm text-slate-700">30 Days</p>
                    </div>
                </div>
                <table class="w-full text-left mb-6 text-sm border-collapse">
                    <thead class="bg-slate-100 text-slate-600 font-bold uppercase text-[9px]"><tr><th class="p-3 w-5/12 text-left">Description</th><th class="p-3 text-center w-1/12">Unit</th><th class="p-3 text-center w-1/12">Qty</th><th class="p-3 text-right w-2/12">Rate</th><th class="p-3 text-right w-2/12">Amount</th><th class="p-3 w-1/12 no-print header-action"></th></tr></thead>
                    <tbody id="quoteTable" class="text-slate-700"><tr><td colspan="6" class="p-10 text-center text-slate-300 italic text-xs border-b border-slate-100">No items added.</td></tr></tbody>
                </table>
                <div class="flex justify-end mt-auto mb-10">
                    <div class="w-1/2 space-y-2">
                        <div class="flex justify-between text-xs text-slate-500"><span>Subtotal (Ex GST)</span><span id="subtotalDisplay" class="font-mono">$0.00</span></div>
                        <div class="flex justify-between text-xs text-slate-500 border-b border-slate-200 pb-2"><span>GST (15%)</span><span id="gstDisplay" class="font-mono">$0.00</span></div>
                        <div class="flex justify-between text-2xl font-bold text-slate-800 pt-2"><span>TOTAL (NZD)</span><span id="totalDisplay" class="font-mono">$0.00</span></div>
                        <div class="flex justify-between text-xs text-slate-400 pt-1" id="contractTotalLabel"><span>Contract Value</span><span id="contractTotal" class="font-mono">$0.00</span></div>
                    </div>
                </div>
                <div id="apuAppendix" class="hidden mt-8 pt-8 border-t-4 border-slate-800"><h2 class="text-2xl font-bold text-slate-700 uppercase mb-6">Appendix: Rate Analysis Breakdown</h2><div id="apuContent" class="space-y-8"></div></div>
            </div>
            <div class="fixed bottom-8 right-8 no-print z-50 flex flex-col items-end gap-2 header-action">
                <div class="bg-white p-2 rounded shadow border border-slate-200 flex items-center gap-2"><input type="checkbox" id="printApuCheck" class="w-4 h-4 text-blue-600 rounded cursor-pointer"><label for="printApuCheck" class="text-xs font-bold text-slate-600 cursor-pointer">Include APUs</label></div>
                <button onclick="printQuote()" class="bg-slate-800 hover:bg-black text-white px-6 py-4 rounded-full shadow-2xl font-bold flex items-center gap-3 transition transform hover:-translate-y-1"><i class="fas fa-print text-xl"></i> <span>Download / Print</span></button>
            </div>
        </div>
    </div>

    <div id="legalContractModal" class="fixed inset-0 bg-white z-[9999] hidden overflow-y-auto">
        <div class="max-w-[21cm] mx-auto p-12 bg-white min-h-screen">
            <div class="no-print flex justify-between items-center mb-8 border-b pb-4"><h2 class="text-xl font-bold text-slate-800">Construction Contract</h2><div class="flex gap-2"><button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Print</button><button onclick="document.getElementById('legalContractModal').classList.add('hidden')" class="bg-slate-200 text-slate-700 px-4 py-2 rounded font-bold hover:bg-slate-300">Close</button></div></div>
            <div class="font-serif text-slate-800 leading-relaxed text-sm">
                <div class="text-center mb-10"><h1 class="text-3xl font-bold uppercase tracking-widest border-b-2 border-black pb-2 inline-block">Short Form Agreement</h1></div>
                <div class="mb-8"><p class="mb-4"><strong>DATE:</strong> <span id="contractDate"></span></p><div class="grid grid-cols-2 gap-8"><div><p class="font-bold uppercase text-xs text-slate-500">CLIENT</p><p class="text-lg font-bold" id="contractClientName">...</p><p id="contractClientAddr">...</p></div><div><p class="font-bold uppercase text-xs text-slate-500">CONTRACTOR</p><p class="text-lg font-bold" id="contractMyCompany">...</p><p id="contractMyAddr">...</p></div></div></div>
                <div class="mb-8"><h3 class="font-bold uppercase border-b border-slate-300 mb-2">Terms</h3><p>Work completed as per Schedule. Payment as per CCA 2002. Total Price: <strong id="contractTotalVal"></strong></p></div>
                <div class="mt-16 grid grid-cols-2 gap-16"><div><div class="border-b border-black h-8"></div><p class="text-xs uppercase mt-1 font-bold">Client Signature</p></div><div><div class="border-b border-black h-8"></div><p class="text-xs uppercase mt-1 font-bold">Contractor Signature</p></div></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-NZ');
        let currentResources = [{n:"General Labor", u:"hr", q:1, c:45, t:"Lab"}];
        let quoteItems = [];
        let masterItems = [];
        let currentProjectId = localStorage.getItem('civilmate_current_project_id');
        let activePricingMode = 'unit'; // Default

        init();

        function init() {
            renderAllLists();
            seedMasterDatabase(); 
            if(currentProjectId) loadProjectFromDB(currentProjectId);
            updateCalculations();
        }

        // --- LOAD PROJECT & DETECT STATUS ---
        function loadProjectFromDB(id) { 
            db.collection('projects').doc(id).get().then(doc => { 
                if(doc.exists) { 
                    const data = doc.data(); 
                    document.getElementById('clientName').value = data.client||""; 
                    document.getElementById('clientAddress').value = data.address||"";
                    quoteItems = data.schedule || []; 
                    renderQuote(); 
                    if (data.status === 'Active' || data.status === 'Completed') {
                        activateContractMode();
                    }
                }
            }); 
        }

        function activateContractMode() {
            document.body.classList.add('contract-mode');
            document.getElementById('docTitle').innerText = "MASTER CONTRACT SCHEDULE";
            document.getElementById('quoteRefDisplay').innerText = "NZS 3910 AGREEMENT";
            document.getElementById('clientName').readOnly = true;
            document.getElementById('clientAddress').readOnly = true;
            document.querySelector('#printSection').classList.remove('w-5/12');
            document.querySelector('#printSection').classList.add('w-full');
        }

        // --- DATABASE SEEDING (10 CLEAN TEST ITEMS) ---
        function seedMasterDatabase() {
            db.collection('master_library').limit(1).get().then(snap => {
                // If DB empty or old, SEED 10 CLEAN ITEMS
                if (snap.empty || !snap.docs[0].data().category) {
                    console.log("Seeding CLEAN TEST DATABASE (10 Items)...");
                    const seedItems = [
                        { cat: "1. General", name: "Building Consent Fees", unit: "LS", resources: [{n:"Council Fees", t:"Mat", u:"LS", q:1, c:4500}, {n:"Admin Time", t:"Lab", u:"hr", q:4, c:90}] },
                        { cat: "1. General", name: "Site Management", unit: "hr", resources: [{n:"Site Manager", t:"Lab", u:"hr", q:1, c:100}] },
                        { cat: "2. Earthworks", name: "Bulk Excavation", unit: "m3", resources: [{n:"Excavator 14T", t:"Plant", u:"hr", q:0.05, c:145}, {n:"Operator", t:"Lab", u:"hr", q:0.05, c:60}] },
                        { cat: "2. Earthworks", name: "Tip Fees", unit: "m3", resources: [{n:"Clean Fill Tip", t:"Mat", u:"m3", q:1, c:25}, {n:"Truck 6W", t:"Plant", u:"hr", q:0.1, c:120}] },
                        { cat: "3. Concrete", name: "Slab on Grade 100mm", unit: "m2", resources: [{n:"Concrete 25MPa", t:"Mat", u:"m3", q:0.11, c:280}, {n:"Mesh SE62", t:"Mat", u:"m2", q:1, c:15}, {n:"Placers", t:"Lab", u:"m2", q:0.8, c:65}] },
                        { cat: "4. Carpentry", name: "Wall Framing 90x45", unit: "m2", resources: [{n:"SG8 Timber", t:"Mat", u:"m", q:4.5, c:7.50}, {n:"Carpenter", t:"Lab", u:"hr", q:1.2, c:75}] },
                        { cat: "4. Carpentry", name: "Trusses Installation", unit: "m2", resources: [{n:"Truss Pack", t:"Mat", u:"m2", q:1, c:85}, {n:"Crane", t:"Plant", u:"hr", q:0.1, c:250}, {n:"Carpenter", t:"Lab", u:"hr", q:0.8, c:75}] },
                        { cat: "5. Lining", name: "GIB Fixing & Stopping", unit: "m2", resources: [{n:"GIB 10mm", t:"Mat", u:"m2", q:1.05, c:14}, {n:"Fixer", t:"Lab", u:"m2", q:0.3, c:60}, {n:"Stopper", t:"Lab", u:"m2", q:0.4, c:65}] },
                        { cat: "6. Electrical", name: "Power Point Double", unit: "ea", resources: [{n:"Socket PDL", t:"Mat", u:"ea", q:1, c:35}, {n:"Cable", t:"Mat", u:"m", q:5, c:4}, {n:"Electrician", t:"Lab", u:"hr", q:0.8, c:90}] },
                        { cat: "7. Plumbing", name: "Toilet Installation", unit: "ea", resources: [{n:"Toilet Suite", t:"Mat", u:"ea", q:1, c:550}, {n:"Plumber", t:"Lab", u:"hr", q:3, c:95}] }
                    ];

                    let batch = db.batch();
                    seedItems.forEach(item => {
                        let cost = 0;
                        item.resources.forEach(r => cost += (r.c * r.q));
                        item.rate = cost * 1.18; 
                        let ref = db.collection('master_library').doc();
                        batch.set(ref, item);
                    });
                    
                    batch.commit().then(() => { 
                        console.log("DB Seeded."); 
                        loadMasterLibrary(); 
                    });
                } else {
                    loadMasterLibrary();
                }
            });
        }

        function loadMasterLibrary() {
            db.collection('master_library').orderBy('cat').get().then(snap => {
                masterItems = [];
                const select = document.getElementById('masterDbSelect');
                select.innerHTML = '<option value="">-- Load Standard Analysis --</option>';
                let grouped = {};
                snap.forEach(doc => {
                    const item = doc.data(); item.id = doc.id; masterItems.push(item);
                    const cat = item.cat || "Uncategorized";
                    if(!grouped[cat]) grouped[cat] = []; grouped[cat].push(item);
                });
                Object.keys(grouped).sort().forEach(cat => {
                    let html = `<optgroup label="${cat}">`;
                    grouped[cat].forEach(item => { 
                        html += `<option value="${item.id}">${item.name} (${item.unit}) - $${(item.rate||0).toFixed(2)}</option>`; 
                    });
                    html += `</optgroup>`; select.innerHTML += html;
                });
                select.innerHTML += '<option value="new">+ Create New Item (Custom)</option>';
            });
        }

        // --- MODE SWITCHER LOGIC (FIXED) ---
        function setPricingMode(mode) {
            activePricingMode = mode;
            
            // 1. Update UI Buttons
            ['unit', 'hour', 'lump'].forEach(m => {
                const btn = document.getElementById('btn-'+m);
                if (m === mode) {
                    btn.className = "flex-1 py-2 text-xs font-bold mode-active bg-blue-600 text-white border border-blue-600 transition";
                } else {
                    btn.className = "flex-1 py-2 text-xs font-bold mode-inactive bg-white text-slate-500 hover:bg-slate-50 border border-slate-300 transition";
                }
            });

            // 2. Logic Update & Input Locking
            const qtyInput = document.getElementById('qtyInput');
            
            if (mode === 'hour') {
                document.getElementById('itemUnit').value = 'hr';
                qtyInput.readOnly = false;
                qtyInput.style.backgroundColor = "transparent";
            } else if (mode === 'lump') {
                document.getElementById('itemUnit').value = 'LS';
                qtyInput.value = 1; 
                qtyInput.readOnly = true; 
                qtyInput.style.backgroundColor = "#f3f4f6"; // Grey out
            } else {
                // Unit mode
                const current = document.getElementById('itemUnit').value;
                if (current === 'hr' || current === 'LS') document.getElementById('itemUnit').value = 'm3';
                qtyInput.readOnly = false;
                qtyInput.style.backgroundColor = "transparent";
            }
            updateCalculations(); // TRIGGER RECALC
        }

        // --- BUILDER LOGIC ---
        function loadFromMaster() {
            const id = document.getElementById('masterDbSelect').value;
            if (id === 'new' || id === "") { createNewItem(); return; }
            const item = masterItems.find(i => i.id === id);
            if (item) {
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemUnit').value = item.unit;
                // DEEP COPY RESOURCES to avoid pointer issues
                currentResources = item.resources.map(r => ({...r})); 
                
                // Auto-detect mode
                if(item.unit === 'hr') setPricingMode('hour');
                else if(item.unit === 'LS') setPricingMode('lump');
                else setPricingMode('unit');

                renderAllLists();
                updateCalculations();
            }
        }

        function renderAllLists() {
            document.getElementById('resourcesContainer').innerHTML = "";
            renderList('Lab', 'Labor Cost', 'bg-orange-50', 'text-orange-800', 'border-orange-200', 'text-orange-600');
            renderList('Plant', 'Plant Cost', 'bg-green-50', 'text-green-800', 'border-green-200', 'text-green-600');
            renderList('Mat', 'Material Cost', 'bg-blue-50', 'text-blue-800', 'border-blue-200', 'text-blue-600');
        }

        function renderList(type, title, bgClass, textClass, borderClass, btnClass) {
            let container = document.getElementById('resourcesContainer');
            let sectionHTML = `<div class="border ${borderClass} rounded-lg overflow-hidden shadow-sm"><div class="${bgClass} px-3 py-2 flex justify-between items-center border-b ${borderClass.replace('200','100')}"><span class="text-[10px] font-bold ${textClass} uppercase tracking-wider">${title}</span><button onclick="addRes('${type}')" class="${btnClass} hover:brightness-75 text-xs font-bold bg-white px-2 py-0.5 rounded border ${borderClass} shadow-sm transition">+ Add</button></div><div class="bg-white"><table class="res-table"><thead><tr><th class="col-desc pl-3 text-left">Description</th><th class="col-unit text-center">Unit</th><th class="col-qty text-right">Yield</th><th class="col-rate text-right">Cost</th><th class="col-total text-right">Total</th><th class="w-[5%]"></th></tr></thead><tbody id="list${type}"></tbody></table></div></div>`;
            container.innerHTML += sectionHTML;
            
            setTimeout(() => {
                const tbody = document.getElementById(`list${type}`);
                if(tbody) {
                    tbody.innerHTML = "";
                    currentResources.forEach((res, idx) => {
                        if(res.t !== type) return;
                        // STRICT MATH: ParseFloat everything
                        let q = parseFloat(res.q) || 0;
                        let c = parseFloat(res.c) || 0;
                        let total = q * c;
                        
                        tbody.innerHTML += `<tr class="group hover:bg-slate-50 transition border-b border-dashed border-slate-100 last:border-0"><td><input type="text" value="${res.n}" onchange="updRes(${idx},'n',this.value)" class="res-input font-medium text-slate-700"></td><td><input type="text" value="${res.u}" onchange="updRes(${idx},'u',this.value)" class="res-input text-center text-slate-500"></td><td><input type="number" value="${q}" onchange="updRes(${idx},'q',this.value)" class="res-input text-right font-bold text-blue-600"></td><td><input type="number" value="${c}" onchange="updRes(${idx},'c',this.value)" class="res-input text-right text-slate-600"></td><td class="text-right text-[10px] font-mono font-bold text-slate-800 px-2">$${total.toFixed(2)}</td><td class="text-center"><button onclick="delRes(${idx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></td></tr>`;
                    });
                }
            }, 0);
        }

        window.addRes = (t) => { currentResources.push({n:"New Item", u:"hr", q:1, c:0, t:t}); renderAllLists(); updateCalculations(); };
        window.delRes = (i) => { currentResources.splice(i,1); renderAllLists(); updateCalculations(); };
        
        // UPDATED updRes TO FORCE RECALC
        window.updRes = (i, f, v) => { 
            if(f==='q' || f==='c') {
                currentResources[i][f] = parseFloat(v) || 0;
            } else {
                currentResources[i][f] = v;
            }
            renderAllLists(); 
            updateCalculations(); 
        };

        // --- MATH CORE (BLINDADO) ---
        function updateCalculations() {
            let cost = 0; 
            currentResources.forEach(r => {
                let q = parseFloat(r.q) || 0;
                let c = parseFloat(r.c) || 0;
                cost += (q * c);
            });
            
            const margin = parseFloat(document.getElementById('marginInput').value) || 0;
            const price = cost * (1 + (margin/100));
            const qty = parseFloat(document.getElementById('qtyInput').value) || 0;
            const totalLineValue = price * qty;
            
            document.getElementById('rawCostDisplay').innerText = "$" + cost.toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('finalRateDisplay').innerText = "$" + price.toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('totalLineValueDisplay').innerText = "$" + totalLineValue.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            return { rate: price, total: totalLineValue };
        }

        function createNewItem() {
            document.getElementById('itemName').value = "New Item"; document.getElementById('itemUnit').value = "ea";
            currentResources = [{n:"Labor", u:"hr", q:1, c:45, t:"Lab"}];
            renderAllLists(); 
            setPricingMode('unit'); 
            document.getElementById('masterDbSelect').value = "";
        }

        function addToQuote() {
            let qty = parseFloat(document.getElementById('qtyInput').value) || 1;
            let name = document.getElementById('itemName').value;
            let unit = document.getElementById('itemUnit').value;
            
            let calc = updateCalculations(); // Ensure math is fresh
            let rate = calc.rate;
            let total = calc.total;
            
            if(document.getElementById('updateDbCheck').checked) {
                const itemData = { name: name, unit: unit, rate: rate, resources: currentResources, lastUpdated: Date.now(), cat: "User Custom" };
                db.collection('master_library').add(itemData).then(() => {
                    console.log("Saved to DB");
                    loadMasterLibrary();
                });
            }
            
            quoteItems.push({ 
                desc: name, name: name, unit: unit, qty: qty, rate: rate, total: total, 
                resources: JSON.parse(JSON.stringify(currentResources)) 
            });
            renderQuote();
        }

        function renderQuote() {
            const tbody = document.getElementById('quoteTable'); tbody.innerHTML = ""; let
