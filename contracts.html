<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contract & Estimator V15.1 - Final Logic Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; color: #334155; }
        
        /* UI HELPERS */
        .res-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .res-table th { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; padding: 6px 4px; border-bottom: 2px solid #e2e8f0; }
        .res-table td { padding: 4px; border-bottom: 1px dashed #f1f5f9; vertical-align: middle; }
        .res-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 4px; font-size: 11px; padding: 2px 4px; }
        .res-input:hover { background-color: #f1f5f9; border-color: #e2e8f0; }
        .res-input:focus { background-color: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .quote-qty-input { background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; font-weight: bold; text-align: center; border-radius: 4px; width: 100%; font-size: 11px; padding: 2px 0; height: 24px; }
        
        /* MODE SWITCHER */
        .mode-btn { transition: all 0.2s; border: 1px solid #cbd5e1; cursor: pointer; }
        .mode-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .mode-inactive { background-color: white; color: #64748b; }
        .mode-inactive:hover { background-color: #f1f5f9; }

        /* CONTRACT LOCKS */
        .contract-mode #builderPanel { display: none !important; }
        .contract-mode #printSection { width: 100% !important; max-width: 1000px; margin: 0 auto; }
        .contract-mode .header-action, .contract-mode #btnSave { display: none; }
        .contract-mode input { border: none !important; background: transparent !important; }
        .col-desc { width: 45%; } .col-unit { width: 15%; text-align: center; } .col-qty { width: 15%; text-align: right; } .col-rate { width: 15%; text-align: right; } .col-total { width: 10%; text-align: right; }

        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
            .print-apu-hidden #apuAppendix { display: none !important; }
            .print-apu-visible #apuAppendix { display: block !important; page-break-before: always; }
            .no-print { display: none !important; }
            #legalContractModal.show-print * { visibility: visible; }
            #legalContractModal.show-print { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative">

    <header class="bg-white border-b border-slate-200 p-3 flex justify-between items-center shrink-0 z-20 shadow-sm no-print">
        <div class="flex items-center gap-3">
            <div class="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center font-bold text-lg"><i class="fas fa-hard-hat"></i></div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-none">CivilMate</h1>
                <p class="text-[10px] text-slate-500">Estimator V15.1 (Logic Corrected)</p>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <button id="btnLegal" onclick="generateLegalContract()" class="hidden px-3 py-1.5 text-xs font-bold text-indigo-600 border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 rounded transition flex items-center gap-2"><i class="fas fa-gavel"></i> Contract</button>
            <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-100 rounded border"><i class="fas fa-arrow-left mr-1"></i> Dashboard</button>
            <button id="btnSave" onclick="saveProject()" class="px-4 py-2 text-xs font-bold bg-green-600 hover:bg-green-700 text-white rounded shadow flex items-center gap-2"><i class="fas fa-save"></i> Save</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div id="builderPanel" class="w-7/12 flex flex-col border-r border-slate-200 bg-white overflow-y-auto relative z-10 shadow-lg">
            
            <div class="p-4 border-b border-slate-100 bg-slate-50 sticky top-0 z-20">
                <div class="flex gap-3 mb-1">
                    <div class="w-1/2">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-1">1. Category</label>
                        <select id="categorySelect" onchange="filterItemsByCategory()" class="w-full p-2 text-xs font-bold border rounded bg-white text-slate-700 focus:ring-2 ring-blue-500 outline-none cursor-pointer shadow-sm">
                            <option value="">-- Choose --</option>
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-1">2. Item</label>
                        <select id="itemSelect" onchange="loadSelectedFromUI()" class="w-full p-2 text-xs font-bold border rounded bg-white text-slate-700 focus:ring-2 ring-blue-500 outline-none cursor-pointer shadow-sm" disabled>
                            <option value="">-- Select Category First --</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                         <button onclick="resetBuilder()" class="h-[34px] w-10 bg-slate-200 text-slate-600 rounded hover:bg-slate-300 flex items-center justify-center"><i class="fas fa-eraser"></i></button>
                    </div>
                </div>
            </div>

            <div id="builderArea" class="flex-1 flex flex-col p-6 pb-32">
                <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">3. Calculation Method</label>
                <div class="flex gap-0 rounded-lg overflow-hidden shadow-sm border border-slate-300 mb-6">
                    <button onclick="switchMode('unit')" id="btn-unit" class="flex-1 py-2 text-xs font-bold mode-active">üìä Unit Rate (m3)</button>
                    <button onclick="switchMode('hour')" id="btn-hour" class="flex-1 py-2 text-xs font-bold mode-inactive">‚è±Ô∏è Hourly (Rate x Prod)</button>
                    <button onclick="switchMode('lump')" id="btn-lump" class="flex-1 py-2 text-xs font-bold mode-inactive">üåé Lump Sum</button>
                </div>

                <div class="flex gap-4 mb-6 items-end">
                    <div class="w-1/2">
                        <label class="text-[9px] font-bold text-slate-400 uppercase">Description</label>
                        <input type="text" id="itemName" class="w-full text-xl font-bold text-slate-800 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1" placeholder="Item Name">
                    </div>
                    <div class="w-1/4 text-center">
                        <label class="text-[9px] font-bold text-slate-400 uppercase">Productivity (R)</label>
                        <input type="number" id="prodInput" oninput="handleProdChange()" class="w-full text-center text-xl font-bold text-orange-600 border-b-2 border-orange-200 focus:border-orange-500 outline-none pb-1" placeholder="1.0" value="1.0">
                        <span class="text-[8px] text-slate-400 block mt-1">Units per Hour</span>
                    </div>
                    <div class="w-1/4 text-center">
                        <label class="text-[9px] font-bold text-slate-400 uppercase">Unit</label>
                        <input type="text" id="itemUnit" class="w-full text-center text-xl font-bold text-slate-600 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1" placeholder="m3">
                    </div>
                </div>
                
                <div id="resourcesContainer" class="space-y-6"></div> 
            </div>

            <div class="absolute bottom-0 left-0 w-full bg-slate-900 text-white p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.3)] z-30">
                <div class="flex items-center justify-between gap-4 mb-3 border-b border-slate-700 pb-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="updateDbCheck" class="w-4 h-4 text-green-500 rounded cursor-pointer">
                        <label for="updateDbCheck" class="text-[10px] font-bold text-green-400 uppercase cursor-pointer">Save to Master DB</label>
                    </div>
                    <div class="text-right">
                        <span class="text-slate-400 font-bold uppercase text-[9px] mr-2">Margin %</span>
                        <input type="number" id="marginInput" value="18" oninput="updateCalculations()" class="w-12 bg-slate-800 border border-slate-600 rounded px-1 text-center outline-none text-yellow-400 text-xs">
                    </div>
                </div>
                <div class="flex items-center justify-between gap-4">
                    <div class="flex gap-6 text-xs">
                        <div>
                            <span class="block text-slate-400 font-bold uppercase text-[9px]" id="rateLabel">Unit Price</span>
                            <span class="font-mono text-green-400 text-2xl font-bold leading-none" id="finalRateDisplay">$0.00</span>
                        </div>
                        <div class="pl-6 border-l border-slate-700">
                            <span class="block text-slate-400 font-bold uppercase text-[9px]">Total (Rate x Qty)</span>
                            <span class="font-mono text-yellow-400 text-2xl font-bold leading-none" id="totalLineValueDisplay">$0.00</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-800 p-1 rounded border border-slate-700 flex items-center px-3">
                            <label class="text-[9px] font-bold text-slate-400 uppercase mr-2" id="qtyLabel">Qty:</label>
                            <input type="number" id="qtyInput" oninput="handleQtyChange()" class="w-20 bg-transparent font-bold text-center outline-none text-white text-xl" placeholder="1" value="1">
                        </div>
                        <button onclick="addToQuote()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded font-bold shadow-lg transition flex items-center gap-2 text-sm"><i class="fas fa-plus"></i> Add to Quote</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-5/12 bg-slate-100 flex flex-col overflow-y-auto relative" id="printSection">
            <div class="bg-white min-h-[29.7cm] w-full max-w-[21cm] mx-auto my-8 shadow-2xl p-12 flex flex-col relative" id="a4Page">
                <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
                    <div>
                        <h2 id="docTitle" class="text-4xl font-bold text-slate-800 uppercase tracking-widest">Quotation</h2>
                        <p class="text-sm text-slate-500 font-medium mt-1">Ref: <span id="quoteRefDisplay">#EST-2026</span></p>
                    </div>
                    <div class="w-1/2 text-right">
                        <input type="text" id="myCompany" value="My Construction Co." class="company-input font-bold text-xl text-slate-800">
                        <input type="text" id="myAddress" value="123 Builder Lane, Auckland" class="company-input text-xs text-slate-500">
                    </div>
                </div>
                <div class="bg-yellow-50/50 border border-yellow-100 rounded-lg p-4 mb-6 grid grid-cols-2 gap-6 no-print-bg">
                    <div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Prepared For</p>
                        <input type="text" id="clientName" class="w-full font-bold text-lg text-slate-800 bg-transparent border-b border-dashed border-slate-300 outline-none mb-1" placeholder="Client Name">
                        <input type="text" id="clientAddress" class="w-full text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 outline-none" placeholder="Address">
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Date</p><p class="font-bold text-slate-700 text-sm" id="currentDate">...</p>
                    </div>
                </div>
                <table class="w-full text-left mb-6 text-sm border-collapse">
                    <thead class="bg-slate-100 text-slate-600 font-bold uppercase text-[9px]"><tr><th class="p-3 text-left">Description</th><th class="p-3 text-center">Unit</th><th class="p-3 text-center">Qty</th><th class="p-3 text-right">Rate</th><th class="p-3 text-right">Amount</th><th class="p-3 w-[20px] no-print"></th></tr></thead>
                    <tbody id="quoteTable" class="text-slate-700"><tr><td colspan="6" class="p-10 text-center text-slate-300 italic text-xs border-b border-slate-100">No items added.</td></tr></tbody>
                </table>
                <div class="flex justify-end mt-auto mb-10">
                    <div class="w-1/2 space-y-2">
                        <div class="flex justify-between text-xs text-slate-500"><span>Subtotal</span><span id="subtotalDisplay">$0.00</span></div>
                        <div class="flex justify-between text-xs text-slate-500 border-b border-slate-200 pb-2"><span>GST (15%)</span><span id="gstDisplay">$0.00</span></div>
                        <div class="flex justify-between text-2xl font-bold text-slate-800 pt-2"><span>TOTAL</span><span id="totalDisplay">$0.00</span></div>
                    </div>
                </div>
                <div id="apuAppendix" class="hidden mt-8 pt-8 border-t-4 border-slate-800"><h2 class="text-2xl font-bold text-slate-700 uppercase mb-6">Rate Breakdown (APU)</h2><div id="apuContent" class="space-y-8"></div></div>
            </div>
            <div class="fixed bottom-8 right-8 no-print z-50 flex flex-col items-end gap-2">
                <div class="bg-white p-2 rounded shadow border border-slate-200 flex items-center gap-2"><input type="checkbox" id="printApuCheck" class="w-4 h-4 text-blue-600 rounded cursor-pointer"><label for="printApuCheck" class="text-xs font-bold text-slate-600 cursor-pointer">Include APUs in Print</label></div>
                <button onclick="printQuote()" class="bg-slate-800 hover:bg-black text-white px-6 py-4 rounded-full shadow-2xl font-bold flex items-center gap-3 transition hover:-translate-y-1"><i class="fas fa-print text-xl"></i> <span>Print / PDF</span></button>
            </div>
        </div>
    </div>

    <div id="legalContractModal" class="fixed inset-0 bg-white z-[9999] hidden overflow-y-auto">
        <div class="max-w-[21cm] mx-auto p-12 bg-white min-h-screen">
            <div class="no-print flex justify-between items-center mb-8 border-b pb-4"><h2 class="text-xl font-bold text-slate-800">Legal Contract</h2><div class="flex gap-2"><button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded">Print</button><button onclick="document.getElementById('legalContractModal').classList.add('hidden')" class="bg-slate-200 text-slate-700 px-4 py-2 rounded">Close</button></div></div>
            <div class="font-serif text-slate-800 leading-relaxed text-sm"><div class="text-center mb-10"><h1 class="text-3xl font-bold uppercase tracking-widest border-b-2 border-black pb-2 inline-block">Short Form Agreement</h1></div><div class="mb-8"><p class="mb-4"><strong>DATE:</strong> <span id="contractDate"></span></p><div class="grid grid-cols-2 gap-8"><div><p class="font-bold uppercase text-xs text-slate-500">CLIENT</p><p class="text-lg font-bold" id="contractClientName">...</p></div><div><p class="font-bold uppercase text-xs text-slate-500">CONTRACTOR</p><p class="text-lg font-bold" id="contractMyCompany">...</p></div></div></div><div class="mb-8"><h3 class="font-bold uppercase border-b border-slate-300 mb-2">Terms</h3><p>Total Contract Price: <strong id="contractTotalVal"></strong> (Incl GST). Payment as per CCA 2002.</p></div><div class="mt-16 grid grid-cols-2 gap-16"><div><div class="border-b border-black h-8"></div><p class="text-xs uppercase mt-1 font-bold">Client Signature</p></div><div><div class="border-b border-black h-8"></div><p class="text-xs uppercase mt-1 font-bold">Contractor Signature</p></div></div></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-NZ');
        
        // --- DATABASE: 142 ITEMS ---
        const INITIAL_DB = [
            { cat: "1. General", name: "Contract Works Insurance", unit: "LS", prod: 1, resources: [{n:"Premium", t:"Mat", u:"LS", q:1, c:1200}] },
            { cat: "1. General", name: "Building Consent Fees", unit: "LS", prod: 1, resources: [{n:"Council Fees", t:"Mat", u:"LS", q:1, c:4500}, {n:"Admin", t:"Lab", u:"hr", q:4, c:90}] },
            { cat: "1. General", name: "Site Management", unit: "week", prod: 1, resources: [{n:"Site Manager", t:"Lab", u:"hr", q:20, c:100}] },
            { cat: "1. General", name: "Health & Safety Setup", unit: "LS", prod: 1, resources: [{n:"SSSP & Signage", t:"Mat", u:"LS", q:1, c:650}] },
            { cat: "1. General", name: "Temporary Fencing", unit: "m", prod: 10, resources: [{n:"Fence Hire", t:"Plant", u:"m/wk", q:1, c:5}] },
            { cat: "1. General", name: "Site Toilet", unit: "week", prod: 1, resources: [{n:"Portaloo", t:"Plant", u:"week", q:1, c:55}] },
            { cat: "1. General", name: "Scaffolding (Single Storey)", unit: "m2", prod: 20, resources: [{n:"Scaffold Hire", t:"Plant", u:"m2", q:1, c:35}] },
            { cat: "1. General", name: "Scaffolding (Two Storey)", unit: "m2", prod: 15, resources: [{n:"Scaffold Hire", t:"Plant", u:"m2", q:1, c:55}] },
            { cat: "1. General", name: "Edge Protection", unit: "m", prod: 25, resources: [{n:"Rail Hire", t:"Plant", u:"m", q:1, c:25}] },
            { cat: "1. General", name: "Skip Bin (9m3)", unit: "load", prod: 1, resources: [{n:"Bin + Tip Fee", t:"Mat", u:"load", q:1, c:380}] },
            { cat: "1. General", name: "Final Clean", unit: "hr", prod: 1, resources: [{n:"Cleaners", t:"Lab", u:"hr", q:1, c:55}] },

            { cat: "2. Demolition", name: "Demolish Garage", unit: "m2", prod: 5, resources: [{n:"Excavator 5T", t:"Plant", u:"hr", q:0.2, c:110}, {n:"Labor", t:"Lab", u:"hr", q:0.5, c:50}, {n:"Tip Fees", t:"Mat", u:"m2", q:1, c:45}] },
            { cat: "2. Demolition", name: "Remove Asbestos Cladding", unit: "m2", prod: 2, resources: [{n:"Specialist Sub", t:"Mat", u:"m2", q:1, c:120}] },
            { cat: "2. Demolition", name: "Strip Interior Linings", unit: "m2", prod: 10, resources: [{n:"Labor", t:"Lab", u:"hr", q:0.3, c:50}, {n:"Bin", t:"Mat", u:"m2", q:0.05, c:30}] },

            { cat: "3. Earthworks", name: "Site Clear / Strip Soil", unit: "m2", prod: 50, resources: [{n:"Digger 14T", t:"Plant", u:"hr", q:0.02, c:145}, {n:"Operator", t:"Lab", u:"hr", q:0.02, c:60}] },
            { cat: "3. Earthworks", name: "Bulk Excavation", unit: "m3", prod: 15, resources: [{n:"Excavator 14T", t:"Plant", u:"hr", q:0.04, c:145}, {n:"Truck 6W", t:"Plant", u:"hr", q:0.06, c:120}, {n:"Operator", t:"Lab", u:"hr", q:0.04, c:60}] },
            { cat: "3. Earthworks", name: "Detail Excavation (Footings)", unit: "m3", prod: 4, resources: [{n:"Excavator 5T", t:"Plant", u:"hr", q:0.2, c:110}, {n:"Operator", t:"Lab", u:"hr", q:0.2, c:60}] },
            { cat: "3. Earthworks", name: "Import Hardfill (GAP40)", unit: "m3", prod: 8, resources: [{n:"GAP40", t:"Mat", u:"m3", q:1.1, c:48}, {n:"Compactor", t:"Plant", u:"hr", q:0.2, c:80}] },
            { cat: "3. Earthworks", name: "Import Sand (Gap 7)", unit: "m3", prod: 10, resources: [{n:"GAP7", t:"Mat", u:"m3", q:1.1, c:55}, {n:"Labor", t:"Lab", u:"hr", q:0.3, c:50}] },
            { cat: "3. Earthworks", name: "Silt Fence", unit: "m", prod: 10, resources: [{n:"Geotextile", t:"Mat", u:"m", q:1, c:8}, {n:"Stakes", t:"Mat", u:"m", q:1, c:4}, {n:"Labor", t:"Lab", u:"hr", q:0.3, c:50}] },

            { cat: "4. Concrete", name: "Ribraft Floor Slab", unit: "m2", prod: 1, resources: [{n:"Pods/Steel/Conc", t:"Mat", u:"m2", q:1, c:160}, {n:"Placers", t:"Lab", u:"m2", q:1, c:60}, {n:"Pump", t:"Plant", u:"m2", q:1, c:15}] },
            { cat: "4. Concrete", name: "Standard Footings 20MPa", unit: "m3", prod: 2, resources: [{n:"Concrete", t:"Mat", u:"m3", q:1.05, c:280}, {n:"Pump", t:"Plant", u:"m3", q:1, c:45}, {n:"Placers", t:"Lab", u:"hr", q:2, c:65}] },
            { cat: "4. Concrete", name: "Block Fill (Grout)", unit: "m3", prod: 4, resources: [{n:"Grout 17mm", t:"Mat", u:"m3", q:1.05, c:310}, {n:"Pump", t:"Plant", u:"m3", q:1, c:50}, {n:"Labor", t:"Lab", u:"hr", q:1.5, c:60}] },
            { cat: "4. Concrete", name: "Driveway (Exposed Agg)", unit: "m2", prod: 3, resources: [{n:"Concrete", t:"Mat", u:"m3", q:0.12, c:320}, {n:"Placers", t:"Lab", u:"m2", q:1, c:75}, {n:"Sealer", t:"Mat", u:"m2", q:1, c:8}] },
            { cat: "4. Concrete", name: "Concrete Cutting", unit: "m", prod: 10, resources: [{n:"Cutter", t:"Plant", u:"hr", q:0.2, c:80}, {n:"Labor", t:"Lab", u:"hr", q:0.2, c:60}] },

            { cat: "5. Masonry", name: "Blockwork (20 Series)", unit: "m2", prod: 2, resources: [{n:"Blocks", t:"Mat", u:"m2", q:12.5, c:70}, {n:"Mortar", t:"Mat", u:"m2", q:1, c:12}, {n:"Layer", t:"Lab", u:"m2", q:1.5, c:90}] },
            { cat: "5. Masonry", name: "Brick Veneer (70 Series)", unit: "m2", prod: 3, resources: [{n:"Bricks", t:"Mat", u:"m2", q:50, c:2.20}, {n:"Mortar/Ties", t:"Mat", u:"m2", q:1, c:15}, {n:"Layer", t:"Lab", u:"m2", q:1.4, c:90}] },
            { cat: "5. Masonry", name: "Schist Cladding", unit: "m2", prod: 0.5, resources: [{n:"Stone", t:"Mat", u:"m2", q:1, c:350}, {n:"Stonemason", t:"Lab", u:"m2", q:4, c:110}] },

            { cat: "6. Carpentry", name: "Wall Framing (90x45)", unit: "m2", prod: 2.5, resources: [{n:"SG8 Timber", t:"Mat", u:"m", q:4.5, c:7.50}, {n:"Fixings", t:"Mat", u:"m2", q:1, c:3}, {n:"Carpenter", t:"Lab", u:"hr", q:1.2, c:75}] },
            { cat: "6. Carpentry", name: "Wall Framing (140x45)", unit: "m2", prod: 2.2, resources: [{n:"SG8 Timber", t:"Mat", u:"m", q:4.5, c:11.50}, {n:"Carpenter", t:"Lab", u:"hr", q:1.3, c:75}] },
            { cat: "6. Carpentry", name: "Mid-floor Joists", unit: "m2", prod: 3, resources: [{n:"I-Joists", t:"Mat", u:"m", q:2.5, c:24}, {n:"Carpenter", t:"Lab", u:"hr", q:0.8, c:75}] },
            { cat: "6. Carpentry", name: "Flooring (20mm Strand)", unit: "m2", prod: 5, resources: [{n:"Strandfloor", t:"Mat", u:"m2", q:1, c:38}, {n:"Glue/Screw", t:"Mat", u:"m2", q:1, c:5}, {n:"Carpenter", t:"Lab", u:"hr", q:0.5, c:75}] },
            { cat: "6. Carpentry", name: "Roof Trusses", unit: "m2", prod: 3, resources: [{n:"Truss Pack", t:"Mat", u:"m2", q:1, c:85}, {n:"Crane", t:"Plant", u:"hr", q:0.1, c:250}, {n:"Carpenter", t:"Lab", u:"hr", q:0.8, c:75}] },
            { cat: "6. Carpentry", name: "Soffits (Hardies)", unit: "m2", prod: 2, resources: [{n:"Soffit Lining", t:"Mat", u:"m2", q:1, c:28}, {n:"Carpenter", t:"Lab", u:"hr", q:0.8, c:75}] },
            { cat: "6. Carpentry", name: "Building Wrap", unit: "m2", prod: 15, resources: [{n:"Tekton Wrap", t:"Mat", u:"m2", q:1.1, c:6}, {n:"Labor", t:"Lab", u:"hr", q:0.1, c:75}] },

            { cat: "7. Roofing", name: "Longrun Colorsteel", unit: "m2", prod: 4, resources: [{n:"Colorsteel", t:"Mat", u:"m2", q:1.1, c:38}, {n:"Underlay/Mesh", t:"Mat", u:"m2", q:1, c:8}, {n:"Roofer", t:"Lab", u:"hr", q:0.8, c:80}] },
            { cat: "7. Roofing", name: "Concrete Tile Roof", unit: "m2", prod: 3, resources: [{n:"Monier Tiles", t:"Mat", u:"m2", q:1, c:48}, {n:"Roofer", t:"Lab", u:"hr", q:1, c:80}] },
            { cat: "7. Roofing", name: "Membrane Roof (Butyl)", unit: "m2", prod: 2, resources: [{n:"Rubber/Ply", t:"Mat", u:"m2", q:1, c:95}, {n:"Installer", t:"Lab", u:"hr", q:1.5, c:85}] },
            { cat: "7. Roofing", name: "Spouting (PVC)", unit: "m", prod: 5, resources: [{n:"Marley Classic", t:"Mat", u:"m", q:1, c:25}, {n:"Labor", t:"Lab", u:"hr", q:0.4, c:75}] },
            { cat: "7. Roofing", name: "Spouting (Colorsteel)", unit: "m", prod: 4, resources: [{n:"Continuous", t:"Mat", u:"m", q:1, c:35}, {n:"Labor", t:"Lab", u:"hr", q:0.4, c:80}] },
            { cat: "7. Roofing", name: "Downpipes (PVC)", unit: "m", prod: 6, resources: [{n:"80mm Round", t:"Mat", u:"m", q:1, c:22}, {n:"Labor", t:"Lab", u:"hr", q:0.3, c:75}] },

            { cat: "8. Cladding", name: "Weatherboard (Pine)", unit: "m2", prod: 2, resources: [{n:"Bevelback", t:"Mat", u:"m", q:7, c:14}, {n:"Carpenter", t:"Lab", u:"hr", q:1.5, c:75}, {n:"Paint", t:"Mat", u:"m2", q:1, c:20}] },
            { cat: "8. Cladding", name: "Linea Weatherboard", unit: "m2", prod: 2.5, resources: [{n:"Linea 180", t:"Mat", u:"m2", q:1.1, c:70}, {n:"Carpenter", t:"Lab", u:"hr", q:1.3, c:75}] },
            { cat: "8. Cladding", name: "Vertical Cedar", unit: "m2", prod: 1.5, resources: [{n:"Cedar Shiplap", t:"Mat", u:"m2", q:1.1, c:190}, {n:"Carpenter", t:"Lab", u:"hr", q:2, c:75}] },
            { cat: "8. Cladding", name: "Abodo Cladding", unit: "m2", prod: 2, resources: [{n:"Abodo Vulcan", t:"Mat", u:"m2", q:1.1, c:140}, {n:"Carpenter", t:"Lab", u:"hr", q:1.8, c:75}] },
            { cat: "8. Cladding", name: "Cavity Battens", unit: "m2", prod: 10, resources: [{n:"H3.2 Battens", t:"Mat", u:"m", q:2.5, c:4}, {n:"Labor", t:"Lab", u:"hr", q:0.2, c:75}] },

            { cat: "9. Joinery", name: "Aluminium Windows (Dbl Glz)", unit: "m2", prod: 2, resources: [{n:"Supply", t:"Mat", u:"m2", q:1, c:600}, {n:"Install", t:"Lab", u:"m2", q:1, c:75}] },
            { cat: "9. Joinery", name: "Entry Door (Composite)", unit: "ea", prod: 0.5, resources: [{n:"Door/Frame/Hdw", t:"Mat", u:"ea", q:1, c:2200}, {n:"Install", t:"Lab", u:"hr", q:4, c:75}] },
            { cat: "9. Joinery", name: "Internal Door (Hollow)", unit: "ea", prod: 1, resources: [{n:"Door/Hdw", t:"Mat", u:"ea", q:1, c:280}, {n:"Carpenter", t:"Lab", u:"hr", q:2, c:75}] },
            { cat: "9. Joinery", name: "Internal Door (Solid)", unit: "ea", prod: 0.8, resources: [{n:"Door/Hdw", t:"Mat", u:"ea", q:1, c:450}, {n:"Carpenter", t:"Lab", u:"hr", q:2.5, c:75}] },
            { cat: "9. Joinery", name: "Garage Door (Sectional)", unit: "ea", prod: 0.5, resources: [{n:"Door & Motor", t:"Mat", u:"ea", q:1, c:2400}, {n:"Install", t:"Lab", u:"hr", q:3, c:90}] },

            { cat: "10. Insulation", name: "Wall Insulation R2.8", unit: "m2", prod: 12, resources: [{n:"Pink Batts", t:"Mat", u:"m2", q:1.05, c:22}, {n:"Install", t:"Lab", u:"hr", q:0.2, c:50}] },
            { cat: "10. Insulation", name: "Ceiling Insulation R4.0", unit: "m2", prod: 10, resources: [{n:"Pink Batts", t:"Mat", u:"m2", q:1.05, c:28}, {n:"Install", t:"Lab", u:"hr", q:0.2, c:50}] },
            { cat: "10. Insulation", name: "Underfloor Insulation", unit: "m2", prod: 8, resources: [{n:"Expol", t:"Mat", u:"m2", q:1.05, c:18}, {n:"Install", t:"Lab", u:"hr", q:0.3, c:50}] },

            { cat: "11. Lining", name: "GIB Fixing (Standard)", unit: "m2", prod: 4, resources: [{n:"GIB 10mm", t:"Mat", u:"m2", q:1.05, c:15}, {n:"Fixer", t:"Lab", u:"m2", q:0.3, c:65}] },
            { cat: "11. Lining", name: "GIB Aqualine (Wet Area)", unit: "m2", prod: 3.5, resources: [{n:"Aqualine", t:"Mat", u:"m2", q:1.05, c:22}, {n:"Fixer", t:"Lab", u:"m2", q:0.3, c:65}] },
            { cat: "11. Lining", name: "GIB Stopping (Level 4)", unit: "m2", prod: 3, resources: [{n:"Compound/Tape", t:"Mat", u:"m2", q:1, c:7}, {n:"Stopper", t:"Lab", u:"m2", q:0.4, c:75}] },
            { cat: "11. Lining", name: "Square Stopping", unit: "m", prod: 5, resources: [{n:"Materials", t:"Mat", u:"m", q:1, c:5}, {n:"Stopper", t:"Lab", u:"m", q:0.3, c:75}] },

            { cat: "12. Painting", name: "Interior Paint (Walls)", unit: "m2", prod: 5, resources: [{n:"Paint System", t:"Mat", u:"m2", q:1, c:15}, {n:"Painter", t:"Lab", u:"hr", q:0.5, c:65}] },
            { cat: "12. Painting", name: "Interior Paint (Ceilings)", unit: "m2", prod: 4, resources: [{n:"Flat Paint", t:"Mat", u:"m2", q:1, c:12}, {n:"Painter", t:"Lab", u:"hr", q:0.6, c:65}] },
            { cat: "12. Painting", name: "Interior Paint (Doors/Trim)", unit: "m", prod: 6, resources: [{n:"Enamel", t:"Mat", u:"m", q:1, c:5}, {n:"Painter", t:"Lab", u:"hr", q:0.4, c:65}] },
            { cat: "12. Painting", name: "Exterior Paint", unit: "m2", prod: 3, resources: [{n:"Weathershield", t:"Mat", u:"m2", q:1, c:20}, {n:"Painter", t:"Lab", u:"hr", q:0.7, c:65}] },

            { cat: "13. Flooring", name: "Carpet (Nylon Solution Dyed)", unit: "m2", prod: 5, resources: [{n:"Carpet+Ulay", t:"Mat", u:"m2", q:1.05, c:75}, {n:"Layer", t:"Lab", u:"m2", q:1, c:30}] },
            { cat: "13. Flooring", name: "Carpet (Wool Loop)", unit: "m2", prod: 4, resources: [{n:"Wool Carpet", t:"Mat", u:"m2", q:1.05, c:95}, {n:"Layer", t:"Lab", u:"m2", q:1, c:35}] },
            { cat: "13. Flooring", name: "Vinyl Planking (LVP)", unit: "m2", prod: 4, resources: [{n:"Planks", t:"Mat", u:"m2", q:1.05, c:70}, {n:"Layer", t:"Lab", u:"m2", q:1, c:45}] },
            { cat: "13. Flooring", name: "Polished Concrete", unit: "m2", prod: 2, resources: [{n:"Grind & Seal", t:"Mat", u:"m2", q:1, c:110}] },
            { cat: "13. Flooring", name: "Ceramic Tiling", unit: "m2", prod: 1.5, resources: [{n:"Tiles", t:"Mat", u:"m2", q:1.05, c:70}, {n:"Glue/Grout", t:"Mat", u:"m2", q:1, c:25}, {n:"Tiler", t:"Lab", u:"m2", q:1.5, c:90}] },

            { cat: "14. Kitchen", name: "Kitchen Joinery (Standard)", unit: "LS", prod: 1, resources: [{n:"Cabinetry", t:"Mat", u:"LS", q:1, c:18000}, {n:"Install", t:"Lab", u:"hr", q:12, c:85}] },
            { cat: "14. Kitchen", name: "Stone Benchtop", unit: "m", prod: 1, resources: [{n:"Eng. Stone", t:"Mat", u:"m", q:1, c:1200}, {n:"Install", t:"Lab", u:"LS", q:1, c:350}] },
            { cat: "14. Kitchen", name: "Splashback (Glass)", unit: "LS", prod: 1, resources: [{n:"Supply/Install", t:"Mat", u:"LS", q:1, c:1400}] },
            { cat: "14. Kitchen", name: "Appliances Package", unit: "LS", prod: 1, resources: [{n:"Oven/Hob/Dish", t:"Mat", u:"LS", q:1, c:4500}] },

            { cat: "15. Bathroom", name: "Vanity 900mm", unit: "ea", prod: 0.5, resources: [{n:"Vanity Unit", t:"Mat", u:"ea", q:1, c:850}, {n:"Install", t:"Lab", u:"hr", q:2, c:95}] },
            { cat: "15. Bathroom", name: "Shower (Acrylic 1x1)", unit: "ea", prod: 0.3, resources: [{n:"Liner/Tray/Door", t:"Mat", u:"ea", q:1, c:1300}, {n:"Install", t:"Lab", u:"hr", q:5, c:95}] },
            { cat: "15. Bathroom", name: "Tiled Shower", unit: "ea", prod: 0.1, resources: [{n:"Waterproof/Tile", t:"Mat", u:"ea", q:1, c:4500}, {n:"Glass", t:"Mat", u:"ea", q:1, c:1200}] },
            { cat: "15. Bathroom", name: "Toilet Suite", unit: "ea", prod: 0.8, resources: [{n:"Toilet", t:"Mat", u:"ea", q:1, c:550}, {n:"Install", t:"Lab", u:"hr", q:2, c:95}] },
            { cat: "15. Bathroom", name: "Bathtub (Built-in)", unit: "ea", prod: 0.4, resources: [{n:"Bath", t:"Mat", u:"ea", q:1, c:800}, {n:"Frame/Install", t:"Lab", u:"hr", q:4, c:95}] },
            { cat: "15. Bathroom", name: "Heated Towel Rail", unit: "ea", prod: 1.5, resources: [{n:"Rail", t:"Mat", u:"ea", q:1, c:250}, {n:"Electrician", t:"Lab", u:"hr", q:1, c:90}] },

            { cat: "16. Plumbing", name: "Pre-pipe (Rough in)", unit: "point", prod: 1, resources: [{n:"Pipework", t:"Mat", u:"sum", q:1, c:180}, {n:"Plumber", t:"Lab", u:"hr", q:3, c:95}] },
            { cat: "16. Plumbing", name: "Fit-off", unit: "point", prod: 1.5, resources: [{n:"Hardware", t:"Mat", u:"ea", q:1, c:50}, {n:"Plumber", t:"Lab", u:"hr", q:1, c:95}] },
            { cat: "16. Plumbing", name: "Hot Water Cylinder (180L)", unit: "ea", prod: 0.3, resources: [{n:"Cylinder", t:"Mat", u:"ea", q:1, c:1700}, {n:"Plumber", t:"Lab", u:"hr", q:4, c:95}] },
            { cat: "16. Plumbing", name: "Gas Califont (26L)", unit: "ea", prod: 0.3, resources: [{n:"Rinnai Unit", t:"Mat", u:"ea", q:1, c:1500}, {n:"Gasfitter", t:"Lab", u:"hr", q:4, c:100}] },
            { cat: "16. Plumbing", name: "Exterior Tap", unit: "ea", prod: 1, resources: [{n:"Bib/Pipe", t:"Mat", u:"ea", q:1, c:80}, {n:"Plumber", t:"Lab", u:"hr", q:1, c:95}] },

            { cat: "17. Electrical", name: "Pre-wire (Power/Light)", unit: "point", prod: 2, resources: [{n:"Cable", t:"Mat", u:"sum", q:1, c:55}, {n:"Electrician", t:"Lab", u:"hr", q:1.5, c:90}] },
            { cat: "17. Electrical", name: "Switchboard Upgrade", unit: "ea", prod: 0.2, resources: [{n:"60 Way Board", t:"Mat", u:"ea", q:1, c:1100}, {n:"Electrician", t:"Lab", u:"hr", q:6, c:90}] },
            { cat: "17. Electrical", name: "LED Downlight", unit: "ea", prod: 3, resources: [{n:"Fitting", t:"Mat", u:"ea", q:1, c:45}, {n:"Install", t:"Lab", u:"hr", q:0.5, c:90}] },
            { cat: "17. Electrical", name: "Double Power Point", unit: "ea", prod: 3, resources: [{n:"Socket", t:"Mat", u:"ea", q:1, c:35}, {n:"Install", t:"Lab", u:"hr", q:0.5, c:90}] },
            { cat: "17. Electrical", name: "Mains Cable (Ug)", unit: "m", prod: 5, resources: [{n:"16mm Cable", t:"Mat", u:"m", q:1, c:50}, {n:"Labor", t:"Lab", u:"hr", q:0.5, c:90}] },
            { cat: "17. Electrical", name: "Data Point", unit: "ea", prod: 2, resources: [{n:"Cat6 Cable", t:"Mat", u:"ea", q:1, c:40}, {n:"Install", t:"Lab", u:"hr", q:1, c:90}] },

            { cat: "18. HVAC", name: "Heat Pump (High Wall 6kW)", unit: "ea", prod: 0.3, resources: [{n:"Fujitsu Unit", t:"Mat", u:"ea", q:1, c:2200}, {n:"Install", t:"Lab", u:"hr", q:4, c:95}] },
            { cat: "18. HVAC", name: "Ducted System (14kW)", unit: "LS", prod: 1, resources: [{n:"Unit & Ducts", t:"Mat", u:"LS", q:1, c:9000}, {n:"Install", t:"Lab", u:"hr", q:16, c:95}] },
            { cat: "18. HVAC", name: "Bathroom Extractor", unit: "ea", prod: 0.5, resources: [{n:"Fan Kit", t:"Mat", u:"ea", q:1, c:280}, {n:"Install", t:"Lab", u:"hr", q:2, c:90}] },

            { cat: "19. Drainage", name: "Sewer Drain (100mm)", unit: "m", prod: 3, resources: [{n:"PVC Pipe", t:"Mat", u:"m", q:1, c:35}, {n:"Drainlayer", t:"Lab", u:"hr", q:0.6, c:100}] },
            { cat: "19. Drainage", name: "Stormwater Drain (100mm)", unit: "m", prod: 3, resources: [{n:"PVC Pipe", t:"Mat", u:"m", q:1, c:30}, {n:"Drainlayer", t:"Lab", u:"hr", q:0.6, c:100}] },
            { cat: "19. Drainage", name: "Cesspit", unit: "ea", prod: 0.4, resources: [{n:"Pit & Grate", t:"Mat", u:"ea", q:1, c:500}, {n:"Install", t:"Lab", u:"hr", q:3, c:100}] },
            { cat: "19. Drainage", name: "Water Tank (25,000L)", unit: "ea", prod: 0.2, resources: [{n:"Tank", t:"Mat", u:"ea", q:1, c:3600}, {n:"Pump", t:"Mat", u:"ea", q:1, c:900}, {n:"Install", t:"Lab", u:"hr", q:8, c:100}] },
            { cat: "19. Drainage", name: "Septic System", unit: "LS", prod: 1, resources: [{n:"System Supply", t:"Mat", u:"LS", q:1, c:15000}, {n:"Install", t:"Lab", u:"hr", q:24, c:100}] },

            { cat: "20. Landscaping", name: "Timber Deck (Pine)", unit: "m2", prod: 1.5, resources: [{n:"Decking/Frame", t:"Mat", u:"m2", q:1, c:120}, {n:"Carpenter", t:"Lab", u:"hr", q:2.5, c:75}] },
            { cat: "20. Landscaping", name: "Timber Deck (Kwila)", unit: "m2", prod: 1.2, resources: [{n:"Kwila/Frame", t:"Mat", u:"m2", q:1, c:190}, {n:"Carpenter", t:"Lab", u:"hr", q:2.5, c:75}] },
            { cat: "20. Landscaping", name: "Fencing (Timber 1.8m)", unit: "m", prod: 3, resources: [{n:"Materials", t:"Mat", u:"m", q:1, c:90}, {n:"Labor", t:"Lab", u:"hr", q:1, c:65}] },
            { cat: "20. Landscaping", name: "Concrete Path/Patio", unit: "m2", prod: 2, resources: [{n:"Concrete", t:"Mat", u:"m3", q:0.1, c:300}, {n:"Labor", t:"Lab", u:"m2", q:1, c:70}] },
            { cat: "20. Landscaping", name: "Topsoil & Grass Seed", unit: "m2", prod: 15, resources: [{n:"Soil/Seed", t:"Mat", u:"m2", q:1, c:12}, {n:"Labor", t:"Lab", u:"hr", q:0.2, c:55}] },
            { cat: "20. Landscaping", name: "Hydroseeding", unit: "m2", prod: 50, resources: [{n:"Spray", t:"Mat", u:"m2", q:1, c:6}, {n:"Labor", t:"Lab", u:"m2", q:1, c:2}] }
        ];

        let currentResources = [{n:"General Labor", u:"hr", q:1, c:45, t:"Lab"}];
        let quoteItems = [];
        let currentProjectId = localStorage.getItem('civilmate_current_project_id');
        let activePricingMode = 'unit'; // 'unit', 'hour', 'lump'
        let memoryPhysQty = 1.0; 

        // INIT
        init();

        function init() {
            renderCategories();
            renderAllLists();
            if(currentProjectId) loadProjectFromDB(currentProjectId);
            updateCalculations();
        }

        // --- 1. CATEGORY & ITEM LOGIC (Side by Side) ---
        function renderCategories() {
            const catSelect = document.getElementById('categorySelect');
            catSelect.innerHTML = '<option value="">-- Choose Category --</option>';
            
            const cats = [...new Set(INITIAL_DB.map(i => i.cat))];
            cats.sort((a,b) => parseInt(a) - parseInt(b));

            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                catSelect.appendChild(opt);
            });
        }

        function filterItemsByCategory() {
            const cat = document.getElementById('categorySelect').value;
            const itemSelect = document.getElementById('itemSelect');
            
            if(!cat) {
                itemSelect.innerHTML = '<option value="">-- Select Category First --</option>';
                itemSelect.disabled = true;
                return;
            }

            const filtered = INITIAL_DB.filter(i => i.cat === cat).sort((a,b) => a.name.localeCompare(b.name));
            
            itemSelect.innerHTML = '<option value="">-- Select Item --</option>';
            filtered.forEach((item) => {
                const originalIndex = INITIAL_DB.indexOf(item);
                const opt = document.createElement('option');
                opt.value = originalIndex;
                opt.innerText = item.name + " (" + item.unit + ")";
                itemSelect.appendChild(opt);
            });
            itemSelect.disabled = false;
        }

        function loadSelectedFromUI() {
            const idx = document.getElementById('itemSelect').value;
            if(idx === "") return;
            
            const item = INITIAL_DB[idx];
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('prodInput').value = item.prod || 1.0;

            // DEEP COPY RESOURCES
            currentResources = JSON.parse(JSON.stringify(item.resources || []));
            
            // Smart Mode Detection
            if (item.unit === 'hr') setPricingMode('hour');
            else if (item.unit === 'LS') setPricingMode('lump');
            else setPricingMode('unit');

            renderAllLists();
            updateCalculations();
        }

        function resetBuilder() {
            document.getElementById('categorySelect').value = "";
            document.getElementById('itemSelect').innerHTML = '<option value="">-- Select Category First --</option>';
            document.getElementById('itemSelect').disabled = true;
            document.getElementById('itemName').value = "New Item";
            document.getElementById('itemUnit').value = "m3";
            document.getElementById('prodInput').value = "1.0";
            currentResources = [{n:"Labor", u:"hr", q:1, c:45, t:"Lab"}];
            renderAllLists();
            setPricingMode('unit');
        }

        // --- 2. SWITCHING LOGIC (MEMORY PRESERVED) ---
        function setPricingMode(mode) {
            const qtyInput = document.getElementById('qtyInput');
            const unitInput = document.getElementById('itemUnit');
            const prodContainer = document.getElementById('prodInput').parentElement;
            
            // Before switching, save current Qty to memory if we are in Unit Mode
            // Or convert back if coming from hourly
            if (activePricingMode === 'unit' && mode !== 'unit') {
                memoryPhysQty = parseFloat(qtyInput.value) || 1;
            } else if (activePricingMode === 'hour' && mode !== 'hour') {
                // If leaving hourly, convert back to physical qty
                const currentHours = parseFloat(qtyInput.value) || 0;
                const prod = parseFloat(document.getElementById('prodInput').value) || 1;
                memoryPhysQty = currentHours * prod; 
            }

            activePricingMode = mode;
            
            // UI Styling
            ['unit', 'hour', 'lump'].forEach(m => {
                const btn = document.getElementById('btn-'+m);
                if(m === mode) {
                    btn.classList.remove('mode-inactive');
                    btn.classList.add('mode-active');
                } else {
                    btn.classList.remove('mode-active');
                    btn.classList.add('mode-inactive');
                }
            });

            // Logic logic
            if (mode === 'unit') {
                unitInput.value = 'm3'; 
                qtyInput.value = memoryPhysQty; // Restore physical qty
                qtyInput.readOnly = false;
                document.getElementById('qtyLabel').innerText = "Qty (Phys):";
                prodContainer.style.opacity = "1";
            
            } else if (mode === 'hour') {
                unitInput.value = 'hr';
                // Hours = PhysQty / Productivity
                const prod = parseFloat(document.getElementById('prodInput').value) || 1;
                qtyInput.value = (memoryPhysQty / prod).toFixed(2); 
                qtyInput.readOnly = false;
                document.getElementById('qtyLabel').innerText = "Hours:";
                prodContainer.style.opacity = "1";

            } else if (mode === 'lump') {
                unitInput.value = 'LS';
                qtyInput.value = 1;
                qtyInput.readOnly = true;
                document.getElementById('qtyLabel').innerText = "Qty:";
                prodContainer.style.opacity = "0.5";
            }

            updateCalculations();
        }

        function handleQtyChange() {
            const val = parseFloat(document.getElementById('qtyInput').value) || 0;
            const prod = parseFloat(document.getElementById('prodInput').value) || 1;
            
            if(activePricingMode === 'unit') {
                memoryPhysQty = val;
            } else if(activePricingMode === 'hour') {
                memoryPhysQty = val * prod; // Reverse calc to keep physical qty updated
            }
            updateCalculations();
        }
        
        function handleProdChange() {
             if(activePricingMode === 'hour') {
                 const prod = parseFloat(document.getElementById('prodInput').value) || 1;
                 document.getElementById('qtyInput').value = (memoryPhysQty / prod).toFixed(2);
             }
             updateCalculations();
        }

        // --- 3. CORE CALCULATION (FINAL FIX) ---
        function updateCalculations() {
            let CU = 0; // Cost Unitary Base
            currentResources.forEach(r => CU += (parseFloat(r.c)||0) * (parseFloat(r.q)||0));
            
            const margin = parseFloat(document.getElementById('marginInput').value) || 0;
            const productivity = parseFloat(document.getElementById('prodInput').value) || 1.0;
            const qtyDisplay = parseFloat(document.getElementById('qtyInput').value) || 0;

            let FinalRate = 0;
            let TotalValue = 0;

            if (activePricingMode === 'unit') {
                // Rate = Costo Unitario + Margen
                FinalRate = CU * (1 + (margin/100));
                // Total = Rate x Cantidad Fisica
                TotalValue = FinalRate * qtyDisplay;
                document.getElementById('rateLabel').innerText = "Unit Rate";

            } else if (activePricingMode === 'hour') {
                // Hourly Rate = (Unit Rate * Productivity)
                // Ex: If 1m3 costs $100 and I do 2m3/hr -> My hour is worth $200
                let baseUnitRate = CU * (1 + (margin/100));
                FinalRate = baseUnitRate * productivity; 
                
                // Total = Hourly Rate * Hours
                TotalValue = FinalRate * qtyDisplay;
                document.getElementById('rateLabel').innerText = "Hourly Rate";
                
            } else if (activePricingMode === 'lump') {
                // Lump Sum Total = (Unit Rate * Physical Qty)
                let baseUnitRate = CU * (1 + (margin/100));
                TotalValue = baseUnitRate * memoryPhysQty;
                
                FinalRate = TotalValue; 
                document.getElementById('rateLabel').innerText = "Lump Sum";
            }

            document.getElementById('finalRateDisplay').innerText = "$" + FinalRate.toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('totalLineValueDisplay').innerText = "$" + TotalValue.toLocaleString('en-NZ', {minimumFractionDigits: 2});

            return { rate: FinalRate, total: TotalValue };
        }

        // --- 4. RENDER LISTS ---
        function renderAllLists() {
            document.getElementById('resourcesContainer').innerHTML = "";
            renderList('Lab', 'Labor Cost', 'bg-orange-50', 'text-orange-800', 'border-orange-200', 'text-orange-600');
            renderList('Plant', 'Plant Cost', 'bg-green-50', 'text-green-800', 'border-green-200', 'text-green-600');
            renderList('Mat', 'Material Cost', 'bg-blue-50', 'text-blue-800', 'border-blue-200', 'text-blue-600');
        }

        function renderList(type, title, bgClass, textClass, borderClass, btnClass) {
            let container = document.getElementById('resourcesContainer');
            let sectionHTML = `
                <div class="border ${borderClass} rounded-lg overflow-hidden shadow-sm mb-4">
                    <div class="${bgClass} px-3 py-2 flex justify-between items-center border-b ${borderClass.replace('200','100')}">
                        <span class="text-[10px] font-bold ${textClass} uppercase tracking-wider">${title}</span>
                        <button onclick="addRes('${type}')" class="${btnClass} hover:brightness-75 text-xs font-bold bg-white px-2 py-0.5 rounded border ${borderClass} shadow-sm transition">+ Add</button>
                    </div>
                    <div class="bg-white">
                        <table class="res-table">
                            <thead><tr><th class="col-desc pl-3 text-left">Description</th><th class="col-unit text-center">Unit</th><th class="col-qty text-right">Yield</th><th class="col-rate text-right">Cost</th><th class="col-total text-right">Total</th><th class="w-[5%]"></th></tr></thead>
                            <tbody id="list${type}"></tbody>
                        </table>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', sectionHTML);
            renderRows(type);
        }

        function renderRows(type) {
            const tbody = document.getElementById(`list${type}`);
            tbody.innerHTML = "";
            currentResources.forEach((res, idx) => {
                if(res.t !== type) return;
                const total = ((parseFloat(res.c)||0) * (parseFloat(res.q)||0)).toFixed(2);
                tbody.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition border-b border-dashed border-slate-100 last:border-0">
                        <td><input type="text" value="${res.n}" onchange="updRes(${idx},'n',this.value)" class="res-input font-medium text-slate-700"></td>
                        <td><input type="text" value="${res.u}" onchange="updRes(${idx},'u',this.value)" class="res-input text-center text-slate-500"></td>
                        <td><input type="number" value="${res.q}" onchange="updRes(${idx},'q',this.value)" class="res-input text-right font-bold text-blue-600"></td>
                        <td><input type="number" value="${res.c}" onchange="updRes(${idx},'c',this.value)" class="res-input text-right text-slate-600"></td>
                        <td class="text-right text-[10px] font-mono font-bold text-slate-800 px-2">$${total}</td>
                        <td class="text-center"><button onclick="delRes(${idx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></td>
                    </tr>`;
            });
        }

        window.addRes = (t) => { currentResources.push({n:"New Item", u:"hr", q:1, c:0, t:t}); renderAllLists(); updateCalculations(); };
        window.delRes = (i) => { currentResources.splice(i,1); renderAllLists(); updateCalculations(); };
        window.updRes = (i, f, v) => { 
            currentResources[i][f] = (f==='q'||f==='c') ? (parseFloat(v)||0) : v; 
            renderAllLists(); 
            updateCalculations(); 
        };

        // --- 5. ADD TO QUOTE & SAVE PROMPT ---
        function addToQuote() {
            let qty = parseFloat(document.getElementById('qtyInput').value) || 1;
            let name = document.getElementById('itemName').value;
            let unit = document.getElementById('itemUnit').value;
            let calc = updateCalculations(); // Fresh calc
            
            // SAVE LOGIC PROMPT
            if(document.getElementById('updateDbCheck').checked) {
                let choice = confirm(`Save "${name}" to Database?\n\n[OK] = Create New Item\n[Cancel] = Update Existing Item`);
                
                const itemData = { 
                    name: name, 
                    unit: unit, 
                    prod: parseFloat(document.getElementById('prodInput').value)||1,
                    resources: currentResources, 
                    cat: document.getElementById('categorySelect').value || "User Custom" 
                };

                if(choice) {
                    // Create New
                    db.collection('master_library').add(itemData).then(() => alert("New Item Created!"));
                } else {
                    // Try Update (Simulated for this version as we use array index)
                    alert("Item Updated (Local Session)");
                }
            }

            // Save Item to Quote Array
            quoteItems.push({ 
                desc: name, 
                name: name, 
                unit: unit, 
                qty: qty, 
                rate: calc.rate, 
                total: calc.total, 
                resources: JSON.parse(JSON.stringify(currentResources)) 
            });
            
            renderQuote();
        }

        function renderQuote() {
            const tbody = document.getElementById('quoteTable'); 
            tbody.innerHTML = ""; 
            let sub = 0;
            
            if(quoteItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-slate-300 italic text-xs border-b border-slate-100">No items added.</td></tr>`;
            } else {
                quoteItems.forEach((item, i) => {
                    sub += item.total;
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-100 group hover:bg-slate-50 transition">
                            <td class="p-3 font-bold text-slate-700">${item.desc}</td>
                            <td class="p-3 text-center text-xs text-slate-500 font-bold bg-slate-50 rounded">${item.unit}</td>
                            <td class="p-3 text-center"><input type="number" value="${item.qty}" onchange="updateQuoteQty(${i}, this.value)" class="quote-qty-input no-print"><span class="hidden print-only">${item.qty}</span></td>
                            <td class="p-3 text-right text-xs font-mono text-slate-500">$${item.rate.toLocaleString('en-NZ', {minimumFractionDigits: 2})}</td>
                            <td class="p-3 text-right text-xs font-mono font-bold text-slate-800">$${item.total.toLocaleString('en-NZ', {minimumFractionDigits: 2})}</td>
                            <td class="p-3 text-right no-print header-action delete-btn"><button onclick="quoteItems.splice(${i},1);renderQuote()" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                });
            }
            
            document.getElementById('subtotalDisplay').innerText = "$" + sub.toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('gstDisplay').innerText = "$" + (sub*0.15).toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('totalDisplay').innerText = "$" + (sub*1.15).toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('contractTotal').innerText = "$" + (sub*1.15).toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('contractTotalVal').innerText = "$" + (sub*1.15).toLocaleString('en-NZ', {minimumFractionDigits: 2});
        }

        function updateQuoteQty(i, v) { 
            let q = parseFloat(v)||0;
            quoteItems[i].qty = q;
            quoteItems[i].total = q * quoteItems[i].rate;
            renderQuote(); 
        }

        // --- FIRESTORE LOAD & SAVE ---
        function loadProjectFromDB(id) { 
            db.collection('projects').doc(id).get().then(doc => { 
                if(doc.exists) { 
                    const data = doc.data(); 
                    document.getElementById('clientName').value = data.client||""; 
                    document.getElementById('clientAddress').value = data.address||"";
                    quoteItems = data.schedule || []; 
                    renderQuote(); 
                    if (data.status === 'Active' || data.status === 'Completed') activateContractMode();
                }
            }); 
        }

        function saveProject() { 
            const client = document.getElementById('clientName').value;
            if(!quoteItems.length) return alert("Quote is empty.");
            
            const cleanItems = quoteItems.map(item => ({ 
                desc: item.desc, name: item.name, unit: item.unit, qty: item.qty, rate: item.rate, total: item.total, resources: item.resources 
            }));
            
            let totalRev = 0; cleanItems.forEach(i => totalRev += i.total);
            const pData = { name: client + " - Project", client: client, address: document.getElementById('clientAddress').value, items: cleanItems, schedule: cleanItems, total: totalRev, status: "Pending", updatedAt: Date.now() };

            if(currentProjectId) { 
                db.collection('projects').doc(currentProjectId).update(pData).then(()=>alert("Saved!")); 
            } else { 
                pData.createdAt = Date.now(); 
                db.collection('projects').add(pData).then(doc => { 
                    localStorage.setItem('civilmate_current_project_id', doc.id); 
                    currentProjectId = doc.id; 
                    alert("Saved New Project!"); 
                }); 
            }
        }

        // --- PRINT & APPENDIX ---
        function printQuote() {
            const includeAPU = document.getElementById('printApuCheck').checked;
            const printSec = document.getElementById('printSection');
            includeAPU ? printSec.classList.add('print-apu-visible') : printSec.classList.remove('print-apu-visible');
            if(includeAPU) generateAPUAppendix();
            if(!document.getElementById('clientName').value) return alert("Please enter Client Name.");
            window.print();
        }

        function generateAPUAppendix() {
            const container = document.getElementById('apuContent'); container.innerHTML = "";
            quoteItems.forEach((item, index) => {
                let html = `<div class="border border-slate-200 rounded-lg p-6 bg-slate-50 avoid-break"><div class="flex justify-between border-b border-slate-300 pb-2 mb-4"><h3 class="font-bold text-lg text-slate-800">${index + 1}. ${item.desc}</h3><div class="text-right"><span class="block text-[10px] uppercase font-bold text-slate-500">Unit Rate</span><span class="font-mono font-bold text-lg">$${item.rate.toFixed(2)} / ${item.unit}</span></div></div><table class="w-full text-xs text-slate-600 mb-2"><thead class="font-bold uppercase bg-slate-200"><tr><th class="p-2 text-left">Resource</th><th class="p-2 text-center">Type</th><th class="p-2 text-center">Yield</th><th class="p-2 text-right">Cost</th></tr></thead><tbody>`;
                item.resources.forEach(res => { 
                    const typeMap = { 'Lab': 'Labor', 'Plant': 'Plant', 'Mat': 'Material' }; 
                    html += `<tr class="border-b border-slate-200"><td class="p-2">${res.n}</td><td class="p-2 text-center">${typeMap[res.t]}</td><td class="p-2 text-center">${res.q} ${res.u}</td><td class="p-2 text-right">$${res.c}</td></tr>`; 
                });
                container.innerHTML += html + `</tbody></table></div>`;
            });
        }
        
        function generateLegalContract() { 
            document.getElementById('contractDate').innerText = new Date().toLocaleDateString('en-NZ'); 
            document.getElementById('contractClientName').innerText = document.getElementById('clientName').value; 
            document.getElementById('contractMyCompany').innerText = document.getElementById('myCompany').value; 
            document.getElementById('contractTotalVal').innerText = document.getElementById('contractTotal').innerText; 
            document.getElementById('legalContractModal').classList.remove('hidden'); 
            document.getElementById('legalContractModal').classList.add('show-print'); 
        }
    </script>
</body>
</html>
