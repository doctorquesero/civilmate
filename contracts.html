<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contract & Estimator V6 - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; color: #334155; }
        
        /* TABLAS Y ESTILOS UI */
        .col-desc { width: 45%; } .col-unit { width: 15%; text-align: center; } .col-qty { width: 15%; text-align: right; } .col-rate { width: 15%; text-align: right; } .col-total { width: 10%; text-align: right; }
        
        .res-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .res-table th { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; padding: 6px 4px; border-bottom: 2px solid #e2e8f0; }
        .res-table td { padding: 4px; border-bottom: 1px dashed #f1f5f9; vertical-align: middle; }
        
        .res-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 4px; font-size: 11px; padding: 2px 4px; }
        .res-input:hover { background-color: #f1f5f9; border-color: #e2e8f0; }
        .res-input:focus { background-color: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .quote-qty-input { background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; font-weight: bold; text-align: center; border-radius: 4px; width: 100%; font-size: 11px; padding: 2px 0; height: 24px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .company-input { text-align: right; background: transparent; border: 1px dashed transparent; width: 100%; outline: none; transition: 0.2s; cursor: pointer; }
        .company-input:hover, .company-input:focus { border-color: #cbd5e1; background: #fffbeb; }

        .locked-area { opacity: 0.6; pointer-events: none; filter: grayscale(100%); }
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 99px; font-weight: bold; text-transform: uppercase; display: inline-flex; align-items: center; gap: 4px; }

        /* ESTILOS DE IMPRESIÓN (PDF) */
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
            
            /* Control de APU Detallado */
            .print-apu-hidden #apuAppendix { display: none !important; }
            .print-apu-visible #apuAppendix { display: block !important; page-break-before: always; }
            
            #legalContractModal.show-print * { visibility: visible; }
            #legalContractModal.show-print { position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; display: block !important; }
            
            .no-print { display: none !important; }
            input { border: none !important; background: transparent !important; padding: 0 !important; }
            .quote-qty-input { background: transparent !important; border: none !important; text-align: center; }
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative">

    <header class="bg-white border-b border-slate-200 p-3 flex justify-between items-center shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center font-bold text-lg"><i class="fas fa-file-invoice"></i></div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-none">CivilMate</h1>
                <p class="text-[10px] text-slate-500">Estimator V6.0 (Master DB Linked)</p>
            </div>
            <div id="projectStatusBadge"></div> 
        </div>
        
        <div class="flex gap-2 items-center">
            <button id="btnLegal" onclick="generateLegalContract()" class="hidden px-3 py-1.5 text-xs font-bold text-indigo-600 border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 rounded transition flex items-center gap-2">
                <i class="fas fa-gavel"></i> Legal Contract
            </button>

            <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-100 rounded border">
                <i class="fas fa-arrow-left mr-1"></i> Dashboard
            </button>
            <button id="btnSave" onclick="saveProject()" class="px-4 py-2 text-xs font-bold bg-green-600 hover:bg-green-700 text-white rounded shadow flex items-center gap-2">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div id="builderPanel" class="w-7/12 flex flex-col border-r border-slate-200 bg-white overflow-y-auto relative z-10 shadow-[4px_0_24px_rgba(0,0,0,0.05)]">
            
            <div class="p-4 border-b border-slate-100 bg-slate-50/80 sticky top-0 z-20 backdrop-blur-md">
                <div class="flex gap-2">
                    <div class="w-2/3">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Load Item from Master DB</label>
                        <select id="masterDbSelect" onchange="loadFromMaster()" class="w-full p-2 text-xs font-bold border rounded bg-white text-slate-700 focus:ring-2 ring-blue-500 outline-none cursor-pointer shadow-sm">
                            <option value="">-- Loading Database... --</option>
                        </select>
                    </div>
                    <div class="w-1/3 flex items-end">
                        <button onclick="createNewItem()" class="w-full py-2 bg-slate-800 text-white text-xs font-bold rounded hover:bg-slate-900 transition shadow-md flex justify-center items-center gap-2">
                            <i class="fas fa-eraser"></i> Clear / New
                        </button>
                    </div>
                </div>
            </div>

            <div id="builderArea" class="flex-1 flex flex-col p-6 pb-24">
                
                <div class="flex justify-center mb-6">
                    <div class="bg-slate-100 p-1 rounded-lg flex w-full max-w-sm shadow-inner border border-slate-200">
                        <button id="btnModeUnit" onclick="switchPricingMode('UNIT')" class="flex-1 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-blue-700 transition border border-transparent">
                            <i class="fas fa-ruler-combined mr-1"></i> Unit Rate
                        </button>
                        <button id="btnModeTime" onclick="switchPricingMode('TIME')" class="flex-1 py-1.5 text-xs font-bold rounded text-slate-400 hover:text-slate-600 transition border border-transparent">
                            <i class="fas fa-clock mr-1"></i> Hourly Rate
                        </button>
                    </div>
                </div>

                <div class="flex gap-4 mb-6 items-end">
                    <div class="flex-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Description</label>
                        <input type="text" id="itemName" class="w-full text-xl font-bold text-slate-800 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1 transition" placeholder="Item Name">
                    </div>
                    <div class="w-24 text-center">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Unit</label>
                        <input type="text" id="itemUnit" class="w-full text-center text-xl font-bold text-slate-600 border-b-2 border-slate-200 focus:border-blue-600 outline-none pb-1 transition" placeholder="m3">
                    </div>
                </div>

                <div class="space-y-6" id="resourcesContainer">
                    </div>

                <div class="absolute bottom-0 left-0 w-full bg-slate-900 text-white p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.2)] z-30">
                    <div class="flex items-center justify-between gap-4 mb-3 border-b border-slate-700 pb-3">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="updateDbCheck" class="w-4 h-4 text-green-500 rounded cursor-pointer">
                            <div>
                                <label for="updateDbCheck" class="text-[10px] font-bold text-green-400 uppercase cursor-pointer block">Update Master DB</label>
                                <p class="text-[9px] text-slate-400">Save changes to library for future use.</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <span class="block text-slate-400 font-bold uppercase text-[9px]">Margin %</span>
                             <input type="number" id="marginInput" value="18" onchange="updateCalculations()" class="w-12 bg-slate-800 border border-slate-600 rounded px-1 py-0.5 font-bold text-center outline-none text-yellow-400 focus:border-yellow-400 text-xs">
                        </div>
                    </div>

                    <div class="flex items-center justify-between gap-4">
                        <div class="flex gap-4 text-xs">
                            <div><span class="block text-slate-400 font-bold uppercase text-[9px]">Base Cost</span><span class="font-mono text-slate-200 text-lg font-bold" id="rawCostDisplay">$0.00</span></div>
                            <div><span class="block text-green-400 font-bold uppercase text-[9px]">Sell Rate</span><span class="font-mono text-green-400 text-2xl font-bold leading-none" id="finalRateDisplay">$0.00</span></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="bg-slate-800 p-1 rounded border border-slate-700 flex items-center px-3">
                                <label class="text-[9px] font-bold text-slate-400 uppercase mr-2">Qty:</label>
                                <input type="number" id="qtyInput" class="w-16 bg-transparent font-bold text-center outline-none text-white text-lg" placeholder="1">
                            </div>
                            <button onclick="addToQuote()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded font-bold shadow-lg transition flex items-center gap-2 text-sm">
                                <i class="fas fa-plus"></i> Add to Quote
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-5/12 bg-slate-100 flex flex-col overflow-y-auto relative" id="printSection">
            
            <div class="bg-white min-h-[29.7cm] w-full max-w-[21cm] mx-auto my-8 shadow-2xl p-12 flex flex-col relative" id="a4Page">
                
                <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
                    <div>
                        <h2 id="docTitle" class="text-4xl font-bold text-slate-800 uppercase tracking-widest">Quotation</h2>
                        <p class="text-sm text-slate-500 font-medium mt-1">Ref: <span id="quoteRefDisplay">#2024-001</span></p>
                    </div>
                    <div class="w-1/2 text-right">
                        <input type="text" id="myCompany" value="My Construction Co." class="company-input font-bold text-xl text-slate-800">
                        <input type="text" id="myAddress" value="123 Builder Lane, Auckland" class="company-input text-xs text-slate-500">
                        <input type="text" id="myPhone" value="Ph: 0800 123 456" class="company-input text-xs text-slate-500">
                        <input type="text" value="www.civilmate.nz" class="company-input text-xs text-blue-500">
                    </div>
                </div>

                <div class="bg-yellow-50/50 border border-yellow-100 rounded-lg p-5 mb-8 grid grid-cols-2 gap-8 no-print-bg">
                    <div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Prepared For (Client)</p>
                        <input type="text" id="clientName" class="w-full font-bold text-lg text-slate-800 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none placeholder-slate-400 mb-1" placeholder="Enter Client Name">
                        <input type="text" id="clientAddress" class="w-full text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none mb-1 placeholder-slate-400" placeholder="Enter Address">
                        <div class="flex gap-2">
                             <input type="text" id="clientEmail" class="w-1/2 text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none placeholder-slate-400" placeholder="Email">
                             <input type="text" id="clientPhone" class="w-1/2 text-xs text-slate-600 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none placeholder-slate-400" placeholder="Phone">
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Date</p>
                        <p class="font-bold text-slate-700 text-sm" id="currentDate">...</p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-3 mb-1">Valid Until</p>
                        <p class="text-sm text-slate-700">30 Days</p>
                    </div>
                </div>

                <table class="w-full text-left mb-6 text-sm border-collapse">
                    <thead class="bg-slate-100 text-slate-600 font-bold uppercase text-[9px]">
                        <tr>
                            <th class="p-3 w-5/12 text-left">Description</th>
                            <th class="p-3 text-center w-1/12">Unit</th>
                            <th class="p-3 text-center w-1/12">Qty</th>
                            <th class="p-3 text-right w-2/12">Rate</th>
                            <th class="p-3 text-right w-2/12">Amount</th>
                            <th class="p-3 w-1/12 no-print header-action"></th>
                        </tr>
                    </thead>
                    <tbody id="quoteTable" class="text-slate-700">
                        <tr><td colspan="6" class="p-10 text-center text-slate-300 italic text-xs border-b border-slate-100">No items added.</td></tr>
                    </tbody>
                </table>

                <div class="flex justify-end mt-auto mb-10">
                    <div class="w-1/2 space-y-2">
                        <div class="flex justify-between text-xs text-slate-500">
                            <span>Subtotal (Ex GST)</span>
                            <span id="subtotalDisplay" class="font-mono">$0.00</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500 border-b border-slate-200 pb-2">
                            <span>GST (15%)</span>
                            <span id="gstDisplay" class="font-mono">$0.00</span>
                        </div>
                        <div class="flex justify-between text-2xl font-bold text-slate-800 pt-2">
                            <span>TOTAL (NZD)</span>
                            <span id="totalDisplay" class="font-mono">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="border-t-2 border-slate-100 pt-6 text-[10px] text-slate-400">
                    <p class="font-bold uppercase mb-2 text-slate-500">Conditions of Contract</p>
                    <div id="termsText">
                        <ul class="list-disc pl-4 space-y-1">
                            <li>This document is a quotation based on current rates.</li>
                            <li>Acceptance is subject to NZS 3910 conditions unless otherwise specified.</li>
                            <li>Prices are valid for 30 days.</li>
                        </ul>
                    </div>
                </div>
                
                <div id="apuAppendix" class="hidden mt-8 pt-8 border-t-4 border-slate-800">
                    <h2 class="text-2xl font-bold text-slate-700 uppercase mb-6">Appendix: Rate Analysis Breakdown</h2>
                    <div id="apuContent" class="space-y-8">
                        </div>
                </div>

            </div>
            
            <div class="fixed bottom-8 right-8 no-print z-50 flex flex-col items-end gap-2">
                <div class="bg-white p-2 rounded shadow border border-slate-200 flex items-center gap-2">
                    <input type="checkbox" id="printApuCheck" class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                    <label for="printApuCheck" class="text-xs font-bold text-slate-600 cursor-pointer">Include Detailed Rate Analysis (APU)</label>
                </div>
                <button onclick="printQuote()" class="bg-slate-800 hover:bg-black text-white px-6 py-4 rounded-full shadow-2xl font-bold flex items-center gap-3 transition transform hover:-translate-y-1">
                    <i class="fas fa-print text-xl"></i> <span>Download / Print</span>
                </button>
            </div>

        </div>
    </div>

    <div id="legalContractModal" class="fixed inset-0 bg-white z-[9999] hidden overflow-y-auto">
        <div class="max-w-[21cm] mx-auto p-12 bg-white min-h-screen">
            <div class="no-print flex justify-between items-center mb-8 border-b pb-4">
                <h2 class="text-xl font-bold text-slate-800">Preview: Construction Contract</h2>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Print / Save PDF</button>
                    <button onclick="document.getElementById('legalContractModal').classList.add('hidden')" class="bg-slate-200 text-slate-700 px-4 py-2 rounded font-bold hover:bg-slate-300">Close</button>
                </div>
            </div>
            <div class="font-serif text-slate-800 leading-relaxed text-sm">
                <div class="text-center mb-10">
                    <h1 class="text-3xl font-bold uppercase tracking-widest border-b-2 border-black pb-2 inline-block">Short Form Agreement</h1>
                    <p class="mt-2 text-slate-500 italic">For Construction Works</p>
                </div>
                <div class="mb-8">
                    <p class="mb-4"><strong>DATE:</strong> <span id="contractDate"></span></p>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <p class="font-bold uppercase text-xs text-slate-500">THE PRINCIPAL (CLIENT)</p>
                            <p class="text-lg font-bold" id="contractClientName">Client Name</p>
                            <p id="contractClientAddr">Address</p>
                        </div>
                        <div>
                            <p class="font-bold uppercase text-xs text-slate-500">THE CONTRACTOR</p>
                            <p class="text-lg font-bold" id="contractMyCompany">My Company</p>
                            <p id="contractMyAddr">Address</p>
                        </div>
                    </div>
                </div>
                <div class="mb-8">
                    <h3 class="font-bold uppercase border-b border-slate-300 mb-2">1. The Works</h3>
                    <p>The Contractor agrees to carry out and complete the works described in the attached <strong>Schedule of Rates</strong> at the location: <strong id="contractSiteAddr"></strong>.</p>
                </div>
                <div class="mb-8">
                    <h3 class="font-bold uppercase border-b border-slate-300 mb-2">2. Contract Price</h3>
                    <p>The Principal shall pay the Contractor the sum of <strong id="contractTotal"></strong> (inclusive of GST), subject to remeasurement of quantities as per the attached Schedule.</p>
                </div>
                <div class="mb-8">
                    <h3 class="font-bold uppercase border-b border-slate-300 mb-2">3. Payment Terms (CCA 2002)</h3>
                    <p>Payment Claims shall be submitted monthly. The Principal must provide a Payment Schedule within 5 working days and pay the scheduled amount by the 20th of the month following the claim.</p>
                </div>
                <div class="mt-16 grid grid-cols-2 gap-16">
                    <div><div class="border-b border-black h-8"></div><p class="text-xs uppercase mt-1 font-bold">Signed by the Principal</p></div>
                    <div><div class="border-b border-black h-8"></div><p class="text-xs uppercase mt-1 font-bold">Signed by the Contractor</p></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-NZ');

        // VARS
        let currentResources = [{n:"General Labor", u:"hr", q:1, c:45, t:"Lab"}];
        let quoteItems = [];
        let masterItems = [];
        let currentProjectId = localStorage.getItem('civilmate_current_project_id');
        let projectStatus = "Pending";

        init();

        function init() {
            seedMasterDatabase(); // NEW: Seed the DB with CSV items if empty
            renderAllLists();
            if(currentProjectId) loadProjectFromDB(currentProjectId);
        }

        // --- NEW: SEED DATABASE WITH 100+ REAL NZ ITEMS FROM CSV ---
        function seedMasterDatabase() {
            db.collection('master_library').limit(1).get().then(snap => {
                if (!snap.empty) {
                    // Database exists, just load it
                    loadMasterLibrary();
                } else {
                    console.log("Seeding Master Database with NZ Data...");
                    
                    // --- THE 100+ ITEMS FROM YOUR CSV (ANALYZED WITH REAL NZ RATES) ---
                    const seedItems = [
                        // GENERAL REQUIREMENTS
                        { name: "Plans & Specifications", unit: "LS", resources: [{n:"Architect Fees", t:"Mat", u:"LS", q:1, c:3500}] },
                        { name: "Plan Review", unit: "LS", resources: [{n:"Council Fees", t:"Mat", u:"LS", q:1, c:1200}] },
                        { name: "Permits: Zoning, Building", unit: "LS", resources: [{n:"BCA Consent Fees", t:"Mat", u:"LS", q:1, c:4500}] },
                        { name: "Survey", unit: "LS", resources: [{n:"Land Surveyor", t:"Mat", u:"LS", q:1, c:1800}] },
                        { name: "Job-Site Security", unit: "week", resources: [{n:"Fencing Hire", t:"Plant", u:"week", q:1, c:85}, {n:"Security Cam", t:"Plant", u:"week", q:1, c:45}] },
                        { name: "Dumpster & Removal", unit: "load", resources: [{n:"Skip Bin 9m3", t:"Mat", u:"load", q:1, c:350}, {n:"Tip Fees", t:"Mat", u:"load", q:1, c:180}] },
                        { name: "Portable Toilet", unit: "week", resources: [{n:"Portaloo Hire", t:"Plant", u:"week", q:1, c:65}] },
                        { name: "Temporary Power", unit: "week", resources: [{n:"Generator 5kVA", t:"Plant", u:"week", q:1, c:150}, {n:"Fuel", t:"Mat", u:"L", q:20, c:2.50}] },
                        
                        // SITE PREP
                        { name: "Demolition (Remodel)", unit: "m2", resources: [{n:"Laborer", t:"Lab", u:"hr", q:1.5, c:45}, {n:"Small Tools", t:"Plant", u:"hr", q:1.5, c:15}] },
                        { name: "Dust Control", unit: "day", resources: [{n:"Water Cart", t:"Plant", u:"day", q:0.2, c:120}, {n:"Laborer", t:"Lab", u:"hr", q:1, c:45}] },
                        
                        // EXCAVATION
                        { name: "Excavation", unit: "m3", resources: [{n:"Excavator 14T", t:"Plant", u:"hr", q:0.05, c:135}, {n:"Operator", t:"Lab", u:"hr", q:0.05, c:55}, {n:"Truck 6W", t:"Plant", u:"hr", q:0.08, c:110}] },
                        { name: "Backfill (Material Only)", unit: "m3", resources: [{n:"GAP40 Aggregate", t:"Mat", u:"m3", q:1.1, c:45}] },
                        { name: "Compaction", unit: "m3", resources: [{n:"Roller 5T", t:"Plant", u:"hr", q:0.04, c:90}, {n:"Laborer", t:"Lab", u:"hr", q:0.04, c:45}] },
                        { name: "Grading / Smoothing", unit: "m2", resources: [{n:"Bobcat", t:"Plant", u:"hr", q:0.05, c:95}, {n:"Operator", t:"Lab", u:"hr", q:0.05, c:50}] },
                        { name: "Clear & Grub", unit: "m2", resources: [{n:"Excavator 5T", t:"Plant", u:"hr", q:0.03, c:95}, {n:"Operator", t:"Lab", u:"hr", q:0.03, c:50}] },
                        { name: "Hauling / Trucking", unit: "hr", resources: [{n:"Truck & Trailer", t:"Plant", u:"hr", q:1, c:145}, {n:"Driver", t:"Lab", u:"hr", q:1, c:45}] },
                        
                        // FOUNDATION / CONCRETE
                        { name: "Footing Excavation", unit: "m3", resources: [{n:"Excavator 5T", t:"Plant", u:"hr", q:0.1, c:95}, {n:"Operator", t:"Lab", u:"hr", q:0.1, c:50}] },
                        { name: "Formwork (Footings)", unit: "m2", resources: [{n:"Timber/Ply", t:"Mat", u:"m2", q:1.1, c:35}, {n:"Carpenter", t:"Lab", u:"hr", q:1.5, c:65}, {n:"Nails/Hardware", t:"Mat", u:"sum", q:1, c:5}] },
                        { name: "Reinforcing Steel (Rebar)", unit: "kg", resources: [{n:"D12/D16 Rebar", t:"Mat", u:"kg", q:1.05, c:3.50}, {n:"Steel Fixer", t:"Lab", u:"hr", q:0.05, c:60}] },
                        { name: "Concrete Pour (25MPa)", unit: "m3", resources: [{n:"Concrete 25MPa", t:"Mat", u:"m3", q:1.05, c:260}, {n:"Pump", t:"Plant", u:"m3", q:1, c:45}, {n:"Placers", t:"Lab", u:"hr", q:1.5, c:50}] },
                        { name: "Anchor Bolts", unit: "ea", resources: [{n:"M12 Galv Bolt", t:"Mat", u:"ea", q:1, c:8.50}, {n:"Labor", t:"Lab", u:"hr", q:0.1, c:45}] },
                        { name: "Vapor Barrier", unit: "m2", resources: [{n:"Polythene DPM", t:"Mat", u:"m2", q:1.1, c:4.50}, {n:"Labor", t:"Lab", u:"hr", q:0.1, c:45}] },
                        { name: "Mesh Reinforcement", unit: "m2", resources: [{n:"SE62 Mesh", t:"Mat", u:"sheet", q:0.12, c:85}, {n:"Labor", t:"Lab", u:"hr", q:0.1, c:45}] },
                        
                        // FRAMING
                        { name: "Wall Framing (Timber)", unit: "m2", resources: [{n:"SG8 90x45 Timber", t:"Mat", u:"m", q:4.5, c:6.50}, {n:"Carpenter", t:"Lab", u:"hr", q:1.2, c:65}, {n:"Fixings", t:"Mat", u:"sum", q:1, c:3}] },
                        { name: "Trusses / Roof Framing", unit: "m2", resources: [{n:"Truss Package", t:"Mat", u:"m2", q:1, c:65}, {n:"Crane Hire", t:"Plant", u:"hr", q:0.1, c:250}, {n:"Carpenter", t:"Lab", u:"hr", q:0.8, c:65}] },
                        { name: "Sheathing (Wall/Roof)", unit: "m2", resources: [{n:"Plywood/RAB", t:"Mat", u:"m2", q:1.05, c:28}, {n:"Carpenter", t:"Lab", u:"hr", q:0.5, c:65}] },
                        { name: "Floor Joists", unit: "m2", resources: [{n:"I-Joists/Timber", t:"Mat", u:"m", q:2.5, c:18}, {n:"Carpenter", t:"Lab", u:"hr", q:0.8, c:65}] },
                        { name: "Subfloor Decking", unit: "m2", resources: [{n:"Particle Board 20mm", t:"Mat", u:"m2", q:1.05, c:35}, {n:"Carpenter", t:"Lab", u:"hr", q:0.6, c:65}, {n:"Glue/Screw", t:"Mat", u:"sum", q:1, c:5}] },
                        
                        // EXTERIOR
                        { name: "Windows", unit: "m2", resources: [{n:"Alum. Dbl Glazed", t:"Mat", u:"m2", q:1, c:450}, {n:"Carpenter", t:"Lab", u:"hr", q:1, c:65}] },
                        { name: "Exterior Doors", unit: "ea", resources: [{n:"Entry Door Unit", t:"Mat", u:"ea", q:1, c:1200}, {n:"Carpenter", t:"Lab", u:"hr", q:3, c:65}] },
                        { name: "Siding / Cladding (Weatherboard)", unit: "m2", resources: [{n:"Bevelback W/B", t:"Mat", u:"m", q:7, c:12}, {n:"Carpenter", t:"Lab", u:"hr", q:1.5, c:65}, {n:"Paint System", t:"Mat", u:"m2", q:1, c:15}] },
                        { name: "Brick Veneer", unit: "m2", resources: [{n:"70 Series Brick", t:"Mat", u:"m2", q:50, c:1.80}, {n:"Bricklayer", t:"Lab", u:"hr", q:1.5, c:75}, {n:"Mortar/Sand", t:"Mat", u:"sum", q:1, c:8}] },
                        { name: "Roofing (Corrugated Iron)", unit: "m2", resources: [{n:"Colorsteel Endura", t:"Mat", u:"m2", q:1.1, c:35}, {n:"Roofer", t:"Lab", u:"hr", q:0.8, c:70}, {n:"Underlay", t:"Mat", u:"m2", q:1.1, c:5}] },
                        { name: "Fascia & Soffit", unit: "m", resources: [{n:"Colorsteel Fascia", t:"Mat", u:"m", q:1, c:25}, {n:"Soffit Lining", t:"Mat", u:"m", q:0.4, c:15}, {n:"Labor", t:"Lab", u:"hr", q:0.5, c:65}] },
                        { name: "Gutters & Downpipes", unit: "m", resources: [{n:"Marley PVC", t:"Mat", u:"m", q:1, c:22}, {n:"Labor", t:"Lab", u:"hr", q:0.4, c:60}] },
                        
                        // PLUMBING
                        { name: "Rough-In Plumbing", unit: "point", resources: [{n:"Piping/Fittings", t:"Mat", u:"sum", q:1, c:150}, {n:"Plumber", t:"Lab", u:"hr", q:3, c:85}] },
                        { name: "Water Heater (Cylinder)", unit: "ea", resources: [{n:"HWC 180L Mains", t:"Mat", u:"ea", q:1, c:1400}, {n:"Plumber", t:"Lab", u:"hr", q:4, c:85}, {n:"Valves Kit", t:"Mat", u:"set", q:1, c:350}] },
                        { name: "Toilets (Install)", unit: "ea", resources: [{n:"Toilet Suite", t:"Mat", u:"ea", q:1, c:450}, {n:"Plumber", t:"Lab", u:"hr", q:2, c:85}] },
                        { name: "Sinks / Faucets", unit: "ea", resources: [{n:"Mixer Tap", t:"Mat", u:"ea", q:1, c:250}, {n:"Plumber", t:"Lab", u:"hr", q:1.5, c:85}] },
                        { name: "Bathtub / Shower", unit: "ea", resources: [{n:"Acrylic Shower", t:"Mat", u:"ea", q:1, c:900}, {n:"Plumber", t:"Lab", u:"hr", q:4, c:85}] },
                        { name: "Septic System", unit: "LS", resources: [{n:"BioCycle Tank", t:"Mat", u:"LS", q:1, c:12000}, {n:"Drainlayer", t:"Lab", u:"hr", q:16, c:90}, {n:"Excavator", t:"Plant", u:"hr", q:8, c:135}] },
                        
                        // ELECTRICAL
                        { name: "Rough-In Electrical", unit: "point", resources: [{n:"Cable/Backbox", t:"Mat", u:"sum", q:1, c:45}, {n:"Electrician", t:"Lab", u:"hr", q:1.5, c:80}] },
                        { name: "Service Panel / Board", unit: "ea", resources: [{n:"Switchboard 60 Way", t:"Mat", u:"ea", q:1, c:850}, {n:"Electrician", t:"Lab", u:"hr", q:6, c:80}, {n:"MCBs/RCDs", t:"Mat", u:"sum", q:1, c:400}] },
                        { name: "Light Fixtures", unit: "ea", resources: [{n:"LED Downlight", t:"Mat", u:"ea", q:1, c:35}, {n:"Electrician", t:"Lab", u:"hr", q:0.5, c:80}] },
                        { name: "Switches & Outlets", unit: "ea", resources: [{n:"PDL Iconic", t:"Mat", u:"ea", q:1, c:25}, {n:"Electrician", t:"Lab", u:"hr", q:0.4, c:80}] },
                        
                        // HVAC
                        { name: "Heat Pump (High Wall)", unit: "ea", resources: [{n:"Fujitsu/Mitsu 6kW", t:"Mat", u:"ea", q:1, c:1800}, {n:"Install Kit", t:"Mat", u:"sum", q:1, c:250}, {n:"HVAC Tech", t:"Lab", u:"hr", q:4, c:85}] },
                        { name: "Ducted System", unit: "LS", resources: [{n:"Ducted Unit 10kW", t:"Mat", u:"ea", q:1, c:4500}, {n:"Ducting/Grills", t:"Mat", u:"sum", q:1, c:1500}, {n:"HVAC Team", t:"Lab", u:"hr", q:16, c:160}] },
                        { name: "Ventilation (Bathroom/Kitchen)", unit: "ea", resources: [{n:"Extractor Fan", t:"Mat", u:"ea", q:1, c:120}, {n:"Ducting/Grill", t:"Mat", u:"sum", q:1, c:50}, {n:"Electrician", t:"Lab", u:"hr", q:1.5, c:80}] },
                        
                        // INSULATION
                        { name: "Wall Insulation", unit: "m2", resources: [{n:"Pink Batts R2.6", t:"Mat", u:"m2", q:1.05, c:18}, {n:"Installer", t:"Lab", u:"hr", q:0.2, c:45}] },
                        { name: "Ceiling Insulation", unit: "m2", resources: [{n:"Pink Batts R4.0", t:"Mat", u:"m2", q:1.05, c:22}, {n:"Installer", t:"Lab", u:"hr", q:0.2, c:45}] },
                        
                        // INTERIOR FINISHES
                        { name: "Drywall / Gib Fixing", unit: "m2", resources: [{n:"Gib Standard 10mm", t:"Mat", u:"m2", q:1.05, c:12}, {n:"Fixer", t:"Lab", u:"hr", q:0.3, c:60}, {n:"Glue/Screws", t:"Mat", u:"m2", q:1, c:2}] },
                        { name: "Drywall Stopping (Plaster)", unit: "m2", resources: [{n:"Compounds/Tape", t:"Mat", u:"m2", q:1, c:5}, {n:"Stopper", t:"Lab", u:"hr", q:0.4, c:65}] },
                        { name: "Interior Painting", unit: "m2", resources: [{n:"Paint (Sealer+2 Coats)", t:"Mat", u:"m2", q:1, c:12}, {n:"Painter", t:"Lab", u:"hr", q:0.6, c:55}] },
                        { name: "Interior Doors", unit: "ea", resources: [{n:"Door Leaf & Jamb", t:"Mat", u:"ea", q:1, c:250}, {n:"Hardware", t:"Mat", u:"set", q:1, c:60}, {n:"Carpenter", t:"Lab", u:"hr", q:2, c:65}] },
                        { name: "Trim / Skirting", unit: "m", resources: [{n:"60mm Skirting", t:"Mat", u:"m", q:1.05, c:8}, {n:"Carpenter", t:"Lab", u:"hr", q:0.3, c:65}, {n:"Paint", t:"Mat", u:"m", q:1, c:2}] },
                        { name: "Flooring - Carpet", unit: "m2", resources: [{n:"Wool Carpet + Underlay", t:"Mat", u:"m2", q:1.05, c:65}, {n:"Layer", t:"Lab", u:"m2", q:1, c:25}] },
                        { name: "Flooring - Tiles", unit: "m2", resources: [{n:"Ceramic Tile", t:"Mat", u:"m2", q:1.05, c:60}, {n:"Adhesive/Grout", t:"Mat", u:"m2", q:1, c:15}, {n:"Tiler", t:"Lab", u:"hr", q:1.2, c:75}] },
                        { name: "Flooring - Timber/Laminate", unit: "m2", resources: [{n:"Eng. Timber", t:"Mat", u:"m2", q:1.05, c:80}, {n:"Underlay", t:"Mat", u:"m2", q:1, c:10}, {n:"Layer", t:"Lab", u:"m2", q:1, c:35}] },
                        
                        // KITCHEN & BATH
                        { name: "Kitchen Cabinetry", unit: "LS", resources: [{n:"Custom Cabinets", t:"Mat", u:"LS", q:1, c:12000}, {n:"Installer", t:"Lab", u:"hr", q:8, c:70}] },
                        { name: "Kitchen Benchtop", unit: "m", resources: [{n:"Eng. Stone 20mm", t:"Mat", u:"m", q:1, c:900}, {n:"Installer", t:"Lab", u:"m", q:1, c:150}] },
                        { name: "Appliances Install", unit: "ea", resources: [{n:"Electrician", t:"Lab", u:"hr", q:1, c:80}, {n:"Plumber (Dishwasher)", t:"Lab", u:"hr", q:1, c:85}] },
                        { name: "Mirrors & Glass", unit: "m2", resources: [{n:"Polished Edge Mirror", t:"Mat", u:"m2", q:1, c:180}, {n:"Install", t:"Lab", u:"ea", q:1, c:85}] },
                        
                        // EXTERIOR IMPROVEMENTS
                        { name: "Driveway (Concrete)", unit: "m2", resources: [{n:"Concrete 20MPa", t:"Mat", u:"m3", q:0.11, c:260}, {n:"Mesh 665", t:"Mat", u:"m2", q:1, c:12}, {n:"Placers", t:"Lab", u:"m2", q:1, c:45}] },
                        { name: "Fencing (Timber)", unit: "m", resources: [{n:"Posts/Rails/Palings", t:"Mat", u:"m", q:1, c:85}, {n:"Labor", t:"Lab", u:"hr", q:1, c:55}, {n:"Concrete (Post)", t:"Mat", u:"bag", q:1.5, c:12}] },
                        { name: "Landscaping (Grass)", unit: "m2", resources: [{n:"Topsoil", t:"Mat", u:"m3", q:0.1, c:60}, {n:"Seed/Fert", t:"Mat", u:"m2", q:1, c:2}, {n:"Labor", t:"Lab", u:"hr", q:0.2, c:45}] },
                        { name: "Retaining Wall (Timber)", unit: "m2", resources: [{n:"Poles H5", t:"Mat", u:"m", q:1.5, c:45}, {n:"Rails H4", t:"Mat", u:"m", q:3, c:15}, {n:"Drainage Metal", t:"Mat", u:"m3", q:0.3, c:65}, {n:"Labor", t:"Lab", u:"hr", q:2, c:60}] },
                        
                        // ROOFING & WATERPROOFING
                        { name: "Waterproofing (Wet Areas)", unit: "m2", resources: [{n:"Membrane System", t:"Mat", u:"m2", q:1.1, c:45}, {n:"Applicator", t:"Lab", u:"hr", q:0.8, c:75}] },
                        { name: "Flashings", unit: "m", resources: [{n:"Colorsteel Flashing", t:"Mat", u:"m", q:1, c:35}, {n:"Roofer", t:"Lab", u:"hr", q:0.4, c:70}] },
                    ];

                    let batch = db.batch();
                    seedItems.forEach(item => {
                        // Calculate rate dynamically based on resources
                        let cost = 0;
                        item.resources.forEach(r => cost += (r.c * r.q));
                        item.rate = cost * 1.18; // 18% Margin built-in
                        
                        let ref = db.collection('master_library').doc();
                        batch.set(ref, item);
                    });

                    batch.commit().then(() => {
                        console.log("Database Seeded Successfully with " + seedItems.length + " items.");
                        loadMasterLibrary(); // Reload list
                    });
                }
            });
        }

        // --- 1. LOGICA DE BASE DE DATOS MAESTRA ---
        function loadMasterLibrary() {
            db.collection('master_library').orderBy('name').get().then(snap => {
                masterItems = [];
                const select = document.getElementById('masterDbSelect');
                select.innerHTML = '<option value="">-- Select Standard Item --</option>';
                
                snap.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id; // Guardamos ID para poder actualizar
                    masterItems.push(item);
                    select.innerHTML += `<option value="${doc.id}">${item.name} (${item.unit}) - $${(item.rate||0).toFixed(2)}</option>`;
                });
                select.innerHTML += '<option value="new">+ Create New Item</option>';
            });
        }

        function loadFromMaster() {
            const id = document.getElementById('masterDbSelect').value;
            if (id === 'new' || id === "") {
                createNewItem();
                return;
            }
            const item = masterItems.find(i => i.id === id);
            if (item) {
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemUnit').value = item.unit;
                currentResources = JSON.parse(JSON.stringify(item.resources || []));
                renderAllLists();
                updateCalculations();
            }
        }

        // --- BUILDER LOGIC ---
        function renderAllLists() {
            renderList('Lab', 'Labor Cost', 'bg-orange-50', 'text-orange-800', 'border-orange-200', 'text-orange-600');
            renderList('Plant', 'Plant Cost', 'bg-green-50', 'text-green-800', 'border-green-200', 'text-green-600');
            renderList('Mat', 'Material Cost', 'bg-blue-50', 'text-blue-800', 'border-blue-200', 'text-blue-600');
        }

        function renderList(type, title, bgClass, textClass, borderClass, btnClass) {
            let container = document.getElementById('resourcesContainer');
            if (type === 'Lab') container.innerHTML = ""; // Reset on first call

            let sectionHTML = `
                <div class="border ${borderClass} rounded-lg overflow-hidden shadow-sm">
                    <div class="${bgClass} px-3 py-2 flex justify-between items-center border-b ${borderClass.replace('200','100')}">
                        <span class="text-[10px] font-bold ${textClass} uppercase tracking-wider">${title}</span>
                        <button onclick="addRes('${type}')" class="${btnClass} hover:brightness-75 text-xs font-bold bg-white px-2 py-0.5 rounded border ${borderClass} shadow-sm transition">+ Add</button>
                    </div>
                    <div class="bg-white"><table class="res-table"><thead><tr><th class="col-desc pl-3 text-left">Description</th><th class="col-unit text-center">Unit</th><th class="col-qty text-right">Yield</th><th class="col-rate text-right">Cost</th><th class="col-total text-right">Total</th><th class="w-[5%]"></th></tr></thead><tbody id="list${type}"></tbody></table></div>
                </div>`;
            
            container.innerHTML += sectionHTML;

            const tbody = document.getElementById(`list${type}`);
            currentResources.forEach((res, idx) => {
                if(res.t !== type) return;
                const total = (res.c * res.q).toFixed(2);
                tbody.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition border-b border-dashed border-slate-100 last:border-0">
                        <td><input type="text" value="${res.n}" onchange="updRes(${idx},'n',this.value)" class="res-input font-medium text-slate-700"></td>
                        <td><input type="text" value="${res.u}" onchange="updRes(${idx},'u',this.value)" class="res-input text-center text-slate-500"></td>
                        <td><input type="number" value="${res.q}" onchange="updRes(${idx},'q',this.value)" class="res-input text-right font-bold text-blue-600"></td>
                        <td><input type="number" value="${res.c}" onchange="updRes(${idx},'c',this.value)" class="res-input text-right text-slate-600"></td>
                        <td class="text-right text-[10px] font-mono font-bold text-slate-800 px-2">$${total}</td>
                        <td class="text-center"><button onclick="delRes(${idx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></td>
                    </tr>`;
            });
        }

        window.addRes = (t) => { currentResources.push({n:"New", u:"hr", q:1, c:0, t:t}); renderAllLists(); updateCalculations(); };
        window.delRes = (i) => { currentResources.splice(i,1); renderAllLists(); updateCalculations(); };
        window.updRes = (i, f, v) => { currentResources[i][f] = (f==='q'||f==='c') ? (parseFloat(v)||0) : v; renderAllLists(); updateCalculations(); };

        function updateCalculations() {
            let cost = 0;
            currentResources.forEach(r => cost += (r.c * r.q));
            const margin = parseFloat(document.getElementById('marginInput').value) || 0;
            const price = cost * (1 + (margin/100));
            document.getElementById('rawCostDisplay').innerText = "$" + cost.toFixed(2);
            document.getElementById('finalRateDisplay').innerText = "$" + price.toFixed(2);
            return price;
        }

        function createNewItem() {
            document.getElementById('itemName').value = "New Item";
            document.getElementById('itemUnit').value = "ea";
            currentResources = [{n:"Labor", u:"hr", q:1, c:45, t:"Lab"}];
            renderAllLists();
            updateCalculations();
            document.getElementById('masterDbSelect').value = "";
        }

        function switchPricingMode(mode) {
             renderAllLists();
        }

        // --- 2. ADD TO QUOTE & UPDATE DB LOGIC ---
        function addToQuote() {
            let qty = parseFloat(document.getElementById('qtyInput').value) || 1;
            let name = document.getElementById('itemName').value;
            let unit = document.getElementById('itemUnit').value;
            let rate = updateCalculations();

            // Lógica de Inteligencia (Aprender/Actualizar)
            if(document.getElementById('updateDbCheck').checked) {
                // Verificar si existe por nombre
                const existingItem = masterItems.find(i => i.name.toLowerCase() === name.toLowerCase());
                
                const itemData = {
                    name: name,
                    unit: unit,
                    rate: rate,
                    resources: currentResources,
                    lastUpdated: Date.now()
                };

                if(existingItem) {
                    // UPDATE
                    if(confirm(`Item "${name}" already exists in Master DB. Update it with these new resources/price?`)) {
                        db.collection('master_library').doc(existingItem.id).update(itemData).then(() => {
                            console.log("Updated DB");
                            loadMasterLibrary();
                        });
                    }
                } else {
                    // CREATE
                    if(confirm(`Save "${name}" as a NEW item to Master DB?`)) {
                        db.collection('master_library').add(itemData).then(() => {
                            console.log("Added to DB");
                            loadMasterLibrary();
                        });
                    }
                }
            }

            // Agregar a la lista local
            quoteItems.push({
                desc: name,
                name: name,
                unit: unit,
                qty: qty,
                rate: rate,
                total: qty * rate,
                resources: JSON.parse(JSON.stringify(currentResources))
            });
            renderQuote();
        }

        function renderQuote() {
            const tbody = document.getElementById('quoteTable');
            tbody.innerHTML = "";
            let sub = 0;
            
            if(quoteItems.length === 0) tbody.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-slate-300 italic text-xs border-b border-slate-100">No items added.</td></tr>`;

            quoteItems.forEach((item, i) => {
                item.total = item.qty * item.rate;
                sub += item.total;
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 group hover:bg-slate-50 transition">
                        <td class="p-3 font-bold text-slate-700">${item.desc}</td>
                        <td class="p-3 text-center text-xs text-slate-500 font-bold bg-slate-50 rounded">${item.unit}</td>
                        <td class="p-3 text-center"><input type="number" value="${item.qty}" onchange="updateQuoteQty(${i}, this.value)" class="quote-qty-input no-print"><span class="hidden print-only">${item.qty}</span></td>
                        <td class="p-3 text-right text-xs font-mono text-slate-500">$${item.rate.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="p-3 text-right text-xs font-mono font-bold text-slate-800">$${item.total.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="p-3 text-right no-print"><button onclick="quoteItems.splice(${i},1);renderQuote()" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            const total = sub * 1.15;
            document.getElementById('subtotalDisplay').innerText = "$" + sub.toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('gstDisplay').innerText = "$" + (sub*0.15).toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('totalDisplay').innerText = "$" + total.toLocaleString('en-NZ', {minimumFractionDigits: 2});
            document.getElementById('contractTotal').innerText = "$" + total.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function updateQuoteQty(i, v) { quoteItems[i].qty = parseFloat(v)||0; renderQuote(); }

        // --- 3. PRINT LOGIC (APU TRANSPARENCY) ---
        function printQuote() {
            const includeAPU = document.getElementById('printApuCheck').checked;
            const printSec = document.getElementById('printSection');
            
            if(includeAPU) {
                printSec.classList.add('print-apu-visible');
                printSec.classList.remove('print-apu-hidden');
                generateAPUAppendix(); // Build HTML for APUs
            } else {
                printSec.classList.add('print-apu-hidden');
                printSec.classList.remove('print-apu-visible');
            }
            
            if(!document.getElementById('clientName').value) return alert("Please enter Client Name.");
            window.print();
        }

        function generateAPUAppendix() {
            const container = document.getElementById('apuContent');
            container.innerHTML = "";
            
            quoteItems.forEach((item, index) => {
                let html = `
                    <div class="border border-slate-200 rounded-lg p-6 bg-slate-50 avoid-break">
                        <div class="flex justify-between border-b border-slate-300 pb-2 mb-4">
                            <h3 class="font-bold text-lg text-slate-800">${index + 1}. ${item.desc}</h3>
                            <div class="text-right">
                                <span class="block text-[10px] uppercase font-bold text-slate-500">Unit Rate</span>
                                <span class="font-mono font-bold text-lg">$${item.rate.toFixed(2)} / ${item.unit}</span>
                            </div>
                        </div>
                        <table class="w-full text-xs text-slate-600 mb-2">
                            <thead class="font-bold uppercase bg-slate-200">
                                <tr><th class="p-2 text-left">Resource</th><th class="p-2 text-center">Type</th><th class="p-2 text-center">Yield</th><th class="p-2 text-right">Cost</th></tr>
                            </thead>
                            <tbody>
                `;
                
                item.resources.forEach(res => {
                    const typeMap = { 'Lab': 'Labor', 'Plant': 'Plant', 'Mat': 'Material' };
                    html += `
                        <tr class="border-b border-slate-200">
                            <td class="p-2">${res.n}</td>
                            <td class="p-2 text-center">${typeMap[res.t]}</td>
                            <td class="p-2 text-center">${res.q} ${res.u}</td>
                            <td class="p-2 text-right">$${res.c}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
                container.innerHTML += html;
            });
        }

        // --- SAVING PROJECT ---
        function saveProject() {
            const client = document.getElementById('clientName').value;
            if(!quoteItems.length) return alert("Quote is empty.");
            if(!client) return alert("Enter Client Name.");
            
            const cleanItems = quoteItems.map(item => ({
                desc: item.desc, 
                name: item.name,
                unit: item.unit,
                qty: item.qty,
                rate: item.rate,
                total: item.total,
                resources: item.resources
            }));

            let totalRev = 0; cleanItems.forEach(i => totalRev += i.total);

            const pData = {
                name: client + " - Project",
                client: client,
                address: document.getElementById('clientAddress').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                total: totalRev,
                items: cleanItems,
                schedule: cleanItems,
                status: "Pending",
                updatedAt: Date.now()
            };

            if(currentProjectId) {
                db.collection('projects').doc(currentProjectId).update(pData).then(()=>alert("Saved!"));
            } else {
                pData.createdAt = Date.now();
                db.collection('projects').add(pData).then(doc => {
                    localStorage.setItem('civilmate_current_project_id', doc.id);
                    currentProjectId = doc.id;
                    alert("Saved New Project!");
                });
            }
        }
        
        function loadProjectFromDB(id) {
            db.collection('projects').doc(id).get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('clientName').value = data.client||"";
                    document.getElementById('clientAddress').value = data.address||"";
                    document.getElementById('clientPhone').value = data.phone||"";
                    document.getElementById('clientEmail').value = data.email||"";
                    quoteItems = data.schedule || data.items || [];
                    projectStatus = data.status || "Pending";
                    renderQuote();
                    if(projectStatus === 'Active' || projectStatus === 'Completed') lockProjectUI();
                }
            });
        }
        
        function generateLegalContract() { 
            document.getElementById('contractDate').innerText = new Date().toLocaleDateString('en-NZ');
            document.getElementById('contractClientName').innerText = document.getElementById('clientName').value || "Client Name";
            document.getElementById('contractClientAddr').innerText = document.getElementById('clientAddress').value || "Address";
            document.getElementById('contractMyCompany').innerText = document.getElementById('myCompany').value;
            document.getElementById('contractMyAddr').innerText = document.getElementById('myAddress').value;
            document.getElementById('contractSiteAddr').innerText = document.getElementById('clientAddress').value; 
            const modal = document.getElementById('legalContractModal');
            modal.classList.remove('hidden');
            modal.classList.add('show-print');
        }

        function lockProjectUI() {
            document.getElementById('docTitle').innerText = "SCHEDULE OF RATES (CONTRACT)";
            document.getElementById('termsText').innerHTML = "<strong>Status: APPROVED CONTRACT</strong><br>Rates are fixed as per agreement.";
            const badge = document.getElementById('projectStatusBadge');
            badge.innerHTML = '<span class="bg-green-100 text-green-700 border border-green-200 px-3 py-1 rounded-full text-xs font-bold uppercase flex items-center gap-2"><i class="fas fa-check-circle"></i> Active Contract</span>';
            document.getElementById('builderPanel').classList.add('locked-area');
            document.getElementById('btnSave').classList.add('hidden');
            document.getElementById('btnLegal').classList.remove('hidden');
            const inputs = document.querySelectorAll('.company-input, #clientName, #clientAddress, #clientEmail, #clientPhone');
            inputs.forEach(inp => {
                inp.disabled = true;
                inp.classList.add('text-slate-600', 'bg-transparent');
                inp.classList.remove('border-dashed');
            });
        }
    </script>
</body>
</html>
