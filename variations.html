<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variations Manager - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }</style>
</head>
<body class="p-6 max-w-[1200px] mx-auto min-h-screen relative">

    <header class="mb-8 flex justify-between items-center">
        <div>
            <button onclick="window.location.href='project_hub.html'" class="text-sm text-slate-400 hover:text-slate-600 mb-2">
                <i class="fas fa-arrow-left"></i> Back to Hub
            </button>
            <h1 class="text-3xl font-bold text-slate-800">Variations Register (VOs)</h1>
            <p class="text-slate-500 text-sm">NZS 3910 - Section 9: Variations</p>
        </div>
        <div class="text-right">
            <p class="text-xs font-bold text-slate-400 uppercase">Revised Contract Sum</p>
            <h2 class="text-2xl font-bold text-purple-700" id="revisedTotal">$0.00</h2>
        </div>
    </header>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
        <table class="w-full text-left">
            <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200">
                <tr>
                    <th class="p-4">VO #</th>
                    <th class="p-4">Description of Change</th>
                    <th class="p-4 text-center">Status</th>
                    <th class="p-4 text-right">Value (Ex GST)</th>
                    <th class="p-4"></th>
                </tr>
            </thead>
            <tbody id="voTable" class="divide-y divide-slate-100 text-sm text-slate-700">
                <tr><td colspan="5" class="p-6 text-center text-slate-400 italic">Loading Variations...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="bg-purple-50 p-6 rounded-xl border border-purple-100 shadow-inner">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-purple-800 flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> Raise New Variation Price Request
            </h3>
            <button onclick="openEstimator()" class="text-xs bg-white text-purple-700 border border-purple-200 px-3 py-1.5 rounded hover:bg-purple-100 font-bold shadow-sm flex items-center gap-2">
                <i class="fas fa-database"></i> Open VO Cost Analyst
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end mb-4">
            <div class="md:col-span-2">
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Description</label>
                <input type="text" id="voDesc" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="e.g. Extra Drainage Line">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Unit</label>
                <input type="text" id="voUnit" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="m, m3">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Qty</label>
                <input type="number" id="voQty" oninput="calcTotal()" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="0">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Rate ($)</label>
                <input type="number" id="voRate" oninput="calcTotal()" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="0.00">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Total ($)</label>
                <input type="text" id="voTotalDisplay" class="w-full p-2 rounded border border-transparent bg-purple-100 font-bold text-purple-800 text-right" readonly value="$0.00">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-purple-200 pt-4 mb-4">
            <div class="bg-red-50 p-3 rounded border border-red-100">
                <p class="text-[9px] font-bold text-red-500 uppercase mb-2"><i class="fas fa-gavel"></i> LBP / Building Act Check</p>
                <div class="flex items-start gap-2">
                    <input type="checkbox" id="checkConsent" class="mt-1 w-4 h-4 text-purple-600 cursor-pointer">
                    <label for="checkConsent" class="text-[10px] text-slate-600 cursor-pointer">I confirm this implies NO change to the Consent OR The Owner has provided the Amendment.</label>
                </div>
            </div>
            <div class="bg-blue-50 p-3 rounded border border-blue-100">
                <p class="text-[9px] font-bold text-blue-500 uppercase mb-2"><i class="fas fa-hard-hat"></i> H&S / Safe Work Check</p>
                <div class="flex items-start gap-2">
                    <input type="checkbox" id="checkSafety" class="mt-1 w-4 h-4 text-purple-600 cursor-pointer">
                    <label for="checkSafety" class="text-[10px] text-slate-600 cursor-pointer">I have assessed risks and updated SSSP/Task Analysis.</label>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded border border-slate-200">
                <label class="block text-[9px] font-bold text-slate-500 uppercase mb-2"><i class="fas fa-clock"></i> Extension of Time (EOT)</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="voTime" class="w-full p-2 rounded border border-slate-300 text-xs font-bold text-slate-700" placeholder="0">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">Days</span>
                </div>
            </div>
        </div>
        
        <div class="text-right">
            <button onclick="createVO()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow-lg transition flex items-center gap-2 ml-auto">
                <i class="fas fa-file-signature"></i> Approve & Issue VO
            </button>
        </div>
    </div>

    <div id="estimatorModal" class="fixed inset-0 bg-slate-900/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold"><i class="fas fa-server mr-2"></i>VO Cost Analyst</h3>
                <button onclick="closeEstimator()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-4 bg-slate-100 border-b border-slate-200 shrink-0">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Import from Master Database</label>
                <select id="masterDbSelect" onchange="loadFromMaster()" class="w-full p-2 border border-slate-300 rounded text-sm font-bold text-slate-700 shadow-sm">
                    <option value="">-- Start from Scratch (New Analysis) --</option>
                </select>
            </div>

            <div class="p-6 overflow-y-auto">
                <div class="flex justify-between mb-4">
                    <div class="w-2/3">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Analysis Name</label>
                        <input type="text" id="analysisName" class="w-full border-b-2 border-slate-200 focus:border-purple-500 outline-none font-bold text-lg text-slate-800" placeholder="e.g. Concrete Slab 20MPa">
                    </div>
                    <div class="w-1/4">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Base Unit</label>
                        <input type="text" id="analysisUnit" class="w-full border-b-2 border-slate-200 focus:border-purple-500 outline-none text-center font-bold text-slate-600" placeholder="m3">
                    </div>
                </div>

                <table class="w-full text-sm mb-4">
                    <thead class="bg-slate-50 text-[10px] uppercase font-bold text-slate-500">
                        <tr>
                            <th class="p-2 text-left w-1/2">Resource Description</th>
                            <th class="p-2 text-center w-20">Unit</th>
                            <th class="p-2 text-center w-20">Yield</th>
                            <th class="p-2 text-right w-24">Rate</th>
                            <th class="p-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="estList"></tbody>
                </table>
                
                <button onclick="addEstItem()" class="text-xs text-blue-600 font-bold hover:underline mb-6">+ Add Resource (Labor/Plant/Mat)</button>

                <div class="bg-purple-50 p-4 rounded border border-purple-100 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>Base Cost (Net)</span>
                        <span id="estSub" class="font-mono">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm items-center">
                        <span class="text-slate-600">Margin / Profit (%)</span>
                        <input type="number" id="estMargin" value="15" onchange="calcEst()" class="w-16 text-right border rounded text-xs font-bold p-1 bg-white">
                    </div>
                    <div class="flex justify-between text-xl font-bold text-purple-700 pt-2 border-t border-purple-200">
                        <span>Final Unit Rate</span>
                        <span id="estTotal">$0.00</span>
                    </div>
                </div>

                <div class="mt-4 flex items-center gap-2 p-3 bg-green-50 rounded border border-green-100">
                    <input type="checkbox" id="saveToDbCheck" class="w-5 h-5 text-green-600 rounded cursor-pointer" checked>
                    <div>
                        <p class="text-xs font-bold text-green-800">Add to Master Database</p>
                        <p class="text-[10px] text-green-600">CivilMate will remember this analysis for future VOs.</p>
                    </div>
                </div>

                <button onclick="applyRate()" class="w-full mt-4 bg-slate-800 text-white py-3 rounded font-bold hover:bg-black shadow-lg transition">Apply Rate & Save</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pid = localStorage.getItem('civilmate_current_project_id');
        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }

        let currentSchedule = [];
        let projectTotal = 0;
        let masterItems = []; // AquÃ­ cargaremos la BD Maestra

        // ESTIMATOR DATA
        let estItems = [{ name: "General Labor", unit: "hr", yield: 1, cost: 45 }];

        init();

        function init() { 
            loadProject();
            loadMasterLibrary(); // Cargar la BD al iniciar
        }

        function loadProject() {
            db.collection('projects').doc(pid).onSnapshot(doc => {
                if(doc.exists) {
                    const p = doc.data();
                    currentSchedule = p.schedule || p.items || [];
                    projectTotal = p.total || 0;
                    document.getElementById('revisedTotal').innerText = fmtMoney(projectTotal);
                    renderTable(currentSchedule);
                }
            });
        }

        // --- DATABASE LOGIC ---
        function loadMasterLibrary() {
            const select = document.getElementById('masterDbSelect');
            // Cargar colecciÃ³n 'master_library'
            db.collection('master_library').get().then(snap => {
                masterItems = [];
                select.innerHTML = '<option value="">-- Start from Scratch (New Analysis) --</option>';
                
                snap.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id;
                    masterItems.push(item);
                    select.innerHTML += `<option value="${doc.id}">${item.name} (${item.unit}) - $${item.rate.toFixed(2)}</option>`;
                });

                // Si estÃ¡ vacÃ­a (primera vez), usar datos semilla locales
                if(snap.empty) {
                    seedLocalData();
                }
            });
        }

        function seedLocalData() {
            // Datos por defecto si no hay nada en Firebase
            const seeds = [
                { name: "Bulk Excavation (Simple)", unit: "m3", rate: 45.00, resources: [{name:"Excavator 20T", unit:"hr", yield:0.04, cost:140}, {name:"Operator", unit:"hr", yield:0.04, cost:45}] },
                { name: "Concrete Footing 25MPa", unit: "m3", rate: 350.00, resources: [{name:"Concrete 25MPa", unit:"m3", yield:1.05, cost:220}, {name:"Labor", unit:"hr", yield:2, cost:45}] }
            ];
            const select = document.getElementById('masterDbSelect');
            seeds.forEach((item, i) => {
                // Guardamos en memoria temporal con ID simulado
                item.id = "local_"+i;
                masterItems.push(item);
                select.innerHTML += `<option value="local_${i}">${item.name} (${item.unit}) - $${item.rate.toFixed(2)}</option>`;
            });
        }

        function loadFromMaster() {
            const id = document.getElementById('masterDbSelect').value;
            if(!id) {
                // Reset
                document.getElementById('analysisName').value = "";
                document.getElementById('analysisUnit').value = "";
                estItems = [{ name: "", unit: "hr", yield: 1, cost: 0 }];
                renderEst();
                return;
            }

            const item = masterItems.find(i => i.id === id);
            if(item) {
                document.getElementById('analysisName').value = item.name;
                document.getElementById('analysisUnit').value = item.unit;
                estItems = JSON.parse(JSON.stringify(item.resources || []));
                renderEst();
            }
        }

        // --- ESTIMATOR UI ---
        function openEstimator() { document.getElementById('estimatorModal').classList.remove('hidden'); renderEst(); }
        function closeEstimator() { document.getElementById('estimatorModal').classList.add('hidden'); }
        
        function addEstItem() { estItems.push({ name: "", unit: "hr", yield: 1, cost: 0 }); renderEst(); }
        
        function renderEst() {
            const list = document.getElementById('estList');
            list.innerHTML = "";
            estItems.forEach((item, i) => {
                list.innerHTML += `
                    <tr>
                        <td class="p-1"><input type="text" value="${item.name}" onchange="updEst(${i}, 'name', this.value)" class="w-full border rounded px-2 py-1 text-xs" placeholder="Resource Name"></td>
                        <td class="p-1"><input type="text" value="${item.unit}" onchange="updEst(${i}, 'unit', this.value)" class="w-full border rounded px-2 py-1 text-xs text-center"></td>
                        <td class="p-1"><input type="number" value="${item.yield}" onchange="updEst(${i}, 'yield', this.value)" class="w-full border rounded px-2 py-1 text-xs text-center text-blue-600 font-bold"></td>
                        <td class="p-1"><input type="number" value="${item.cost}" onchange="updEst(${i}, 'cost', this.value)" class="w-full border rounded px-2 py-1 text-xs text-right"></td>
                        <td class="p-1 text-center"><button onclick="delEst(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></td>
                    </tr>
                `;
            });
            calcEst();
        }

        function updEst(i, f, v) { estItems[i][f] = (f==='yield'||f==='cost') ? (parseFloat(v)||0) : v; calcEst(); }
        function delEst(i) { estItems.splice(i, 1); renderEst(); }

        function calcEst() {
            let sub = 0;
            estItems.forEach(i => sub += (i.yield * i.cost));
            const margin = parseFloat(document.getElementById('estMargin').value) || 0;
            const total = sub * (1 + (margin/100));
            document.getElementById('estSub').innerText = fmtMoney(sub);
            document.getElementById('estTotal').innerText = fmtMoney(total);
            return total;
        }

        function applyRate() {
            const finalRate = calcEst();
            const name = document.getElementById('analysisName').value;
            const unit = document.getElementById('analysisUnit').value;

            // 1. LLENAR FORMULARIO PRINCIPAL
            document.getElementById('voDesc').value = name; // Auto-fill descripciÃ³n
            document.getElementById('voUnit').value = unit;
            document.getElementById('voRate').value = finalRate.toFixed(2);
            calcTotal();

            // 2. APRENDIZAJE (GUARDAR EN MASTER DB)
            if(document.getElementById('saveToDbCheck').checked && name) {
                const newItem = {
                    name: name,
                    unit: unit,
                    rate: finalRate,
                    resources: estItems,
                    lastUsed: Date.now()
                };
                
                // Guardar en Firebase 'master_library'
                db.collection('master_library').add(newItem).then(() => {
                    console.log("Analysis learned into Master DB");
                    loadMasterLibrary(); // Recargar dropdown
                });
            }

            closeEstimator();
        }

        function renderTable(items) {
            const tbody = document.getElementById('voTable');
            tbody.innerHTML = "";
            const variations = items.filter(i => (i.desc || i.name || "").startsWith("VO#"));
            if(variations.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-slate-400 italic">No Variations raised yet.</td></tr>`; return; }

            variations.forEach((vo, index) => {
                const val = vo.qty * vo.rate;
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                        <td class="p-4 font-bold text-slate-700">VO #${index + 1}</td>
                        <td class="p-4 font-medium">${vo.desc || vo.name}
                            ${vo.timeImpact ? `<span class="block text-[10px] text-orange-500 font-bold">+ ${vo.timeImpact} Days EOT</span>` : ''}
                        </td>
                        <td class="p-4 text-center"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase border border-green-200">Approved</span></td>
                        <td class="p-4 text-right font-mono">${fmtMoney(val)}</td>
                        <td class="p-4 text-center text-xs text-slate-400">Integrated</td>
                    </tr>
                `;
            });
        }

        function calcTotal() {
            const q = parseFloat(document.getElementById('voQty').value) || 0;
            const r = parseFloat(document.getElementById('voRate').value) || 0;
            document.getElementById('voTotalDisplay').value = fmtMoney(q * r);
        }

        function createVO() {
            const desc = document.getElementById('voDesc').value;
            const unit = document.getElementById('voUnit').value;
            const qty = parseFloat(document.getElementById('voQty').value);
            const rate = parseFloat(document.getElementById('voRate').value);
            const hasConsentCheck = document.getElementById('checkConsent').checked;
            const hasSafetyCheck = document.getElementById('checkSafety').checked;
            const timeImpact = document.getElementById('voTime').value || "0";

            if(!desc || !qty || !rate) return alert("Please fill all financial fields.");
            if(!hasSafetyCheck) return alert("ðŸ›‘ STOP WORK AUTHORITY: Check H&S box.");
            if(!hasConsentCheck) return alert("âš ï¸ LBP LICENSE WARNING: Check Building Consent box.");

            const voCount = currentSchedule.filter(i => (i.desc || i.name || "").startsWith("VO#")).length + 1;
            const voTitle = `VO#${voCount}: ${desc}`;

            const newVO = {
                desc: voTitle,
                name: voTitle,
                unit: unit,
                qty: qty,
                rate: rate,
                total: qty * rate,
                timeImpact: timeImpact,
                approved: true
            };

            const newTotal = projectTotal + newVO.total;
            const newSchedule = [...currentSchedule, newVO];

            db.collection('projects').doc(pid).update({
                schedule: newSchedule,
                items: newSchedule,
                total: newTotal,
                updatedAt: Date.now()
            }).then(() => {
                alert("âœ… VO #" + voCount + " ISSUED SUCCESSFULLY.");
                document.getElementById('voDesc').value = "";
                document.getElementById('voQty').value = "";
                document.getElementById('voRate').value = "";
                document.getElementById('voTotalDisplay').value = "$0.00";
                document.getElementById('checkConsent').checked = false;
                document.getElementById('checkSafety').checked = false;
            }).catch(e => alert("Error: " + e.message));
        }

        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    </script>
</body>
</html>
