<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variations Manager - CivilMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        /* ESTILOS COPIADOS DE CONTRACTS PARA CONSISTENCIA */
        .col-desc { width: 45%; } .col-unit { width: 15%; text-align: center; } .col-qty { width: 15%; text-align: right; } .col-rate { width: 15%; text-align: right; } .col-total { width: 10%; text-align: right; }
        .res-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .res-table th { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; padding: 6px 4px; border-bottom: 2px solid #e2e8f0; }
        .res-table td { padding: 4px; border-bottom: 1px dashed #f1f5f9; vertical-align: middle; }
        .res-input { width: 100%; background: transparent; border: 1px solid transparent; border-radius: 4px; font-size: 11px; padding: 2px 4px; }
        .res-input:hover { background-color: #f1f5f9; border-color: #e2e8f0; }
        .res-input:focus { background-color: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="p-6 max-w-[1200px] mx-auto min-h-screen relative">

    <header class="mb-8 flex justify-between items-center">
        <div>
            <button onclick="window.location.href='project_hub.html'" class="text-sm text-slate-400 hover:text-slate-600 mb-2">
                <i class="fas fa-arrow-left"></i> Back to Hub
            </button>
            <h1 class="text-3xl font-bold text-slate-800">Variations Register (VOs)</h1>
            <p class="text-slate-500 text-sm">NZS 3910 - Section 9: Variations</p>
        </div>
        <div class="text-right">
            <p class="text-xs font-bold text-slate-400 uppercase">Revised Contract Sum</p>
            <h2 class="text-2xl font-bold text-purple-700" id="revisedTotal">$0.00</h2>
        </div>
    </header>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
        <table class="w-full text-left">
            <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200">
                <tr>
                    <th class="p-4">VO #</th>
                    <th class="p-4">Description of Change</th>
                    <th class="p-4 text-center">Status</th>
                    <th class="p-4 text-right">Value (Ex GST)</th>
                    <th class="p-4"></th>
                </tr>
            </thead>
            <tbody id="voTable" class="divide-y divide-slate-100 text-sm text-slate-700">
                <tr><td colspan="5" class="p-6 text-center text-slate-400 italic">Loading Variations...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="bg-purple-50 p-6 rounded-xl border border-purple-100 shadow-inner">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-purple-800 flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> Raise New Variation Price Request
            </h3>
            <button onclick="openEstimator()" class="text-xs bg-white text-purple-700 border border-purple-200 px-3 py-1.5 rounded hover:bg-purple-100 font-bold shadow-sm flex items-center gap-2">
                <i class="fas fa-database"></i> Open VO Cost Analyst
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end mb-4">
            <div class="md:col-span-2">
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Description</label>
                <input type="text" id="voDesc" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="e.g. Extra Drainage Line">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Unit</label>
                <input type="text" id="voUnit" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="m, m3">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Qty</label>
                <input type="number" id="voQty" oninput="calcTotal()" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="0">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-purple-400 uppercase mb-1">Rate ($)</label>
                <input type="number" id="voRate" oninput="calcTotal()" class="w-full p-2 rounded border border-purple-200 focus:outline-none focus:border-purple-500" placeholder="0.00">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Total ($)</label>
                <input type="text" id="voTotalDisplay" class="w-full p-2 rounded border border-transparent bg-purple-100 font-bold text-purple-800 text-right" readonly value="$0.00">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-purple-200 pt-4 mb-4">
            <div class="bg-red-50 p-3 rounded border border-red-100">
                <p class="text-[9px] font-bold text-red-500 uppercase mb-2"><i class="fas fa-gavel"></i> LBP / Building Act Check</p>
                <div class="flex items-start gap-2">
                    <input type="checkbox" id="checkConsent" class="mt-1 w-4 h-4 text-purple-600 cursor-pointer">
                    <label for="checkConsent" class="text-[10px] text-slate-600 cursor-pointer">I confirm this implies NO change to the Consent OR The Owner has provided the Amendment.</label>
                </div>
            </div>
            <div class="bg-blue-50 p-3 rounded border border-blue-100">
                <p class="text-[9px] font-bold text-blue-500 uppercase mb-2"><i class="fas fa-hard-hat"></i> H&S / Safe Work Check</p>
                <div class="flex items-start gap-2">
                    <input type="checkbox" id="checkSafety" class="mt-1 w-4 h-4 text-purple-600 cursor-pointer">
                    <label for="checkSafety" class="text-[10px] text-slate-600 cursor-pointer">I have assessed risks and updated SSSP/Task Analysis.</label>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded border border-slate-200">
                <label class="block text-[9px] font-bold text-slate-500 uppercase mb-2"><i class="fas fa-clock"></i> Extension of Time (EOT)</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="voTime" class="w-full p-2 rounded border border-slate-300 text-xs font-bold text-slate-700" placeholder="0">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">Days</span>
                </div>
            </div>
        </div>
        
        <div class="text-right">
            <button onclick="createVO()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow-lg transition flex items-center gap-2 ml-auto">
                <i class="fas fa-file-signature"></i> Approve & Issue VO
            </button>
        </div>
    </div>

    <div id="estimatorModal" class="fixed inset-0 bg-slate-900/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold"><i class="fas fa-server mr-2"></i>VO Cost Analyst (Standard APU)</h3>
                <button onclick="closeEstimator()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-4 bg-slate-100 border-b border-slate-200 shrink-0">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Import from Master Database</label>
                <select id="masterDbSelect" onchange="loadFromMaster()" class="w-full p-2 border border-slate-300 rounded text-sm font-bold text-slate-700 shadow-sm">
                    <option value="">-- Start from Scratch (New Analysis) --</option>
                </select>
            </div>

            <div class="p-6 overflow-y-auto bg-slate-50">
                <div class="flex justify-between mb-6">
                    <div class="w-2/3">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Analysis Name</label>
                        <input type="text" id="analysisName" class="w-full border-b-2 border-slate-200 bg-transparent focus:border-purple-500 outline-none font-bold text-lg text-slate-800" placeholder="e.g. Concrete Slab 20MPa">
                    </div>
                    <div class="w-1/4">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Base Unit</label>
                        <input type="text" id="analysisUnit" class="w-full border-b-2 border-slate-200 bg-transparent focus:border-purple-500 outline-none text-center font-bold text-slate-600" placeholder="m3">
                    </div>
                </div>

                <div id="resourcesContainer" class="space-y-4 mb-6">
                    </div>

                <div class="bg-white p-4 rounded border border-slate-200 space-y-2 shadow-sm">
                    <div class="flex justify-between text-xs text-slate-500">
                        <span>Base Cost (Net)</span>
                        <span id="estSub" class="font-mono">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm items-center">
                        <span class="text-slate-600 font-bold">Margin / Profit (%)</span>
                        <input type="number" id="estMargin" value="15" onchange="updateCalculations()" class="w-16 text-right border rounded text-xs font-bold p-1 bg-white focus:ring-2 ring-purple-500 outline-none">
                    </div>
                    <div class="flex justify-between text-2xl font-bold text-purple-700 pt-2 border-t border-slate-100">
                        <span>Final Unit Rate</span>
                        <span id="estTotal">$0.00</span>
                    </div>
                </div>

                <div class="mt-4 flex items-center gap-2 p-3 bg-green-50 rounded border border-green-100">
                    <input type="checkbox" id="saveToDbCheck" class="w-5 h-5 text-green-600 rounded cursor-pointer" checked>
                    <div>
                        <p class="text-xs font-bold text-green-800">Add to Master Database</p>
                        <p class="text-[10px] text-green-600">CivilMate will save this standard APU for future Contracts & VOs.</p>
                    </div>
                </div>

                <button onclick="applyRate()" class="w-full mt-4 bg-slate-800 text-white py-3 rounded font-bold hover:bg-black shadow-lg transition">Apply Rate & Save</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBcgFroLuH-8AQ_0uXmCffnYpEkJZEeBYk", authDomain: "civilmate-933db.firebaseapp.com", projectId: "civilmate-933db", storageBucket: "civilmate-933db.firebasestorage.app", messagingSenderId: "679829297548", appId: "1:679829297548:web:42f9a5217314b787ed9ea9" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pid = localStorage.getItem('civilmate_current_project_id');
        if(!pid) { alert("No project selected"); window.location.href='dashboard.html'; }

        let currentSchedule = [];
        let projectTotal = 0;
        let masterItems = []; 
        
        // --- APU ENGINE VARIABLES (Standardized) ---
        let currentResources = [
            {n:"General Labor", u:"hr", q:1, c:45, t:"Lab"} // Default Item
        ];

        init();

        function init() { 
            loadProject();
            loadMasterLibrary();
            renderAllLists(); // Iniciar tablas vac√≠as o por defecto
        }

        function loadProject() {
            db.collection('projects').doc(pid).onSnapshot(doc => {
                if(doc.exists) {
                    const p = doc.data();
                    currentSchedule = p.schedule || p.items || [];
                    projectTotal = p.total || 0;
                    document.getElementById('revisedTotal').innerText = fmtMoney(projectTotal);
                    renderTable(currentSchedule);
                }
            });
        }

        // --- DATABASE LOGIC (STANDARD FORMAT) ---
        function loadMasterLibrary() {
            const select = document.getElementById('masterDbSelect');
            db.collection('master_library').get().then(snap => {
                masterItems = [];
                select.innerHTML = '<option value="">-- Start from Scratch (New Analysis) --</option>';
                snap.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id;
                    masterItems.push(item);
                    select.innerHTML += `<option value="${doc.id}">${item.name} (${item.unit}) - $${(item.rate || 0).toFixed(2)}</option>`;
                });
            });
        }

        function loadFromMaster() {
            const id = document.getElementById('masterDbSelect').value;
            if(!id) {
                // Reset to default
                document.getElementById('analysisName').value = "";
                document.getElementById('analysisUnit').value = "";
                currentResources = [{n:"General Labor", u:"hr", q:1, c:45, t:"Lab"}];
                renderAllLists();
                updateCalculations();
                return;
            }

            const item = masterItems.find(i => i.id === id);
            if(item) {
                document.getElementById('analysisName').value = item.name;
                document.getElementById('analysisUnit').value = item.unit;
                // Importante: Deep copy para no alterar la referencia
                currentResources = JSON.parse(JSON.stringify(item.resources || []));
                renderAllLists();
                updateCalculations();
            }
        }

        // --- APU ENGINE (THE CONTRACTS LOGIC) ---
        function renderAllLists() {
            renderList('Lab', 'Labor Cost', 'bg-orange-50', 'text-orange-800', 'border-orange-200', 'text-orange-600');
            renderList('Plant', 'Plant Cost', 'bg-green-50', 'text-green-800', 'border-green-200', 'text-green-600');
            renderList('Mat', 'Material Cost', 'bg-blue-50', 'text-blue-800', 'border-blue-200', 'text-blue-600');
        }

        function renderList(type, title, bgClass, textClass, borderClass, btnClass) {
            // Verificar si el contenedor ya existe, si no, crearlo din√°micamente
            // Esto es un truco para reutilizar el contenedor 'resourcesContainer'
            let sectionId = `section-${type}`;
            let container = document.getElementById('resourcesContainer');
            
            // Buscar si ya pintamos esta secci√≥n, si no, la agregamos
            let sectionHTML = `
                <div id="${sectionId}" class="border ${borderClass} rounded-lg overflow-hidden shadow-sm">
                    <div class="${bgClass} px-3 py-2 flex justify-between items-center border-b ${borderClass.replace('200','100')}">
                        <span class="text-[10px] font-bold ${textClass} uppercase tracking-wider">${title}</span>
                        <button onclick="addRes('${type}')" class="${btnClass} hover:brightness-75 text-xs font-bold bg-white px-2 py-0.5 rounded border ${borderClass} shadow-sm transition">+ Add</button>
                    </div>
                    <div class="bg-white">
                        <table class="res-table">
                            <thead><tr><th class="col-desc pl-3 text-left">Description</th><th class="col-unit text-center">Unit</th><th class="col-qty text-right">Yield</th><th class="col-rate text-right">Cost</th><th class="col-total text-right">Total</th><th class="w-[5%]"></th></tr></thead>
                            <tbody id="list${type}"></tbody>
                        </table>
                    </div>
                </div>`;

            // Si es la primera vez (renderAllLists), limpiamos el container al inicio del loop
            if (type === 'Lab') container.innerHTML = ""; 
            
            container.innerHTML += sectionHTML;

            // Llenar filas
            const tbody = document.getElementById(`list${type}`);
            currentResources.forEach((res, idx) => {
                if(res.t !== type) return;
                const total = (res.c * res.q).toFixed(2);
                tbody.innerHTML += `
                    <tr class="group hover:bg-slate-50 transition border-b border-dashed border-slate-100 last:border-0">
                        <td><input type="text" value="${res.n}" onchange="updRes(${idx},'n',this.value)" class="res-input font-medium text-slate-700"></td>
                        <td><input type="text" value="${res.u}" onchange="updRes(${idx},'u',this.value)" class="res-input text-center text-slate-500"></td>
                        <td><input type="number" value="${res.q}" onchange="updRes(${idx},'q',this.value)" class="res-input text-right font-bold text-blue-600"></td>
                        <td><input type="number" value="${res.c}" onchange="updRes(${idx},'c',this.value)" class="res-input text-right text-slate-600"></td>
                        <td class="text-right text-[10px] font-mono font-bold text-slate-800 px-2">$${total}</td>
                        <td class="text-center"><button onclick="delRes(${idx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></td>
                    </tr>
                `;
            });
        }

        window.addRes = (t) => { currentResources.push({n:"New Item", u:"hr", q:1, c:0, t:t}); renderAllLists(); updateCalculations(); };
        window.delRes = (i) => { currentResources.splice(i,1); renderAllLists(); updateCalculations(); };
        window.updRes = (i, f, v) => { currentResources[i][f] = (f==='q'||f==='c') ? (parseFloat(v)||0) : v; renderAllLists(); updateCalculations(); };

        function updateCalculations() {
            let cost = 0;
            currentResources.forEach(r => cost += (r.c * r.q));
            const margin = parseFloat(document.getElementById('estMargin').value) || 0;
            const price = cost * (1 + (margin/100));
            document.getElementById('estSub').innerText = fmtMoney(cost);
            document.getElementById('estTotal').innerText = fmtMoney(price);
            return price;
        }

        // --- APPLY TO VO & SAVE TO MASTER DB ---
        function applyRate() {
            const finalRate = updateCalculations();
            const name = document.getElementById('analysisName').value;
            const unit = document.getElementById('analysisUnit').value;

            if(!name) return alert("Please name this analysis (e.g. Concrete Slab).");

            // 1. LLENAR FORMULARIO PRINCIPAL
            document.getElementById('voDesc').value = name;
            document.getElementById('voUnit').value = unit;
            document.getElementById('voRate').value = finalRate.toFixed(2);
            calcTotal();

            // 2. APRENDIZAJE (GUARDAR EN FORMATO EST√ÅNDAR)
            if(document.getElementById('saveToDbCheck').checked) {
                const newItem = {
                    name: name,
                    unit: unit,
                    rate: finalRate,
                    resources: currentResources, // ESTA ES LA CLAVE: Guardamos el array estructurado
                    lastUsed: Date.now()
                };
                
                db.collection('master_library').add(newItem).then(() => {
                    alert("Analysis saved to Master Database (Standard Format) ‚úÖ");
                    loadMasterLibrary(); // Recargar dropdown
                });
            }

            closeEstimator();
        }

        // --- UI HELPERS ---
        function openEstimator() { document.getElementById('estimatorModal').classList.remove('hidden'); renderAllLists(); updateCalculations(); }
        function closeEstimator() { document.getElementById('estimatorModal').classList.add('hidden'); }
        
        function renderTable(items) {
            const tbody = document.getElementById('voTable');
            tbody.innerHTML = "";
            const variations = items.filter(i => (i.desc || i.name || "").startsWith("VO#"));
            if(variations.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-slate-400 italic">No Variations raised yet.</td></tr>`; return; }

            variations.forEach((vo, index) => {
                const val = vo.qty * vo.rate;
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                        <td class="p-4 font-bold text-slate-700">VO #${index + 1}</td>
                        <td class="p-4 font-medium">${vo.desc || vo.name}
                            ${vo.timeImpact ? `<span class="block text-[10px] text-orange-500 font-bold">+ ${vo.timeImpact} Days EOT</span>` : ''}
                        </td>
                        <td class="p-4 text-center"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase border border-green-200">Approved</span></td>
                        <td class="p-4 text-right font-mono">${fmtMoney(val)}</td>
                        <td class="p-4 text-center text-xs text-slate-400">Integrated</td>
                    </tr>
                `;
            });
        }

        function calcTotal() {
            const q = parseFloat(document.getElementById('voQty').value) || 0;
            const r = parseFloat(document.getElementById('voRate').value) || 0;
            document.getElementById('voTotalDisplay').value = fmtMoney(q * r);
        }

        function createVO() {
            const desc = document.getElementById('voDesc').value;
            const unit = document.getElementById('voUnit').value;
            const qty = parseFloat(document.getElementById('voQty').value);
            const rate = parseFloat(document.getElementById('voRate').value);
            const hasConsentCheck = document.getElementById('checkConsent').checked;
            const hasSafetyCheck = document.getElementById('checkSafety').checked;
            const timeImpact = document.getElementById('voTime').value || "0";

            if(!desc || !qty || !rate) return alert("Please fill all financial fields.");
            if(!hasSafetyCheck) return alert("üõë STOP WORK AUTHORITY: Check H&S box.");
            if(!hasConsentCheck) return alert("‚ö†Ô∏è LBP LICENSE WARNING: Check Building Consent box.");

            const voCount = currentSchedule.filter(i => (i.desc || i.name || "").startsWith("VO#")).length + 1;
            const voTitle = `VO#${voCount}: ${desc}`;

            const newVO = {
                desc: voTitle,
                name: voTitle,
                unit: unit,
                qty: qty,
                rate: rate,
                total: qty * rate,
                timeImpact: timeImpact,
                approved: true
            };

            const newTotal = projectTotal + newVO.total;
            const newSchedule = [...currentSchedule, newVO];

            db.collection('projects').doc(pid).update({
                schedule: newSchedule,
                items: newSchedule,
                total: newTotal,
                updatedAt: Date.now()
            }).then(() => {
                alert("‚úÖ VO #" + voCount + " ISSUED SUCCESSFULLY.");
                document.getElementById('voDesc').value = "";
                document.getElementById('voQty').value = "";
                document.getElementById('voRate').value = "";
                document.getElementById('voTotalDisplay').value = "$0.00";
                document.getElementById('checkConsent').checked = false;
                document.getElementById('checkSafety').checked = false;
            }).catch(e => alert("Error: " + e.message));
        }

        function fmtMoney(n) { return "$" + n.toLocaleString('en-NZ', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    </script>
</body>
</html>
